<template>
  <menu-popup ref="popupFileTreeRef" direction="bottom" height="85vh">
    <view class="file-tree">
      <!-- 加载中, 刷新时，不显示加载图标 -->
      <template v-if="isLoading && !files?.length">
        <view class="file-tree-loading">
          <image 
            class="icon-loading-image" 
            src="@/static/assets/icon_loading.svg"
            mode="widthFix" />
        </view>
      </template>
      <!-- 有文件时，显示文件树 -->
      <template v-else-if="!!files?.length">
        <file-tree-node
          v-for="node in files"
          :key="node.id"
          :node="node"
          :level="0"
          :expanded-folders="expandedFolders"
          :selected-file-id="selectedFileId"
          @toggle-folder="handleToggleFolder"
          @select-file="handleSelectFile"
        />
      </template>
      <!-- 没有文件时，显示空状态 -->
      <template v-else>
        <view class="file-tree-empty">
          <text>暂无文件</text>
        </view>
      </template>
    </view>
  </menu-popup>
</template>

<script setup lang="uts">
  import MenuPopup from '@/components/menu-popup/menu-popup.uvue'
  import type { FileNode } from '@/types/interfaces/agent'
  import FileTreeNode from './file-tree-node.uvue'

  // 文件树弹窗引用
  const popupFileTreeRef = ref<any>(null)
  // 已展开的文件夹ID集合
  const expandedFolders = ref<Set<string>>(new Set())
  // 选中的文件ID
  const selectedFileId = ref<string>('')

  const props = withDefaults(defineProps<{
      files: FileNode[],
      isLoading: boolean,
    }>(), {
      files: [],
      isLoading: false,
    }
  )

  /**
   * 切换文件夹展开/收起
   */
  const handleToggleFolder = (folderId: string) => {
    const newExpanded = new Set(expandedFolders.value)
    if (newExpanded.has(folderId)) {
      newExpanded.delete(folderId)
    } else {
      newExpanded.add(folderId)
    }
    expandedFolders.value = newExpanded
  }

  /**
   * 选择文件
   */
  const handleSelectFile = (fileId: string) => {
    selectedFileId.value = fileId
  }

  // 打开文件树弹窗
  const open = () => {
    popupFileTreeRef.value?.open()
  }

  // 关闭文件树弹窗
  const close = () => {
    popupFileTreeRef.value?.close()
  }

  // 暴露文件树弹窗引用
  defineExpose({
    open,
    close,
  })
</script>

<style scoped lang="scss">
  .file-tree {
    height: 100%;
    // padding: 16rpx 0;
    // max-height: calc(85vh - 100rpx);
    overflow-y: auto;

    .file-tree-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;

      .icon-loading-image {
        width: 48rpx;
        height: 48rpx;
        margin-right: 10rpx;
        -webkit-touch-callout: none !important;
        -webkit-user-select: none !important;
        user-select: none !important;
      }
    }

    .file-tree-empty {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      font-size: 28rpx;
      color: #999;
    }
  }
</style>