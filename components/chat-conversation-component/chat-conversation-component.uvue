<template>
	<view ref="msgListContentRef" class="agent-detail-container page-container">
		<!-- 导航栏 -->
		 <!-- 临时会话不显示Logo, 显示标题`和xxx开始会话` -->
		<custom-nav-bar :title="headerTitle" show-back :icon="isTempChat ? '' : agentInfo?.icon">

			<template v-slot:left>
			<!-- #ifdef MP-WEIXIN -->
			<menu-dropdown :list="customMenuList"  />
			<!-- #endif -->
			</template>

			<template v-slot:right>
				<!-- #ifdef H5 || WEB -->
				<view class="right-buttons">
					<view class="icon-box" hover-class="icon-box-hover" @tap="handleMorePopup" v-if="!isTempChat">
						<text class="iconfont icon-More"></text>
					</view>
					<template v-if="!(agentInfo?.expandPageArea === ExpandPageAreaEnum.Yes && agentInfo?.hideChatArea === HideChatAreaEnum.Yes)">
						<!-- 创建新会话 -->
						<view class="icon-box" hover-class="icon-box-hover" @tap="handleCreateNewConversation">
							<text class="iconfont icon-message-add"></text>
						</view>
					</template>
				</view>
				<!-- #endif -->
			</template>

		</custom-nav-bar>

		<!-- 默认展开扩展页面区域，且隐藏聊天区域 -->
		<template v-if="agentInfo?.expandPageArea === ExpandPageAreaEnum.Yes && agentInfo?.hideChatArea === HideChatAreaEnum.Yes">
			<web-view class="w-full" v-if="pageHomeUrl?.length" :src="pageHomeUrl + (ticket ? '?_ticket=' + ticket : '')" id="webview"></web-view>
		</template>
		<template v-else>
			<view class="chat-container">
				<!-- 聊天内容 -->
				<view class="scroll-view-box">
					<scroll-view 
						direction="vertical"
						class="msg-list"
						:scroll-into-view="scrollIntoView"
						id="msg-list"
						:scroll-with-animation="scrollWithAnimation"
						@scroll="onScroll"
						@touchstart="scrollTouch = true"
						@touchend="scrollTouch = false"
					>
						<new-conversation-set 
							ref="newConversationSetRef" 
							:variables="variables" 
							:user-fill-variables="userFillVariables" 
							:disabled="isSendMessageRef"
							@toggleWholeDisabled="handleToggleWholeDisabled"
						/>
						<view class="msg-list-content" v-if="messageList?.length">
							<template v-for="(item, index) in messageList" :key="item.id">
								<!-- 智能体会话消息 -->
								<uni-ai-x-msg
									v-if="item.messageType === MessageTypeEnum.ASSISTANT" 
									:msg="handleMessageContent(item)"
									:is-last-msg="messageList?.length - 1 === index"
									:is-conversation-active="isConversationActive"
									@longpress="onlongTapMsg(convertMessageInfoToMsgItem(item))" 
									@changeThinkContent="changeThinkContent"
									:id="`msg-item-${item.id}`"
									:ref="(el) => setMessageRef(el, item.id)"
								></uni-ai-x-msg>
								<!-- 用户消息 -->
								<template v-else>
									<!-- 图片以及文件 -->
									<scroll-view 
										class="files-container" 
										v-if="item?.attachments?.length"
										direction="horizontal"
										:scroll-with-animation="true"
										:show-scrollbar="false">
										<view 
											class="files-box"
											:class="!file?.mimeType?.includes('image/') ? 'files-box-file' : 'files-box-image'"
											v-for="file in item.attachments"
											:key="file.fileKey"
											@click="onPreview(file, item?.attachments)"
										>
											<image
												class="image"
												v-if="file?.mimeType?.includes('image/')"
												:src="file?.fileUrl"
												mode="aspectFill"
											/>
											<!-- 文件 -->
											<template v-else>
												<image class="doc-image" :src="docImage" mode="aspectFill" />
												<view class="doc-info-container">
													<view class="doc-name text-ellipsis">{{ file?.fileName }}</view>
													<text class="doc-size text-ellipsis">{{ formatBytes(file?.fileSize) }}</text>
												</view>
											</template>
										</view>
									</scroll-view>
									<text class="user-msg" v-if="item?.text" @longpress="onlongTapUserMsg(item)">{{item.text}}</text>
								</template>
							</template>
						</view>
						
						<!-- 空状态内容 -->
						<view class="content" v-else>
							<view class="title-section">
								<markdown-msg :text="agentInfo?.openingChatMsg" />
							</view>
							<button-wrapper :chat-suggest-list="chatSuggestList" @button-click="handleButtonClick" />
						</view>
						
						<!-- 滚动到底部的锚点 -->
						<view style="height: 35px;" id="last-msg"></view>
					</scroll-view>
					
					<!-- 滚动到底部按钮 -->
					<view :style="{visibility: scrollInBottom || scrolling ? 'hidden' : 'visible'}" class="scroll-to-bottom" @click="scrollToLastMsg(true)">
						<text class="iconfont icon-a-Chevrondown"></text>
					</view>
				</view>
				
				<!-- 输入框 -->
				<chat-input-phone
					:page-home-index="agentInfo?.pageHomeIndex || ''"
					:expand-page-area="agentInfo?.expandPageArea || ExpandPageAreaEnum.No"
					key="agent-details-chat-input"
					ref="agentDetailInputPhoneRef"
					:whole-disabled="wholeDisabled"
					:manual-components="agentInfo?.manualComponents || []"
					:default-selected-components="selectedComponents"
					:is-conversation-active="isConversationActive"
					:is-stopping-conversation="isStoppingConversation"
					@onSendMessage="handleSendMessage"
					@onStopConversation="handleStopConversation"
					@onOpenPagePreview="(uri:string)=>handleOpenPagePreview({uri})"
				/>
			</view>
		</template>

		<more-popup v-if="!isTempChat" ref="refMorePopup" :agent-info="agentInfo" @collect="handleCollect" />
		<template v-else>
			<!-- #ifdef H5 || WEB-->
			<button
				:id="buttonId"
				type="button"
				class="captcha-button"
			/>
			<aliyun-captcha
				:config="tenantConfigInfo"
				:element-id="buttonId"
				@doAction="handleCreateTempChat"
				@onReady="handleCaptchaReady"
			/>
			<!-- #endif -->
		</template>

		<page-preview-iframe ref="pagePreviewIframeRef" @update-visible="updateVisible"/>
	</view>
</template>

<script setup lang="uts">
	// ==================== 导入模块 ====================
	// 分层架构
	import AgentDetailData from './layers/AgentDetailData.uts'
	import AgentDetailService from './layers/AgentDetailService.uts'
	import ComponentManager from './layers/ComponentManager.uts'
	import ScrollManager from './layers/ScrollManager.uts'
	
	// 类型定义
	import { MessageTypeEnum, HideChatAreaEnum, ExpandPageAreaEnum } from '@/types/enums/agent'
	import { apiAgentConversation } from '@/servers/conversation'
	import { SUCCESS_CODE } from '@/constants/codes.constants'
	import type { ChatInputPhoneRef } from '@/types/interfaces/chat.uts'
	import type { MessageInfo } from '@/types/interfaces/conversationInfo.uts'
	import type { UploadFileStatus } from '@/types/enums/common.uts'
	import type { TenantConfigInfo } from '@/types/interfaces/login'
	
	// 组件
	import MorePopup from './components/more-popup/more-popup.uvue'
	import ChatInputPhone from '@/components/chat-input-phone/chat-input-phone.uvue'
	import NewConversationSet from './components/new-conversation-set/new-conversation-set.uvue'
	// import AliyunCaptcha from './components/aliyun-captcha/aliyun-captcha.uvue'

	// 常量
	import { CONVERSATION_PAYLOAD, TEMP_CONVERSATION_UID, TEMP_CHAT_KEY } from '@/constants/common.constants'
	import { AttachmentFile } from '@/types/interfaces/conversationInfo.uts';
	import docImage from '@/static/assets/doc_image.png';
	import { formatBytes } from '@/utils/byteConverter.uts';
	import { TENANT_CONFIG_INFO } from '@/constants/home.constants';
	import { objectToQueryString } from '@/utils/common';

	import { apiTenantConfig } from '@/servers/account'
	import { EventBindConfig } from '@/types/interfaces/agent'
	import { useMessageEventDelegate, handleMessageEventClick, EventDedupManager } from '@/hooks/useMessageEventDelegate.uts'
	import { ProcessingEnum } from '@/types/enums/common.uts';
	import { API_BASE_URL } from '@/constants/config';
	import { chatService } from '@/utils/chatService'
	import type { ShowPagePreviewOptions } from '@/types/interfaces/agent'
	import { handleExternalLink } from '@/utils/system.uts'
	import { onAddToFavorites } from '@dcloudio/uni-app'
	import { apiUserTicketCreate } from '@/servers/agentDev'

	// 接收组件属性，设置默认值
	const props = withDefaults(defineProps<{
		isTempChat?: boolean,
	}>(), {
		isTempChat: false,
	})

	// 创建防重复触发管理器（可选）
	const dedupManager = new EventDedupManager(1000)

	// 定义 chat-input-phone 组件的引用
	const agentDetailInputPhoneRef = ref<ChatInputPhoneRef | null>(null)
	const newConversationSetRef = ref<any>(null)
	// 聊天内容区域引用用于绑定自定义事件代理
	const msgListContentRef = ref<HTMLElement | null>(null)
	// 事件绑定配置
	const eventBindConfig = ref<EventBindConfig | null>(null)
	// 阿里云验证码按钮id
	const buttonId = ref<string>('aliyun-captcha-id')
	// 租户配置信息
	const tenantConfigInfo = ref<TenantConfigInfo>(null)
	// 页面预览iframe引用
	const pagePreviewIframeRef = ref<any>(null)
	// 页面预览是否可见
	const pagePreviewVisible = ref(false)
	const msgListRef = ref<HTMLElement | null>(null)
	// 用户临时票据
	const ticket = ref<string>('')
	const customMenuList = computed<MenuListItem[]>(() => {
		const collectIcon = agentInfo.value?.collect ? 'icon-Star-fill' : 'icon-Star'
		return [
			{ label: '新建会话', value: 'add', icon: 'icon-message-add',onClick:handleCreateNewConversation},
			{ label: '更多信息', value: 'info', icon: 'icon-Info',onClick:handleOpenInfo },
			{ label: '收藏', value: 'collect', icon: collectIcon,onClick:handleCollect },
			// { label: '关闭', value: 'close', icon: 'icon-Exit' }
		]
	})

	const updateVisible = (value: boolean) => {
		pagePreviewVisible.value = value
	}
	// ==================== 初始化分层架构 ====================
	// 创建各层实例
	const data = new AgentDetailData()
	const service = new AgentDetailService(data)
	const componentManager = new ComponentManager(data)
	const scrollManager = new ScrollManager(data)

	// ==================== 暴露方法给模板 ====================
	
	// 数据层
	const {
		agentId, agentName, agentInfo, pageHomeUrl, conversationId,
		messageList, chatSuggestList, requestId, messageIdRef, captchaVerifyParam, chatKey, conversationUid,
		conversationInfo, needUpdateTopicRef, manualComponents, selectedComponents, variables,
		userFillVariables, processingList,
		scrollIntoView, scrollInBottom, scrollWithAnimation,
		scrollTouch, scrolling, keyboardHeight, refMorePopup, isStoppingConversation, 
		isConversationActive, isSendMessageRef, wholeDisabled
	} = data

	// 处理禁用发送按钮
	const handleToggleWholeDisabled = (disabled: boolean) => {
		data.wholeDisabled.value = disabled
	}

	// 服务层 - 使用箭头函数保持this上下文
	const handleQueryConversation = (...args: any[]) => service.handleQueryConversation(...args)
	const handleChangeMessageList = (...args: any[]) => service.handleChangeMessageList(...args)

	// 停止会话
	const handleStopConversation = () => service.handleStopConversation(props.isTempChat)
	const createNewConversation = (...args: any[]) => service.createNewConversation(...args)
	const getPublishedAgentInfo = (...args: any[]) => service.getPublishedAgentInfo(...args)
	const handleCollect = (...args: any[]) => service.handleCollect(...args)
	// 清空会话数据
	const clearConversationData = (isTempChat: boolean) => service.clearConversationData(isTempChat)

	// 临时会话
	const queryTempConversation = (conversationUid: string) => service.queryTempConversation(conversationUid)
	const createTempChatConversation = (captchaVerifyParam: string) => service.createTempChatConversation(captchaVerifyParam)

	// 组件管理层 - 使用箭头函数保持this上下文
	const setMessageRef = (...args: any[]) => componentManager.setMessageRef(...args)
	const removeMessageRef = (...args: any[]) => componentManager.removeMessageRef(...args)
	const updateMessageComponent = (...args: any[]) => componentManager.updateMessageComponent(...args)
	const convertMessageInfoToMsgItem = (...args: any[]) => componentManager.convertMessageInfoToMsgItem(...args)
	// 处理消息内容
	const handleMessageContent = ( item:any) => {
		// 处理消息内容中的data属性
		item.text = item.text.replace(/data="(\{.*?\})"/g, (_, json) => {
        	return `data='${json}'`;
		});
		return convertMessageInfoToMsgItem(item)
	}

	// 滚动管理层 - 使用箭头函数保持this上下文
	const scrollToLastMsg = (...args: any[]) => scrollManager.scrollToLastMsg(...args)
	const setIsInScrollBottom = (...args: any[]) => scrollManager.setIsInScrollBottom(...args)
	const lockAutoToLastMsg = (...args: any[]) => scrollManager.lockAutoToLastMsg(...args)
	const onScroll = (...args: any[]) => scrollManager.onScroll(...args)

	// ==================== 视图层方法 (原ViewManager逻辑) ====================

	const handleCaptchaReady = () => {
		document.getElementById(buttonId.value)?.click();
	};

	// 发送消息
	const handleSendMessage = (_data: any[]) => {
		const params = {
			..._data,
			variableParams: newConversationSetRef.value?.variableParams || null,
		}

		data.autoToLastMsg.value = true
		data.needSetLockAutoToLastMsg.value = true
		// 发送过消息,则禁用变量参数
		data.isSendMessageRef.value = true
		scrollToLastMsg(false)
		
		service.handleSendMessage(params, props.isTempChat)
	}

	/**
	 * 处理创建新会话
	 */
	const handleCreateNewConversation = (): void => {
		// 中止当前会话
		chatService?.abort()
		// 停止会话
		handleStopConversation()
		// 清空本地缓存中的临时会话uid
		uni.removeStorageSync(TEMP_CONVERSATION_UID)
		if (props.isTempChat) {
			// 清空会话数据
			clearConversationData(true)

			// 创建临时会话
			createTempChatConversation(data.captchaVerifyParam.value);
		} else {
			createNewConversation()
		}
	}

	/**
	 * 处理更多弹窗
	 */
	const handleMorePopup = (): void => {
		if (data.refMorePopup.value) {
			nextTick(() => {
				data.refMorePopup.value?.open()
			})
		}
	}

	/**
	 * 处理功能按钮点击
	 */
	const handleButtonClick = (guideQuestion: string): void => {
		if (data.wholeDisabled.value) {
      uni.showToast({
        title: '请填写必填参数',
        icon: 'none',
        duration: 2000
      });
      return;
    }
		// 判断是否存在上传失败的图片或文件
		const existErrorFile = agentDetailInputPhoneRef.value?.files?.some(file => file.status === UploadFileStatus.error)
		if (existErrorFile) {
			uni.showToast({
				title: '请先删除上传失败的图片或文件',
				icon: 'none',
				duration: 1500
			})
			return
		}
		const params = {
			messageInfo: guideQuestion,
			files: agentDetailInputPhoneRef.value?.files || [],
			selectedComponents: agentDetailInputPhoneRef.value?.selectedComponents || [],
		}

		handleSendMessage(params);
	}

	// 预览图片
	const onPreview = (file: AttachmentFile, attachments: AttachmentFile[]) => {
		if (!file.mimeType.includes('image/')) {
      uni.showToast({
        title: '当前不支持预览该类型文件',
        icon: 'none',
        duration: 1500
      })
      return
    }
		const urls = attachments?.filter(f => f.mimeType.includes('image/'))?.map(f => f.fileUrl) || []
		if (urls.length > 0 && file?.fileUrl) {
    	uni.previewImage({
        urls,
        current: file.fileUrl,
      });
    }
  };

	/**
	 * 长按消息处理
	 */
	const onlongTapMsg = (item: any): void => {
		// 显示操作菜单
	}

	/**
	 * 长按用户消息处理 - 复制文本
	 */
	const onlongTapUserMsg = (item: MessageInfo): void => {
		if (!item.text) {
			return
		}
		uni.setClipboardData({
			data: item.text,
			success: () => {
				uni.showToast({
					title: '已复制',
					icon: 'none',
					duration: 2000
				})
			}
		})
	}

	/**
	 * 思考内容变化处理
	 */
	const changeThinkContent = (hideThinkContent: boolean): void => {
		setIsInScrollBottom()
		if (data.autoToLastMsg.value) {
			nextTick(() => {
				scrollToLastMsg(false)
			})
		}
	}

	/**
	 * 键盘高度变化处理
	 */
	const onKeyboardheightchange = (res: UniInputKeyboardHeightChangeEvent): void => {
		data.keyboardHeight.value = res.detail.height
	}

	// ==================== 计算属性 ====================
	const lastMessage = computed(() => data.messageList.value[data.messageList.value.length - 1] ?? null)
	// 标题
	const headerTitle = computed(() => (props.isTempChat && agentInfo.value?.name) ? `和${agentInfo.value?.name}开始会话` : agentInfo.value?.name)

	// ==================== 页面加载处理 ==================== 
	watch(lastMessage, async () => {
		setIsInScrollBottom()
		lockAutoToLastMsg()
		if (!data.scrollTouch.value && data.autoToLastMsg.value) {
			await nextTick()
			setTimeout(() => {
				scrollToLastMsg(false)
			}, 100)
		}
	}, { deep: true })

	watch(data.messageList, async () => {
		setIsInScrollBottom()
		lockAutoToLastMsg()
		if (!data.scrollTouch.value && data.autoToLastMsg.value) {
			await nextTick()
			setTimeout(() => {
				scrollToLastMsg(false)
			}, 100)
		}
	}, { deep: true })

	watch(conversationId, async (newVal) => {

		if (!eventBindConfig.value && newVal) {
			// 查询历史会话信息(接口返回数据中包含智能体详情信息, 所以不在需要单独查询智能体详情信息了)
			const res = await apiAgentConversation(newVal)
			if (res.code === SUCCESS_CODE) {
				// 事件绑定配置
				eventBindConfig.value = res.data?.agent?.eventBindConfig || null
			}
		}
		
	}, { deep: true })

	// ==================== 页面加载处理 ====================
	/**
	 * 处理页面加载
	 */
	const handlePageLoad = async (params): Promise<void> => {
		// 智能体id
		data.agentId.value = params.id ? Number(params.id) : ''
		// 从缓存中获取payload数据
		const payload = uni.getStorageSync(CONVERSATION_PAYLOAD)
		const payloadData = payload ? JSON.parse(payload) : {}
		// 消息信息
		const messageInfo = payloadData.messageInfo || ''
		// 文件信息
		const files = payloadData.files || []
		// 组件列表
		const _selectedComponents = payloadData.selectedComponents || null
		
		data.selectedComponents.value = _selectedComponents

        // 如果存在会话id，则初始化ParseMarkdown，查询历史会话信息
		if (params.conversationId) {
			const id = Number(params.conversationId)
			data.conversationId.value = id
			// 查询历史会话信息(接口返回数据中包含智能体详情信息, 所以不在需要单独查询智能体详情信息了)
			const res = await apiAgentConversation(id)
			if (res.code === SUCCESS_CODE) {
				// 事件绑定配置
				eventBindConfig.value = res.data?.agent?.eventBindConfig || null
				// 处理消息列表
				handleQueryConversation(res)
			}
			// 查询智能体详情信息
			// getPublishedAgentInfo()
		} else {
			// 查询智能体详情信息，并初始化会话id
			getPublishedAgentInfo(true, {
				messageInfo,
				files,
				selectedComponents: _selectedComponents
			})
		}
	}

	/**
	 * 使用chatKey、captchaVerifyParam创建临时会话
	 * chatKey: 链接key
	 * captchaVerifyParam: 验证码参数 (可选)
	 */
	const handleCreateTempChat = async (captchaVerifyParam: string = '') => {
		// 验证码参数
		data.captchaVerifyParam.value = captchaVerifyParam;
		data.isLoadingConversation.value = true;
		const uid = uni.getStorageSync(TEMP_CONVERSATION_UID);
		if (uid) {
			data.conversationUid.value = uid;
			// 查询临时会话详细
			queryTempConversation(uid)
		} else {
			// 创建临时会话
			createTempChatConversation(captchaVerifyParam);
		}
  };

	/**
	 * 处理临时会话页面加载
	 */
	const handleTempChatPageLoad = async (params) => {
		// 临时会话key
		data.chatKey.value = params.chatKey
		// 是否存在缓存的chatKey值
		const _cacheChatKey = uni.getStorageSync(TEMP_CHAT_KEY)

		/**
		 * 如果缓存的chatKey值存在且与当前的chatKey值不一致，则清空缓存的临时会话uid 
		 * (防止用户手动修改url地址中的chatKey值后刷新页面，因为缓存TEMP_CONVERSATION_UID的值与chatKey值不匹配，导致后面查询会话详情时提示会话ID不存在的bug)
		 */
		if (_cacheChatKey && params.chatKey !== _cacheChatKey) {
			uni.removeStorageSync(TEMP_CONVERSATION_UID)
		}
		// 缓存chatKey
		uni.setStorageSync(TEMP_CHAT_KEY, params.chatKey)
		
		// 租户配置信息
		let _tenantConfigInfo = null
		// 从缓存中查询是否存在租户配置信息
		const info = uni.getStorageSync(TENANT_CONFIG_INFO);
		if (info) {
			_tenantConfigInfo = JSON.parse(info)
		} else {
			// 不存在，则查询租户配置信息
			const res = await apiTenantConfig()

			if (res.code === SUCCESS_CODE) {
				_tenantConfigInfo = res.data
				// 缓存租户配置信息
				uni.setStorageSync(TENANT_CONFIG_INFO, JSON.stringify(res.data))
			}
		}

		tenantConfigInfo.value = _tenantConfigInfo
		const { captchaSceneId, captchaPrefix, openCaptcha } = _tenantConfigInfo;
		// 是否需要阿里云验证码, 只有同时满足三个条件才启用验证码：场景ID存在、身份标存在、开启验证码
		const isNeedCaptcha = !!(captchaSceneId && captchaPrefix && openCaptcha);
		// 不需要阿里云验证码时，直接调用接口
		if (!isNeedCaptcha) {
			handleCreateTempChat();
		}
	}



	const handlePagePreviewExecuting = (data: any) => {
		const input = data.result?.input || null
		if (!input) {
			return
		}
		/**
		 * 如果uri_type不存在，则默认设置为Page
		 * 如果uri_type存在，则使用uri_type
		 */
		input.uri_type = input.uri_type ?? 'Page'
		// 拼接 query 参数
		const argumentsString = objectToQueryString(input.arguments);
		// 处理 query 参数
		const queryString = argumentsString?`?${argumentsString}`:'';
		
		if (input.uri_type === 'Link' && data.status === ProcessingEnum.FINISHED) {
			
			const pageUrl = input.uri + queryString;
			window.open(pageUrl, '_blank');
			return
		}

		if (input.uri_type === 'Page') {
			// 构建完整的页面 URL
			const fullUri = input.uri + queryString;


			// 手动打开页面首页
			if (data.status === ProcessingEnum.FINISHED) {
				// 打开页面首页
				handleOpenPagePreview({uri: fullUri})
				return
			}

			// 自动打开预览页面
			if (data.status === ProcessingEnum.EXECUTING) {
				// 打开页面并调用接口
				handleOpenPagePreview({uri: fullUri, method: input.method, data_type: input.data_type, request_id: input.request_id})
				return
			}
			
		}

	}

	/**
	 * 打开页面预览
	 * @param uri 页面URI
	 * @param method 请求方法 (默认: browser_open_page)
	 * @param data_type 数据类型 (默认: html)
	 * @param request_id 请求ID (默认: '')
	 */
	const handleOpenPagePreview = async({uri, method='browser_open_page', data_type='html', request_id=''}: ShowPagePreviewOptions)=>{
		const { code, data } = await apiUserTicketCreate()
		if (code === SUCCESS_CODE && data) { uri = uri + '?_ticket=' + data }
		// 打开页面首页
		// #ifdef H5 || WEB
		pagePreviewIframeRef.value?.handlePageOpen({
			uri: `${API_BASE_URL}${uri}`,
			method,
			data_type,
			request_id
		})
		// #endif


		// #ifdef MP-WEIXIN
		handleExternalLink(`${API_BASE_URL+uri}`)
		// #endif
	}

	// 处理更多信息
	const handleOpenInfo = () => {
		nextTick(() => {
			refMorePopup.value?.popupMore?.open()
		})
	}


	// 事件代理
	useMessageEventDelegate(msgListContentRef, eventBindConfig,(data: ShowPagePreviewOptions)=>{
		// 打开引导问题页面弹窗
		handleOpenPagePreview({uri:data.uri})
	})

	// ==================== 生命周期 ====================
	onLoad(async (params) => {
		ticket.value= params._ticket || ''

		// 微信小程序事件绑定
		// #ifdef MP-WEIXIN
		uni.$on('message-event-delegate', data => {
			const eventType = data.attrs['event-type']
			const dataStr = data.attrs['data']
			if (eventType && dataStr) {
				handleMessageEventClick(eventType, dataStr, eventBindConfig.value, handleOpenPagePreview, dedupManager)
			} else {
				console.warn('[Event Delegate] 缺少必要属性', { eventType, dataStr })
			}
		})
		// #endif


		// 判断是否是临时会话
		if (props.isTempChat) {
			await handleTempChatPageLoad(params)
		} else {
			try {
				const value = uni.getStorageSync(TENANT_CONFIG_INFO);
				const _tenantConfigInfo = value ? JSON.parse(value) : null;
				if (_tenantConfigInfo) {
					uni.setNavigationBarTitle({
						title: _tenantConfigInfo?.siteName,
					});
				}
			} catch (e) {
				// error
			}
			await handlePageLoad(params)
		}
	})

	// 设置事件监听器
	onMounted(() => {
		uni.$on('updateMessageComponent', (eventData: any) => {
			updateMessageComponent(eventData.messageId, eventData.data)
		})
		// #ifdef H5
		window.addEventListener('wheel', (e: WheelEvent) => {
			data.mouseScroll.value = true
			let clear: number = 0
			clear = setTimeout(() => {
				data.mouseScroll.value = false
				clearTimeout(clear)
			}, 1000)
		})
		// #endif


		uni.$on('page_preview_executing', handlePagePreviewExecuting);

	})
	
	// 清理事件监听器
	onUnmounted(() => {
		uni.$off('updateMessageComponent')
		// ⚠️ 页面卸载时取消监听，防止内存泄漏
		uni.$off('page_preview_executing', handlePagePreviewExecuting);
		uni.removeStorageSync(CONVERSATION_PAYLOAD)
	})

	// ✅ 直接在顶层使用生命周期钩子函数（uni-app X 提供的组合式 API）
	onAddToFavorites((res : any) : any => {
		// console.log('用户点击了收藏按钮')
		// console.log('来源：', res.from) // menu 或 button
		// console.log('目标信息：', res.target)
		// console.log('目标：', res)
		// handleCollect()

		// 同步返回收藏卡片的配置
		// return {
		// 	title: '收藏标题：uni-app x 示例',
		// 	imageUrl: '/static/fav.png',
		// 	query: 'id=666'
		// }
	})
</script>

<style lang="scss" scoped>
	@import './styles/index.scss';

	.captcha-button {
		position: absolute;
		left: 10px;
		top: 10px;
		visibility: hidden;
		opacity: 0;
	}
</style>