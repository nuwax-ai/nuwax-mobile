<template>
  <view class="variables-box flex flex-col" v-if="variables?.length">
    <!-- header -->
    <view class="header">
      <text class="title">对话设置</text>
      <text class="iconfont icon-a-Chevrondown down-icon" :class="{'rotate-90': !isOpen}" @click="handleOpenClose" />
    </view>
    <!-- 内容区域 -->
    <view :class="{'close-form': !isOpen, 'conversation-container': isOpen}">
      <view class="form-box">
        <view class="uni-form-item" v-for="item in variables" :key="item.key">
          <!-- 名称 -->
          <view class="form-item-title">
            <text class="display-name">{{ item.displayName }}</text>
            <text v-if="item.require" class="required">*</text>
          </view>
          <!-- textarea -->
          <textarea 
            v-if="item.inputType === InputTypeEnum.Paragraph" 
            :placeholder="item.description || '请输入'" 
            class="uni-input" 
            placeholder-class="uni-placeholder" 
            @input="(e) => handleChangeInput(e, item)" />
          <!-- 下拉选择器(单选) -->
          <view
            v-else-if="item.inputType === InputTypeEnum.Select || item.inputType === InputTypeEnum.MultipleSelect" 
            class="uni-input flex flex-row items-center content-between"
            @click="handleSelect(item)"
          >
            <view class="flex-1 flex flex-row items-center" v-if="formData.value?.[item.name]?.length">
              <template v-for="(info, index) in formData.value?.[item.name]" :key="info">
                <text>{{`${info.label}`}}</text>
                <text v-if="index !== formData.value?.[item.name].length - 1">/</text>
              </template>
            </view>
            <text v-else class="uni-placeholder">请选择</text>
            <text class="iconfont icon-a-Chevrondown down-icon" />
          </view>
          <!-- 输入框 -->
          <input
            v-else
            :placeholder="item.description || '请输入'"
            :type="item.inputType === InputTypeEnum.Number ? 'number' : 'text'"
            class="uni-input"
            placeholder-class="uni-placeholder"
            @input="(e) => handleChangeInput(e, item)"
          />
        </view>
      </view>
      <view v-if="disabled">
        <text class="desc">对话开始后，对话设置将无法修改。</text>
      </view>
      <!-- 级联选择器 -->
      <l-cascader
        v-if="visible"
        :visible="visible"
        v-model="cascaderValue"
        title="请选择"
        :options="options"
        @close="handleCancelSelect"
        @change="onChange" />
    </view>
  </view>
</template>

<script setup lang="uts">
  import { BindConfigWithSub } from '@/types/interfaces/common';
  import { InputTypeEnum } from '@/types/enums/agent';
  import lCascader from '@/uni_modules/lime-cascader/components/l-cascader/l-cascader.uvue';

  const props = defineProps({
    variables: {
      type: Array as PropType<BindConfigWithSub[]>,
      default: () => [],
    },
    isFilled: {
      type: Boolean,
      default: false,
    },
    disabled: {
      type: Boolean,
      default: false,
    },
  });

  // 是否打开表单
  const isOpen = ref<boolean>(true);
  // 是否显示级联选择器
  const visible = ref<boolean>(false);
  // 是否多选
  const isMultiple = ref<boolean>(false);
  // 级联选择器选项
  const options = ref<any[]>([]);
  // 已选择项的值
  const cascaderValue = ref<string>('');
  // 当前选择项的名称
  const currentName = ref<string>('');
  // 表单数据
  const formData = reactive({});

  const variableParams = computed(() => {
    if (!formData.value) {
      return null
    }
    let data = {};
    for (const key in formData.value) {
      const formValue = formData.value?.[key]
      if (formValue instanceof Array) {
        data[key] = formValue?.map(item => item.value)
      } else {
        data[key] = formValue
      }
    }
    return data
  })

  defineExpose({
    variableParams
  })

  watch(() => props.variables, (newVal) => {
    const obj = {};
    newVal.forEach(item => {
      const value = item.inputType === InputTypeEnum.Select || item.inputType === InputTypeEnum.MultipleSelect ? (item.bindValue || []) : item.bindValue;
      obj[item.name] = value
    });
    formData.value = obj;
  })

  // 打开关闭表单
  const handleOpenClose = () => {
    isOpen.value = !isOpen.value
  }

  // 级联选择器选择后
  const onChange = (_, selectedOptions) => {
    visible.value = false
    if (!formData.value) {
      formData.value = {}
    }
    // formData.value[currentName.value] = selectedOptions.map((item: UTSJSONObject): any|null => item.value) || []]
    formData.value[currentName.value] = selectedOptions || []
  }

  // 点击后打开级联选择器
  const handleSelect = (item) => {
    // 当前选择项的名称
    currentName.value = item.name
    // 显示级联选择器
    visible.value = true
    // 是否多选
    isMultiple.value = item.inputType === InputTypeEnum.MultipleSelect
    // 下拉选择项配置
    options.value = item.selectConfig?.options || []
    if (!formData.value) {
      formData.value = {}
    }
    const currentList = formData.value[item.name] || []
    if (currentList.length === 0) {
      cascaderValue.value = ''
    } else {
      const lastItem = currentList[currentList.length - 1]
      // 已选择项的值
      cascaderValue.value = lastItem.value || ''
    }
  }

  // 取消级联选择
  const handleCancelSelect = () => {
    // 当前选择项的名称
    currentName.value = ''
    // 隐藏级联选择器
    visible.value = false
    // 下拉选择项配置
    options.value = [];
    // 已选择项的值
    cascaderValue.value = '';
  }

  // 输入框输入值
  const handleChangeInput = (event: UniInputChangeEvent, item) => {
    if (!formData.value) {
      formData.value = {}
    }
    formData.value[item.name] = event.detail.value
  }
</script>

<style lang="scss" scoped>
  .variables-box {
    max-height: 50%;
    border-radius: 10rpx;
    background-color: #fff;
    border: 1rpx solid #e5e5e5;
    box-sizing: border-box;
    margin: 0 32rpx;

    .header {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
      font-weight: bold;
      padding: 18rpx 20rpx;

      .title {
        font-size: 28rpx;
        color: #15171F;
      }

      .down-icon {
        color: #95979c;
        user-select: none;
        font-size: 32rpx;
        transition: transform 0.3s ease-in-out;

        &.rotate-90 {
          transform: rotate(-90deg);
        }
      }
    }

    .conversation-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding-top: 20rpx;
      border-top: 1rpx solid #e5e5e5;
      overflow: hidden;
    }

    .close-form {
      transition: height 0.3s ease-in-out;
      height: 0;
      overflow: hidden;
    }

    .form-box {
      height: 100%;
      max-height: 400rpx;
      overflow-y: auto;
      padding: 0 20rpx;

      .uni-form-item {
        padding: 16rpx 0;

        .form-item-title {
          display: flex;
          flex-direction: row;
          align-items: center;

          .display-name {
            font-size: 28rpx;
            color: #15171F;
          }

          .required {
            color: #FF0000;
          }
        }

        .uni-input {
          width: 100%;
          background-color: rgba(12,20,40,0.04);
          border-radius: 8rpx;
          font-size: 28rpx;
          color: #15171F;
          padding: 16rpx;
          margin-top: 8rpx;
          box-sizing: border-box;

          text {
            font-size: 28rpx;
          }
        }

        .uni-placeholder {
          color: #6b6b75;
          font-size: 28rpx;
        }
      }
    }

    .desc {
      line-height: 60rpx;
      padding: 0 20rpx;
      color: #e5e5e5;
    }
  }
</style>