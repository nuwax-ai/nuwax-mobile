<template>
	<view class="container flex flex-col h-full">
		<custom-nav-bar :title="category?.name">
      <template v-slot:left>
        <text class="iconfont icon-a-Chevronleft" @tap="jumpNavigateBack"></text>
      </template>
    </custom-nav-bar>
    <scroll-view class="flex-1" direction="vertical" :show-scrollbar="false">
      <view v-for="item in categoryItems" :key="item.targetId" class="flex flex-row items-center item-card" hover-class="item-card-active" @click="handleAgentClick(item)">
        <image class="item-card__icon" :src="getImageSrc(item.targetId, item.icon)" mode="aspectFill" @error="handleImageError(item.targetId)" />
        <view class="item-card__content">
          <text class="item-card__name text-ellipsis">{{ item.name }}</text>
          <text class="item-card__desc text-ellipsis">{{ item.description}}</text>
        </view>
      </view>
    </scroll-view>
  </view>
</template>

<script setup lang="uts">
  import agentImage from '@/static/assets/agent_image.png'
  import { HOME_CATEGORY_INFO } from '@/constants/common.constants.uts'
  import { jumpToAgentDetailPage } from '@/utils/commonBusiness'
  import { jumpNavigateBack } from '@/utils/common'

  const category = ref<CategoryInfo>(null)
  const categoryItems = ref<CategoryItemInfo[]>([])

  const emit = defineEmits<{
    'cancel': () => void
  }>()

	// 记录加载失败的图片ID
	const failedImageIds = reactive<Set<string>>(new Set())

  /**
   * 获取图片源地址
   * @param id 智能体ID
   * @param originalIcon 原始图片地址
   * @returns 图片地址（加载失败则返回默认图片）
   */
  const getImageSrc = (id: string, originalIcon: string): string => {
    return failedImageIds.has(id) ? agentImage : originalIcon
  }

  /**
   * 图片加载错误时触发，切换为默认图片
   * @param id 智能体ID
   */
  const handleImageError = (id: string) => {
    failedImageIds.add(id)
  }

  onLoad((options: { categoryKey: string }) => {
    const { categoryKey } = options
    const homeCategoryInfo = uni.getStorageSync(HOME_CATEGORY_INFO)
    if (homeCategoryInfo) {
      const homeCategoryInfoData = JSON.parse(homeCategoryInfo)
      category.value = homeCategoryInfoData.categories?.find((item: CategoryInfo) => item.type === categoryKey)
      categoryItems.value = homeCategoryInfoData.categoryItems?.[categoryKey] || []
    }
  })

  // 点击智能体
	const handleAgentClick = (info: AgentInfo) => {
		jumpToAgentDetailPage(info.targetId)
	}
</script>

<style lang="scss" scoped>
  .container {
    overflow: hidden;
    background-color: #fff;
    /* #ifdef MP-WEIXIN */
		// padding-top: env(safe-area-inset-top);
		padding-bottom: env(safe-area-inset-bottom);
		/* #endif */

    .item-card {
      display: flex;
      align-items: center;
      padding: 24rpx 32rpx;
      border-bottom: 1px solid rgba(12, 20, 102, 0.04);

      &-active {
        background-color: rgba(12, 20, 102, 0.04);
      }
      
      &__icon {
        width: 80rpx;
        height: 80rpx;
        border-radius: 50%;
        margin-right: 24rpx;
      }
      
      &__content {
        flex: 1;
      }
      
      &__name {
        font-size: 32rpx;
        color: #333;
      }
      
      &__desc {
        font-size: 24rpx;
        color: #999;
        margin-top: 8rpx;
      }
      
      &__count {
        font-size: 28rpx;
        color: #666;
      }
    }
  }
</style>