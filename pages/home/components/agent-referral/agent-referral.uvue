<template>
	<view class='container'>
		<!-- 分类导航 -->
		<view class='category-nav'>
			<scroll-view class='category-scroll' direction="horizontal" :scroll-with-animation="true"
				:scroll-into-view="scrollIntoView" :show-scrollbar="false">
				<view :id="category.type" v-for="(category, index) in categories" :key="category.type"
					:class="`category-item ${activeCategory === category.type ? 'active' : ''}`"
					@click="handleCategoryClick(category.type, index)">
					<text class='category-text'>{{ category.name }}</text>
				</view>
			</scroll-view>
		</view>

		<!-- 滚动部分 -->
		<view class='scroll-section'>
			<swiper 
				class='agent-swiper' 
				:current="activeSwiperIndex" 
				@change="handleSwiperChange"
				:indicator-dots="false"
				:circular="false"
				:duration="300"
				easing-function="easeOut"
			>
				<swiper-item class='swiper-item' v-for="(category, index) in categories" :key="category.type">
					<!-- 只渲染当前页和相邻页，减少渲染压力 -->
					<view v-if="shouldRenderCategory(index)" class='h-full'>
						<scroll-view 
							class='agent-scroll' 
							:refresher-enabled="false"
							:refresher-triggered="refreshingMap[category.type] || false" 
							:show-scrollbar="false"
						>
							<view class='agent-list-container'>
								<template v-if="(agentListMap[category.type] || []).length">
									<agent-component
										v-for="info in agentListMap[category.type]" 
										:key="info.targetId"
										:icon="info.icon"
										:name="info.name"
										:userName="info.publishUser?.userName"
										:description="info.description"
										:userCount="info.statistics?.userCount"
										:convCount="info.statistics?.convCount"
										:collectCount="info.statistics?.collectCount"
										@click="handleAgentClick(info.targetId)"
									/>
								</template>
								<empty-state v-if="!agentListMap[category.type]" />
							</view>
						</scroll-view>
					</view>
					<!-- 未加载的页面显示占位 -->
					<view v-else class="h-full placeholder-view"></view>
				</swiper-item>
			</swiper>
		</view>
	</view>
</template>


<script setup lang="uts">
	import { ref, watch } from 'vue'
	import { HomeAgentCategoryInfo, CategoryInfo, CategoryItemInfo } from '@/types/interfaces/agentConfig'
	import AgentComponent from '@/components/agent-component/agent-component.uvue'
	import { jumpToAgentDetailPage } from '@/utils/commonBusiness'


	// 定义Props接口
	interface Props {
		type?: string
		data?: HomeAgentCategoryInfo
	}

	// 使用TypeScript方式定义props
	const props = withDefaults(defineProps<Props>(), {
		type: '',
		data: {
			categories: [],
			// 首页分类数据列表
			categoryItems: {}
		}
	})

	// ==================== 状态管理 ====================
	const activeCategory = ref<string>('')
	const activeSwiperIndex = ref<number>(0)
	const categories = ref<CategoryInfo[]>([])
	const agentListMap = ref<{ [key : string] : CategoryItemInfo[] }>({})
	const refreshingMap = ref<{ [key : string] : boolean }>({})
	const scrollIntoView = ref<string>('')
	const renderedCategoryIndexes = ref<Set<number>>(new Set([0, 1]))

	// ==================== 工具函数 ====================
	/**
	 * 更新预渲染索引集合
	 * @param centerIndex 中心索引
	 */
	const updateRenderedIndexes = (centerIndex: number) => {
		renderedCategoryIndexes.value.clear()
		// 添加当前页和相邻页
		for (let i = Math.max(0, centerIndex - 1); i <= Math.min(categories.value.length - 1, centerIndex + 1); i++) {
			renderedCategoryIndexes.value.add(i)
		}
	}

	/**
	 * 触发分类滚动（处理微信小程序需要先清空的问题）
	 * @param targetType 目标分类类型
	 */
	const triggerCategoryScroll = (targetType: string) => {
		// #ifdef MP-WEIXIN
		scrollIntoView.value = ''
		setTimeout(() => {
			scrollIntoView.value = targetType
		}, 50)
		// #endif
		
		// #ifdef H5
		nextTick(() => {
			scrollIntoView.value = targetType
		})
		// #endif
	}

	/**
	 * 切换到指定分类
	 * @param type 分类类型
	 * @param index 分类索引
	 */
	const switchToCategory = (type: string, index: number) => {
		activeCategory.value = type
		activeSwiperIndex.value = index
		updateRenderedIndexes(index)
		triggerCategoryScroll(type)
	}

	// ==================== 事件处理 ====================
	/**
	 * 判断是否应该渲染该分类
	 */
	const shouldRenderCategory = (index: number): boolean => {
		const shouldRender = Math.abs(index - activeSwiperIndex.value) <= 1
		if (shouldRender) {
			renderedCategoryIndexes.value.add(index)
		}
		return renderedCategoryIndexes.value.has(index)
	}

	const handleAgentClick = (id: number) => jumpToAgentDetailPage(id)

	const handleCategoryClick = (key: string, index: number) => {
		switchToCategory(key, index)
	}

	const handleSwiperChange = (e: UniSwiperChangeEvent) => {
		const { current } = e.detail
		const category = categories.value[current]
		if (category && category.type !== activeCategory.value) {
			switchToCategory(category.type, current)
		}
	}

	// ==================== 初始化 ====================
	const initDefaultSetting = () => {
		if (!props.data) return
		
		categories.value = props.data.categories || []
		agentListMap.value = props.data.categoryItems || {}

		// 确定目标分类索引
		const targetIndex = props.type 
			? Math.max(0, categories.value.findIndex(item => item.type === props.type))
			: 0

		// 获取目标分类
		const targetCategory = categories.value[targetIndex]
		if (!targetCategory) return

		// 切换到目标分类
		switchToCategory(targetCategory.type, targetIndex)
	}

	// ==================== 生命周期 ====================
	// #ifdef MP-WEIXIN
	watch(() => props.type, initDefaultSetting)
	// #endif
	
	watch(() => props.data, initDefaultSetting)

	// #ifdef H5
	onLoad(initDefaultSetting)
	// #endif

	defineExpose({
		triggerCategoryScroll
	})
</script>

<style scoped lang="scss">
.container {
	height: 100%;
	display: flex;
	flex-direction: column;
	overflow: hidden;
	background-color: #fff;
	border-radius: 20rpx;
	
	/* #ifdef MP-WEIXIN */
	padding-bottom: env(safe-area-inset-bottom);
	/* #endif */

	// ==================== 分类导航 ====================
	.category-nav {
		padding: 0 32rpx;

		.category-scroll {
			height: 112rpx;
			gap: 16rpx;
			display: flex;
			flex-direction: row;
			align-items: center;
			white-space: nowrap;
			scroll-behavior: smooth;
			-webkit-overflow-scrolling: touch;
		}

		.category-item {
			display: flex;
			justify-content: center;
			height: 80rpx;
			padding: 0 32rpx;
			border-radius: 16rpx;
			font-size: 32rpx;
			font-weight: 400;
			color: #5E6470;
			cursor: pointer;
			user-select: none;
			transition: all 0.3s ease;

			&.active {
				background-color: #F2F2FF;
				.category-text {
					color: #5147FF;
				}
			}

			.category-text {
				font-size: 32rpx;
				font-weight: 400;
				color: #5E6470;
				transition: color 0.3s ease;
			}
		}
	}

	// ==================== 滚动内容区 ====================
	.scroll-section {
		flex: 1;
		overflow: hidden;

		.agent-swiper,
		.swiper-item,
		.agent-scroll {
			height: 100%;
		}

		.swiper-item {
			overflow: hidden;
		}

		.agent-list-container {
			padding: 0 16rpx;
			transform: translateZ(0); // GPU 加速
		}

		.placeholder-view {
			background-color: #f8f9fa;
		}
	}

	// ==================== 状态显示 ====================
	.empty-state,
	.loading-state {
		display: flex;
		align-items: center;
		justify-content: center;
		padding: 40rpx;
	}

	.empty-state {
		flex-direction: column;
		padding: 160rpx 40rpx;
		text-align: center;
	}

	.empty-text {
		font-size: 28rpx;
		color: #999;
		margin-top: 32rpx;
	}
}
</style>