import { ref, onMounted, onUnmounted, Ref } from 'vue'
import { EventBindResponseActionEnum } from '@/types/enums/agent'
import { checkPathParams, fillPathParams } from '@/utils/common.uts'
import { EventBindConfig, ShowPagePreviewOptions } from '@/types/interfaces/agent'
import { API_BASE_URL } from '@/constants/config'

// ============ å·¥å…·æ–¹æ³• ============
const showError = (msg: string): void => {
  uni.showToast({
    title: msg,
    icon: 'none'
  })
}

// ============ ä¸» Hook ============

export const useMessageEventDelegate = (
  containerRef: Ref<HTMLElement | null>,
  eventBindConfig?: EventBindConfig,
  showPagePreview?: (opts: ShowPagePreviewOptions) => void
) => {
  const handledEventsRef = ref<Set<string>>(new Set())

  // ğŸ‘‰ ç‚¹å‡»äº‹ä»¶å¤„ç†
  const handleEventClick = (eventType: string, dataStr: string): void => {
    const eventKey = `${eventType}-${dataStr}`

    // é˜²é‡å¤è§¦å‘
    if (handledEventsRef.value.has(eventKey)) return
    handledEventsRef.value.add(eventKey)
    setTimeout(() => handledEventsRef.value.delete(eventKey), 1000)

    console.log('[Event Delegate] è§¦å‘äº‹ä»¶:', { eventType, dataStr })

    let parsedData: Record<string, any> = {}
    try {
      parsedData = JSON.parse(dataStr)
    } catch (err) {
      console.error('[Event Delegate] æ•°æ®è§£æå¤±è´¥:', err)
      return
    }

    const eventConfig = eventBindConfig.value?.eventConfigs?.find(
      (cfg) => cfg.identification === eventType
    )
    if (!eventConfig) {
      console.warn(`[Event Delegate] æœªæ‰¾åˆ°äº‹ä»¶é…ç½®: ${eventType}`)
      return
    }

    console.log('[Event Delegate] æ‰¾åˆ°äº‹ä»¶é…ç½®:', eventConfig)

    // === æ ¹æ®ç±»å‹æ‰§è¡Œ ===
    switch (eventConfig.type) {
      case EventBindResponseActionEnum.Page: {
        if (!eventConfig.pageUrl) {
          showError('é¡µé¢è·¯å¾„é…ç½®é”™è¯¯')
          return
        }

        const pathParams: Record<string, any> = {}
        const params: Record<string, any> = {}

        eventConfig.args?.forEach((arg) => {
          if (arg.inputType === 'Path' && arg.name)
            pathParams[arg.name] = parsedData[arg.name] ?? arg.bindValue
          if (arg.inputType === 'Query' && arg.name)
            params[arg.name] = parsedData[arg.name] ?? arg.bindValue
        })

        if (checkPathParams(eventConfig.pageUrl, pathParams)) {
          const pageUrl = fillPathParams(eventConfig.pageUrl, pathParams)
          const fullUri = eventConfig.basePath
            ? `${eventConfig.basePath}${pageUrl}`
            : `${API_BASE_URL}${pageUrl}`

          console.log('[Event Delegate] æ‰“å¼€é¡µé¢:', {
            uri: fullUri,
            params
          })

          const queryString = new URLSearchParams(params).toString()
          showPagePreview?.({
            uri: queryString ? `${fullUri}?${queryString}` : fullUri,
          })
        } else {
          showError('é¡µé¢è·¯å¾„å‚æ•°é…ç½®é”™è¯¯')
        }
        break
      }

      case EventBindResponseActionEnum.Link: {
        if (!eventConfig.url) {
          showError('é“¾æ¥åœ°å€é…ç½®é”™è¯¯')
          return
        }
        console.log('[Event Delegate] æ‰“å¼€å¤–é“¾:', eventConfig.url)
        // uni.openURL(eventConfig.url)
        window.open(eventConfig.url, '_blank')
        break
      }

      default:
        console.warn(`[Event Delegate] æœªçŸ¥çš„äº‹ä»¶ç±»å‹: ${eventConfig.type}`)
    }
  }

  // ğŸ‘‰ ç›‘å¬å®¹å™¨ç‚¹å‡»äº‹ä»¶
  const handleClick = (e: MouseEvent): void => {
    const target = e.target as HTMLElement
    const eventElement = target.closest('.event') as HTMLElement | null

    if (eventElement) {
      e.preventDefault()
      e.stopPropagation()
      const eventType = eventElement.getAttribute('event-type')
      const dataStr = eventElement.getAttribute('data')
      if (eventType && dataStr) {
        handleEventClick(eventType, dataStr)
      } else {
        console.warn('[Event Delegate] ç¼ºå°‘å¿…è¦å±æ€§', { eventType, dataStr })
      }
    }
  }

  // ğŸ‘‰ ç”Ÿå‘½å‘¨æœŸæŒ‚è½½ä¸æ¸…ç†
  onMounted(() => {
    const container = containerRef.value
    if (container) {
      container.addEventListener('click', handleClick)
      console.log('[Event Delegate] äº‹ä»¶ä»£ç†å·²åˆå§‹åŒ–')
    }
  })

  onUnmounted(() => {
    const container = containerRef.value
    if (container) {
      container.removeEventListener('click', handleClick)
      console.log('[Event Delegate] äº‹ä»¶ä»£ç†å·²æ¸…ç†')
    }
  })

  // return { handleEventClick }
}
