import { nextTick } from 'vue'
import AgentDetailData from './AgentDetailData.uts'

/**
 * 滚动管理层：专门处理滚动相关的逻辑
 */
export default class ScrollManager {
	private data: AgentDetailData
	constructor(private data: AgentDetailData) {
		this.data = data
	}

	/**
	 * 滚动到最后一条消息
	 */
	scrollToLastMsg(userClick: boolean): void {
		this.data.autoToLastMsg.value = true
		this.data.scrollIntoView.value = ""
		this.data.scrollWithAnimation.value = userClick
		nextTick(() => {
			this.data.scrollIntoView.value = "last-msg"
			this.data.scrollInBottom.value = true
		})
	}
	
	/**
	 * 设置是否在滚动底部
	 */
	setIsInScrollBottom(): void {
		nextTick(() => {
			const scrollList = uni.getElementById('msg-list')
			const diff: number = scrollList!.scrollHeight - scrollList!.scrollTop - scrollList!.offsetHeight
			this.data.scrollInBottom.value = diff < 30
			if (this.data.scrollTouch.value || this.data.mouseScroll.value) {
				this.data.autoToLastMsg.value = !(diff > 3)
			}
		})
	}
	
	/**
	 * 锁定自动滚动到底部
	 */
	lockAutoToLastMsg(): void {
		if (!this.data.needSetLockAutoToLastMsg.value) return
		
		const lastMessageId = this.data.messageList.value.length > 0 ? this.data.messageList.value[this.data.messageList.value.length - 1].id?.toString() : null
		const lastMsgEl: UniElement | null = lastMessageId ? uni.getElementById('msg-item-' + lastMessageId) : null
		const scrollList: UniElement | null = uni.getElementById('msg-list')
		
		if (lastMsgEl == null || scrollList == null) return 
		
		if (this.data.messageList.value.length < 3 || scrollList.offsetHeight < lastMsgEl.offsetHeight) {
			this.data.autoToLastMsg.value = false
			this.data.needSetLockAutoToLastMsg.value = false
		}
	}

	/**
	 * 滚动事件处理
	 */
	onScroll(e: UniScrollEvent): void {
		this.data.mouseScroll.value = true
		this.setIsInScrollBottom()
		this.data.scrolling.value = true
		if (this.data.scrollingT.value != 0) {
			clearTimeout(this.data.scrollingT.value)
		}
		this.data.scrollingT.value = setTimeout(() => {
			this.data.scrolling.value = false
			this.data.mouseScroll.value = false
		}, 500)
	}
}
