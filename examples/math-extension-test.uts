// 测试数学公式扩展的正则表达式匹配
import { getMathExtensions } from '@/uni_modules/kux-marked/common/extensions/MathExtension';

// 测试用例
const testCases = [
	// 行内公式测试
	'$E = mc^2$',
	'\\(\\frac{a}{b} + \\frac{c}{d}\\)',
	'$x^2 + y^2 = z^2$',
	'\\(\\sqrt{x^2 + y^2}\\)',
	
	// 块级公式测试
	'$$\int_{-\infty}^{\infty} e^{-x^2} dx = \sqrt{\pi}$$',
	'\\[\\sum_{i=1}^{n} x_i = x_1 + x_2 + \\cdots + x_n\\]',
	'$$\frac{d}{dx} x^n = nx^{n-1}$$',
	'\\[\\lim_{x \\to 0} \\frac{\\sin x}{x} = 1\\]',
	
	// 混合内容测试
	'这是一个行内公式：$E = mc^2$ 和块级公式：$$\int_{-\infty}^{\infty} e^{-x^2} dx = \sqrt{\pi}$$',
	'使用 \\( \\) 语法的行内公式：\\(\\frac{a}{b} + \\frac{c}{d}\\)',
	'使用 \\[ \\] 语法的块级公式：\\[\\sum_{i=1}^{n} x_i\\]',
	
	// 边界情况测试
	'$simple$',
	'\\(simple\\)',
	'$$simple$$',
	'\\[simple\\]',
	'$ $',
	'\\( \\)',
	'$$ $$',
	'\\[ \\]'
];

// 获取扩展
const extensions = getMathExtensions();
console.log('=== 数学公式扩展测试 ===');
console.log('扩展数量:', extensions.length);
console.log('扩展名称:', extensions.map(ext => ext.name));

// 测试每个扩展
extensions.forEach(extension => {
	console.log(`\n--- 测试扩展: ${extension.name} ---`);
	console.log('扩展级别:', extension.level);
	console.log('扩展优先级:', extension.priority);
	
	testCases.forEach((testCase, index) => {
		console.log(`\n测试用例 ${index + 1}: "${testCase}"`);
		
		// 模拟 lexer 和 tokens 参数
		const mockLexer = {
			_instance: () => mockLexer
		};
		const mockTokens: any[] = [];
		
		try {
			const result = extension.tokenizer(mockLexer, testCase, mockTokens);
			if (result) {
				console.log('✅ 匹配成功:', {
					type: result.type,
					raw: result.raw,
					text: result.text,
					display: (result as any).display,
					mathType: (result as any).mathType
				});
			} else {
				console.log('❌ 未匹配');
			}
		} catch (error) {
			console.log('❌ 解析错误:', error);
		}
	});
});

// 测试正则表达式
console.log('\n=== 正则表达式测试 ===');

// 行内公式正则表达式
const inlineDollarPattern = /^\$([^\$\n]+?)\$/;
const inlineParenPattern = /^\\\(([^\\]*?)\\\)/;

// 块级公式正则表达式
const blockDollarPattern = /^(\${2,})\n?([\s\S]*?)\n?\1(?:\n|$)/;
const blockBracketPattern = /^\\\[([\s\S]*?)\\\](?:\n|$)/;

testCases.forEach((testCase, index) => {
	console.log(`\n测试用例 ${index + 1}: "${testCase}"`);
	
	// 测试行内公式正则表达式
	const dollarMatch = inlineDollarPattern.exec(testCase);
	if (dollarMatch) {
		console.log('✅ $...$ 匹配:', dollarMatch[0]);
	}
	
	const parenMatch = inlineParenPattern.exec(testCase);
	if (parenMatch) {
		console.log('✅ \\(...\\) 匹配:', parenMatch[0]);
	}
	
	// 测试块级公式正则表达式
	const doubleDollarMatch = blockDollarPattern.exec(testCase);
	if (doubleDollarMatch) {
		console.log('✅ $$...$$ 匹配:', doubleDollarMatch[0]);
	}
	
	const bracketMatch = blockBracketPattern.exec(testCase);
	if (bracketMatch) {
		console.log('✅ \\[...\\] 匹配:', bracketMatch[0]);
	}
	
	if (!dollarMatch && !parenMatch && !doubleDollarMatch && !bracketMatch) {
		console.log('❌ 所有正则表达式都未匹配');
	}
});

console.log('\n=== 测试完成 ===');
