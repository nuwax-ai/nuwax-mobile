<template>
	<view class="test-container">
		<view class="header">
			<text class="title">ğŸ§® æ•°å­¦å…¬å¼æ‰©å±•ç®€å•æµ‹è¯•</text>
		</view>
		
		<view class="test-section">
			<text class="section-title">æµ‹è¯•ç»“æœ</text>
			<view class="result-display">
				<text class="result-text">{{ testResult }}</text>
			</view>
		</view>
		
		<view class="test-section">
			<text class="section-title">æ§åˆ¶å°è¾“å‡º</text>
			<view class="console-output">
				<text class="console-text">{{ consoleOutput }}</text>
			</view>
		</view>
	</view>
</template>

<script setup lang="ts">
	import { Lexer } from '@/uni_modules/kux-marked/common/Lexer';
	
	const testResult = ref<string>('ç­‰å¾…æµ‹è¯•...');
	const consoleOutput = ref<string>('');
	
	// é‡å†™ console.log æ¥æ•è·è¾“å‡º
	const originalConsoleLog = console.log;
	console.log = (...args: any[]) => {
		originalConsoleLog.apply(console, args);
		const output = args.map(arg => 
			typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
		).join(' ');
		consoleOutput.value += output + '\n';
	};
	
	onMounted(() => {
		runTest();
	});
	
	const runTest = () => {
		try {
			console.log('=== å¼€å§‹æ•°å­¦å…¬å¼æ‰©å±•æµ‹è¯• ===');
			
			// åˆ›å»º Lexer å®ä¾‹
			const lexer = new Lexer();
			console.log('Lexer å®ä¾‹åˆ›å»ºæˆåŠŸ');
			
			// è·å–æ‰©å±•æ³¨å†Œå™¨
			const extensionRegistry = lexer.getExtensionRegistry();
			console.log('æ‰©å±•æ³¨å†Œå™¨è·å–æˆåŠŸ');
			
			// è·å–æ‰©å±•ç»Ÿè®¡ä¿¡æ¯
			const stats = extensionRegistry.getStats();
			console.log('æ‰©å±•ç»Ÿè®¡ä¿¡æ¯:', stats);
			
			// è·å–å·²æ³¨å†Œçš„æ‰©å±•åç§°
			const registeredNames = extensionRegistry.getRegisteredNames();
			console.log('å·²æ³¨å†Œæ‰©å±•åç§°:', registeredNames);
			
			// è·å–æ•°å­¦æ‰©å±•
			const mathInlineExt = extensionRegistry.getExtension('mathInline');
			console.log('æ•°å­¦è¡Œå†…æ‰©å±•:', mathInlineExt);
			
			const mathBlockExt = extensionRegistry.getExtension('mathBlock');
			console.log('æ•°å­¦å—çº§æ‰©å±•:', mathBlockExt);
			
			// æ£€æŸ¥æ‰©å±•çš„ä¼˜å…ˆçº§
			if (mathInlineExt) {
				console.log('è¡Œå†…æ‰©å±•ä¼˜å…ˆçº§:', mathInlineExt.priority);
				console.log('è¡Œå†…æ‰©å±•çº§åˆ«:', mathInlineExt.level);
			}
			
			if (mathBlockExt) {
				console.log('å—çº§æ‰©å±•ä¼˜å…ˆçº§:', mathBlockExt.priority);
				console.log('å—çº§æ‰©å±•çº§åˆ«:', mathBlockExt.level);
			}
			
			// æµ‹è¯•ç®€å•çš„æ•°å­¦å…¬å¼
			console.log('\n--- æµ‹è¯•ç®€å•æ•°å­¦å…¬å¼ ---');
			const simpleMath = '$E = mc^2$';
			console.log('æµ‹è¯•å†…å®¹:', simpleMath);
			
			// æ‰‹åŠ¨æµ‹è¯•æ‰©å±•
			console.log('\n--- æ‰‹åŠ¨æµ‹è¯•æ‰©å±• ---');
			if (mathInlineExt) {
				console.log('æ‰‹åŠ¨è°ƒç”¨è¡Œå†…æ‰©å±• tokenizer');
				const mockLexer = { _instance: () => mockLexer };
				const mockTokens: any[] = [];
				const result = mathInlineExt.tokenizer(mockLexer, simpleMath, mockTokens);
				console.log('æ‰‹åŠ¨æ‰©å±•ç»“æœ:', result);
			}
			
			const tokens = lexer.lex(simpleMath);
			console.log('è§£æç»“æœ:', tokens);
			
			// é€’å½’æŸ¥æ‰¾æ‰€æœ‰æŒ‡å®šç±»å‹çš„ token
			const findAllTokensByType = (tokenList: any[], targetType: string): any[] => {
				const foundTokens: any[] = [];
				tokenList.forEach(token => {
					if (token.type === targetType) {
						foundTokens.push(token);
					}
					// é€’å½’æ£€æŸ¥å­ tokens
					if (token.tokens && Array.isArray(token.tokens)) {
						foundTokens.push(...findAllTokensByType(token.tokens, targetType));
					}
				});
				return foundTokens;
			};
			
			// æ£€æŸ¥æ˜¯å¦æœ‰æ•°å­¦å…¬å¼ tokenï¼ˆåŒ…æ‹¬åµŒå¥—çš„ï¼‰
			const allMathTokens = findAllTokensByType(tokens.tokens || [], 'math');
			console.log('æ•°å­¦å…¬å¼ token æ•°é‡ï¼ˆåŒ…æ‹¬åµŒå¥—ï¼‰:', allMathTokens.length);
			
			if (allMathTokens.length > 0) {
				testResult.value = `âœ… æµ‹è¯•æˆåŠŸï¼æ‰¾åˆ° ${allMathTokens.length} ä¸ªæ•°å­¦å…¬å¼ token`;
				console.log('æ•°å­¦å…¬å¼ token è¯¦æƒ…:', allMathTokens);
			} else {
				testResult.value = 'âŒ æµ‹è¯•å¤±è´¥ï¼æœªæ‰¾åˆ°æ•°å­¦å…¬å¼ token';
				console.log('æ‰€æœ‰ token ç±»å‹:', tokens.tokens?.map((t: any) => t.type) || []);
				console.log('æ‰€æœ‰ token è¯¦æƒ…:', tokens.tokens || []);
			}
			
			// æµ‹è¯•å—çº§æ•°å­¦å…¬å¼
			console.log('\n--- æµ‹è¯•å—çº§æ•°å­¦å…¬å¼ ---');
			const blockMath = '$$\int_{-\infty}^{\infty} e^{-x^2} dx = \sqrt{\pi}$$';
			console.log('æµ‹è¯•å†…å®¹:', blockMath);
			
			const blockTokens = lexer.lex(blockMath);
			console.log('å—çº§å…¬å¼è§£æç»“æœ:', blockTokens);
			
			const blockMathTokens = findAllTokensByType(blockTokens.tokens || [], 'math');
			console.log('å—çº§æ•°å­¦å…¬å¼ token æ•°é‡:', blockMathTokens.length);
			
			// æµ‹è¯• Mermaid æ‰©å±•
			console.log('\n--- æµ‹è¯• Mermaid æ‰©å±• ---');
			const mermaidContent = '```mermaid\ngraph TD\n    A[å¼€å§‹] --> B[ç»“æŸ]\n```';
			console.log('æµ‹è¯•å†…å®¹:', mermaidContent);
			
			const mermaidTokens = lexer.lex(mermaidContent);
			console.log('Mermaid è§£æç»“æœ:', mermaidTokens);
			
			const mermaidTokenCount = findAllTokensByType(mermaidTokens.tokens || [], 'mermaid');
			console.log('Mermaid token æ•°é‡:', mermaidTokenCount.length);
			
			if (mermaidTokenCount.length > 0) {
				console.log('âœ… Mermaid æ‰©å±•å·¥ä½œæ­£å¸¸');
			} else {
				console.log('âŒ Mermaid æ‰©å±•ä¹Ÿæœªå·¥ä½œ');
			}
			
			// æµ‹è¯•æ··åˆå†…å®¹
			console.log('\n--- æµ‹è¯•æ··åˆå†…å®¹ ---');
			const mixedContent = 'è¿™æ˜¯ä¸€ä¸ªè¡Œå†…å…¬å¼ï¼š$E = mc^2$ å’Œå—çº§å…¬å¼ï¼š$$\int_{-\infty}^{\infty} e^{-x^2} dx = \sqrt{\pi}$$';
			console.log('æµ‹è¯•å†…å®¹:', mixedContent);
			
			const mixedTokens = lexer.lex(mixedContent);
			console.log('æ··åˆå†…å®¹è§£æç»“æœ:', mixedTokens);
			
			const mixedMathTokens = findAllTokensByType(mixedTokens.tokens || [], 'math');
			console.log('æ··åˆå†…å®¹ä¸­æ•°å­¦å…¬å¼ token æ•°é‡:', mixedMathTokens.length);
			
			console.log('=== æµ‹è¯•å®Œæˆ ===');
			
		} catch (error) {
			console.error('æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
			testResult.value = `âŒ æµ‹è¯•é”™è¯¯: ${error}`;
		}
	};
</script>

<style lang="scss" scoped>
	.test-container {
		padding: 32rpx;
		background-color: #f5f7fa;
		min-height: 100vh;
	}
	
	.header {
		text-align: center;
		margin-bottom: 32rpx;
		padding: 32rpx;
		background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
		border-radius: 20rpx;
		color: white;
	}
	
	.title {
		display: block;
		font-size: 36rpx;
		font-weight: bold;
	}
	
	.test-section {
		background: white;
		border-radius: 16rpx;
		padding: 24rpx;
		margin-bottom: 24rpx;
		box-shadow: 0 2rpx 12rpx rgba(0, 0, 0, 0.1);
	}
	
	.section-title {
		display: block;
		font-size: 28rpx;
		font-weight: bold;
		color: #2c3e50;
		margin-bottom: 16rpx;
	}
	
	.result-display {
		padding: 16rpx;
		background-color: #f8f9fa;
		border-radius: 12rpx;
		border-left: 4rpx solid #28a745;
	}
	
	.result-text {
		font-size: 26rpx;
		color: #2c3e50;
		line-height: 1.5;
	}
	
	.console-output {
		padding: 16rpx;
		background-color: #2d3748;
		border-radius: 12rpx;
		max-height: 400rpx;
		overflow-y: auto;
	}
	
	.console-text {
		font-family: 'Courier New', monospace;
		font-size: 22rpx;
		color: #e2e8f0;
		line-height: 1.4;
		white-space: pre-wrap;
	}
</style>
