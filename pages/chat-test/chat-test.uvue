<template>
  <view class="chat-test-page">
    <view class="header">
      <text class="title">聊天系统测试</text>
      <text class="subtitle">测试流式聊天和Markdown渲染功能</text>
    </view>
    
    <view class="test-section">
      <text class="section-title">功能测试</text>
      
      <view class="test-buttons">
        <button class="test-btn" @click="testMarkdown">测试Markdown渲染</button>
        <button class="test-btn" @click="testStreamChat">测试流式聊天</button>
        <button class="test-btn" @click="clearMessages">清空消息</button>
      </view>
    </view>
    
    <view class="chat-container">
      <scroll-view class="message-list" scroll-y>
        <view class="message-container">
          <view 
            v-for="message in messages" 
            :key="message.id" 
            class="message-item"
            :class="message.role"
          >
            <view class="message-avatar">
              <text v-if="message.role === 'user'">U</text>
              <text v-else>AI</text>
            </view>
            <view class="message-content">
              <text class="message-text">{{ message.content }}</text>
              <text v-if="message.error" class="error-text">{{ message.error }}</text>
            </view>
          </view>
        </view>
      </scroll-view>
    </view>
    
    <view class="input-section">
      <input 
        class="input-field" 
        v-model="inputText"
        placeholder="输入测试消息..."
        @confirm="sendMessage"
      />
      <button class="send-btn" @click="sendMessage">发送</button>
    </view>
  </view>
</template>

<script lang="uts" setup>
import { ChatMessage } from '@/types/interfaces/chat'
import { chatService } from '@/utils/chatService'

// 消息列表
const messages = ref<ChatMessage[]>([])
// 输入文本
const inputText = ref<string>('')

// 测试Markdown渲染
const testMarkdown = () => {
  const markdownContent = `# 测试标题

这是一个**粗体**文本，这是*斜体*文本。

## 代码示例
\`\`\`javascript
function hello() {
  console.log("Hello World!");
}
\`\`\`

### 列表
- 项目1
- 项目2
- 项目3

> 这是一个引用块

[点击这里](https://example.com)

---

这是普通文本。`

  const aiMessage = chatService.createAIMessage(markdownContent)
  messages.value.push(aiMessage)
}

// 测试流式聊天
const testStreamChat = async () => {
  const testMessage = "请介绍一下JavaScript的基本语法"
  
  // 添加用户消息
  const userMessage = chatService.createUserMessage(testMessage)
  messages.value.push(userMessage)
  
  // 创建AI消息
  const aiMessage = chatService.createAIMessage()
  messages.value.push(aiMessage)
  
  // 模拟流式响应
  const response = `# JavaScript 基本语法

JavaScript 是一种动态类型语言，具有以下基本语法特点：

## 变量声明
\`\`\`javascript
let name = "张三";
const age = 25;
var oldWay = "不推荐";
\`\`\`

## 函数定义
\`\`\`javascript
function greet(name) {
  return "Hello, " + name;
}

const arrowFunc = (name) => "Hello, " + name;
\`\`\`

## 条件语句
\`\`\`javascript
if (age > 18) {
  console.log("成年人");
} else {
  console.log("未成年人");
}
\`\`\`

> 这些是JavaScript的基础语法，掌握这些对于开始编程很有帮助。`

  // 模拟流式输出
  let currentContent = ''
  const words = response.split(' ')
  
  for (let i = 0; i < words.length; i++) {
    currentContent += words[i] + ' '
    aiMessage.content = currentContent
    await new Promise(resolve => setTimeout(resolve, 100))
  }
  
  // 完成消息
  chatService.completeAIMessage(aiMessage)
}

// 发送消息
const sendMessage = async () => {
  if (!inputText.value.trim()) return
  
  const content = inputText.value
  inputText.value = ''
  
  // 添加用户消息
  const userMessage = chatService.createUserMessage(content)
  messages.value.push(userMessage)
  
  // 创建AI消息
  const aiMessage = chatService.createAIMessage()
  messages.value.push(aiMessage)
  
  // 模拟AI响应
  setTimeout(() => {
    aiMessage.content = `我收到了您的消息："${content}"。这是一个测试响应。`
    chatService.completeAIMessage(aiMessage)
  }, 1000)
}

// 清空消息
const clearMessages = () => {
  messages.value = []
}
</script>

<style lang="scss" scoped>
.chat-test-page {
  height: 100vh;
  display: flex;
  flex-direction: column;
  background-color: #f5f5f5;
  
  .header {
    padding: 20px;
    background-color: #007AFF;
    color: white;
    
    .title {
      font-size: 24px;
      font-weight: bold;
      display: block;
      margin-bottom: 8px;
    }
    
    .subtitle {
      font-size: 14px;
      opacity: 0.8;
    }
  }
  
  .test-section {
    padding: 16px;
    background-color: white;
    border-bottom: 1px solid #e0e0e0;
    
    .section-title {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 12px;
      display: block;
    }
    
    .test-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      
      .test-btn {
        padding: 8px 16px;
        background-color: #007AFF;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 14px;
      }
    }
  }
  
  .chat-container {
    flex: 1;
    overflow: hidden;
    
    .message-list {
      height: 100%;
      
      .message-container {
        padding: 16px;
        
        .message-item {
          display: flex;
          margin-bottom: 16px;
          
          &.user {
            flex-direction: row-reverse;
            
            .message-content {
              margin-right: 12px;
              margin-left: 60px;
              background-color: #007AFF;
              color: white;
              border-radius: 18px 18px 4px 18px;
            }
          }
          
          &.assistant {
            .message-content {
              margin-left: 12px;
              margin-right: 60px;
              background-color: white;
              color: #333;
              border-radius: 18px 18px 18px 4px;
            }
          }
          
          .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 20px;
            background-color: #007AFF;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
          }
          
          .message-content {
            padding: 12px 16px;
            max-width: 70%;
            
            .message-text {
              line-height: 1.4;
              white-space: pre-wrap;
              word-break: break-word;
            }
            
            .error-text {
              color: #FF3B30;
              font-size: 12px;
              margin-top: 4px;
              display: block;
            }
          }
        }
      }
    }
  }
  
  .input-section {
    padding: 16px;
    background-color: white;
    border-top: 1px solid #e0e0e0;
    display: flex;
    gap: 12px;
    
    .input-field {
      flex: 1;
      padding: 12px;
      border: 1px solid #e0e0e0;
      border-radius: 20px;
      font-size: 16px;
    }
    
    .send-btn {
      padding: 12px 24px;
      background-color: #007AFF;
      color: white;
      border: none;
      border-radius: 20px;
      font-size: 16px;
    }
  }
}
</style>
