import { ref } from 'vue'
import type { AgentDetailDto, AgentManualComponentInfo } from '@/types/interfaces/agent'
import { BindConfigWithSub } from '@/types/interfaces/common'
import { MessageInfo, ConversationInfo, ProcessingInfo } from '@/types/interfaces/conversationInfo'
import { useMarked, NodesToken as MarkdownToken } from '@/uni_modules/kux-marked'
import ParseMarkdown from '@/uni_modules/uni-ai-x/sdk/parseMarkdown.uts'

/**
 * 数据层：负责状态管理和数据存储
 */
export default class AgentDetailData {
	// 基础信息
	agentId = ref<number | null>(null)
	agentName = ref<string>('')
	agentInfo = ref<AgentDetailDto | null>(null)
	conversationId = ref<number | null>(null)
	
	// 消息相关
	messageList = ref<MessageInfo[]>([])
	chatSuggestList = ref<string[]>([])
	requestId = ref<string>('') 
	messageIdRef = ref<string>('')
	currentConversationRequestId = ref<string>('')
	
	// 会话状态
	conversationInfo = ref<ConversationInfo | null>(null)
	isSuggest = ref<boolean>(false)
	needUpdateTopicRef = ref<boolean>(true)
	isLoadingConversation = ref<boolean>(false)
	isConversationActive = ref<boolean>(false)
	
	// 组件和功能
	manualComponents = ref<AgentManualComponentInfo[]>([])
	// 已选组件列表
	selectedComponents = ref<AgentSelectedComponentInfo[]>([])
	variables = ref<BindConfigWithSub[]>([])
	userFillVariables = ref<{ [key: string]: string | number }>(null)
	requiredNameList = ref<string[]>([])
	processingList = ref<ProcessingInfo[]>([])
	messageRefs = ref<{ [key: string]: any }>({})
	
	// 滚动相关
	scrollIntoView = ref<string>('')
	scrollInBottom = ref<boolean>(true)
	scrollWithAnimation = ref<boolean>(false)
	scrollTouch = ref<boolean>(false)
	scrolling = ref<boolean>(false)
	keyboardHeight = ref<number>(0)
	
	// 弹窗引用
	refMorePopup = ref<any>(null)
	
	// 私有变量
	parseMarkdownInstance: ParseMarkdown | null = null
	sseProcessor: any = null
	autoToLastMsg = false
	scrollingT = 0
	mouseScroll = false
	needSetLockAutoToLastMsg = true
	
	// 备用Markdown解析器
	marked = useMarked()
}
