<template>
	<view class="agent-detail-container">
		<!-- 导航栏 -->
		<custom-nav-bar :title="agentInfo?.name" show-back :icon="agentInfo?.icon">
			<template v-slot:right>
				<view class="right-buttons">
					<uni-icons class="iconfont icon-More" size="50rpx" @tap="handleMorePopup"></uni-icons>
					<uni-icons class="iconfont icon-message-add" size="50rpx" @tap="createNewConversation"></uni-icons>
				</view> 
			</template>
		</custom-nav-bar>
		
		<view class="chat-container">
			<!-- 聊天内容 -->
			<view class="scroll-view-box">
				<scroll-view 
					direction="vertical"
					class="msg-list"
					:scroll-into-view="scrollIntoView"
					id="msg-list"
					:scroll-with-animation="scrollWithAnimation"
					@scroll="onScroll"
					@touchstart="scrollTouch = true"
					@touchend="scrollTouch = false"
				>
					<view class="msg-list-content">
						<template v-for="(item, index) in messageList" :key="item.id">
							<!-- 智能体会话消息 -->
							<uni-ai-x-msg
								v-if="item.messageType === MessageTypeEnum.ASSISTANT" 
								:msg="convertMessageInfoToMsgItem(item)"
								:is-last-msg="item.id === messageList?.length - 1 === index"
								:is-conversation-active="isConversationActive"
								@longpress="onlongTapMsg(convertMessageInfoToMsgItem(item))" 
								@changeThinkContent="changeThinkContent"
								:id="`msg-item-${item.id}`"
								:ref="(el) => setMessageRef(el, item.id)"
							></uni-ai-x-msg>
							<!-- 用户消息 -->
							<template v-else>
								<!-- 图片以及文件 -->
								<scroll-view 
									class="files-container" 
									v-if="item?.attachments?.length"
									direction="horizontal"
									:scroll-with-animation="true"
									:show-scrollbar="false">
									<view 
										class="files-box"
										:class="!file?.mimeType?.includes('image/') ? 'files-box-file' : 'files-box-image'"
										v-for="file in item.attachments"
										:key="file.fileKey"
										@click="onPreview(file, item?.attachments)"
									>
										<image
											class="image"
											v-if="file?.mimeType?.includes('image/')"
											:src="file?.fileUrl"
											mode="aspectFill"
										/>
										<!-- 文件 -->
										<template v-else>
											<image class="doc-image" :src="docImage" mode="aspectFill" />
											<view class="doc-info-container">
												<view class="doc-name text-ellipsis">{{ file?.fileName }}</view>
												<text class="doc-size text-ellipsis">{{ formatBytes(file?.fileSize) }}</text>
											</view>
										</template>
									</view>
								</scroll-view>
								<text class="user-msg" v-if="item?.text" @longpress="onlongTapUserMsg(item)">{{item.text}}</text>
							</template>
						</template>
					</view>
					
					<!-- 空状态内容 -->
					<view class="content" v-if="messageList?.length == 0">
						<view class="title-section">
							<markdown-msg :text="agentInfo?.openingChatMsg" />
						</view>
						<button-wrapper :buttons="agentInfo?.openingGuidQuestions || []" @button-click="handleButtonClick" />
					</view>
					
					<!-- 滚动到底部的锚点 -->
					<view style="height: 35px;" id="last-msg"></view>
				</scroll-view>
				
				<!-- 滚动到底部按钮 -->
				<view :style="{visibility: scrollInBottom || scrolling ? 'hidden' : 'visible'}" class="scroll-to-bottom" @click="scrollToLastMsg(true)">
					<uni-icons type="down" size="20" color="#555"></uni-icons>
				</view>
			</view>
			
			<!-- 输入框 -->
			<chat-input-phone
				ref="chatInputPhoneRef"
				:manual-components="agentInfo?.manualComponents || []"
				:default-selected-components="selectedComponents"
				:is-conversation-active="isConversationActive"
				:is-stopping-conversation="isStoppingConversation"
				@onSendMessage="handleSendMessage"
				@onStopConversation="handleStopConversation"
			/>
		</view>
		
		<more-popup ref="refMorePopup" :agent-info="agentInfo" @collect="handleCollect" />
	</view>
</template>

<script setup lang="uts">
	// ==================== 导入模块 ====================
	// 分层架构
	import AgentDetailData from '@/pages/agent-detail/layers/AgentDetailData.uts'
	import AgentDetailService from '@/pages/agent-detail/layers/AgentDetailService.uts'
	import ComponentManager from '@/pages/agent-detail/layers/ComponentManager.uts'
	import ScrollManager from '@/pages/agent-detail/layers/ScrollManager.uts'
	
	// 类型定义
	import { MessageTypeEnum } from '@/types/enums/agent'
	import { apiAgentConversation } from '@/servers/conversation'
	import { SUCCESS_CODE } from '@/constants/codes.constants'
	import type { ChatInputPhoneRef } from '@/types/interfaces/chat.uts'
	import type { MessageInfo } from '@/types/interfaces/conversationInfo.uts'
	
	// 组件
	import MorePopup from '@/pages/agent-detail/components/more-popup/more-popup.uvue'
	import ChatInputPhone from '@/components/chat-input-phone/chat-input-phone.uvue'

	// 常量
	import { CONVERSATION_PAYLOAD } from '@/constants/common.constants'
	import { AttachmentFile } from '@/types/interfaces/conversationInfo.uts';
	import docImage from '@/static/assets/doc_image.png';
  import { formatBytes } from '@/utils/byteConverter.uts';

	// 定义 chat-input-phone 组件的引用
	const chatInputPhoneRef = ref<ChatInputPhoneRef | null>(null)

	// ==================== 初始化分层架构 ====================
	// 创建各层实例
	const data = new AgentDetailData()
	const service = new AgentDetailService(data)
	const componentManager = new ComponentManager(data)
	const scrollManager = new ScrollManager(data)

	// ==================== 暴露方法给模板 ====================
	
	// 数据层
	const {
		agentId, agentName, agentInfo, conversationId,
		messageList, chatSuggestList, requestId, messageIdRef,
		conversationInfo, isSuggest, needUpdateTopicRef,manualComponents, selectedComponents, variables,
		userFillVariables, requiredNameList, processingList,
		scrollIntoView, scrollInBottom, scrollWithAnimation,
		scrollTouch, scrolling, keyboardHeight, refMorePopup, isStoppingConversation, isConversationActive
	} = data

	// 服务层 - 使用箭头函数保持this上下文
	const handleQueryConversation = (...args: any[]) => service.handleQueryConversation(...args)
	const handleChangeMessageList = (...args: any[]) => service.handleChangeMessageList(...args)
	const handleConversation = (...args: any[]) => service.handleConversation(...args)
	// 发送消息
	const handleSendMessage = (...args: any[]) => service.handleSendMessage(...args)
	// 停止会话
	const handleStopConversation = () => service.handleStopConversation()
	const createNewConversation = (...args: any[]) => service.createNewConversation(...args)
	const getPublishedAgentInfo = (...args: any[]) => service.getPublishedAgentInfo(...args)
	const handleCollect = (...args: any[]) => service.handleCollect(...args)
	
	// 其他服务方法包装
	const initParseMarkdown = () => service.initParseMarkdown()

	// 组件管理层 - 使用箭头函数保持this上下文
	const setMessageRef = (...args: any[]) => componentManager.setMessageRef(...args)
	const removeMessageRef = (...args: any[]) => componentManager.removeMessageRef(...args)
	const updateMessageComponent = (...args: any[]) => componentManager.updateMessageComponent(...args)
	const convertMessageInfoToMsgItem = (...args: any[]) => componentManager.convertMessageInfoToMsgItem(...args)

	// 滚动管理层 - 使用箭头函数保持this上下文
	const scrollToLastMsg = (...args: any[]) => scrollManager.scrollToLastMsg(...args)
	const setIsInScrollBottom = (...args: any[]) => scrollManager.setIsInScrollBottom(...args)
	const lockAutoToLastMsg = (...args: any[]) => scrollManager.lockAutoToLastMsg(...args)
	const onScroll = (...args: any[]) => scrollManager.onScroll(...args)

	// ==================== 视图层方法 (原ViewManager逻辑) ====================
	/**
	 * 处理更多弹窗
	 */
	const handleMorePopup = (): void => {
		if (data.refMorePopup.value) {
			nextTick(() => {
				data.refMorePopup.value?.open()
			})
		}
	}

	/**
	 * 处理功能按钮点击
	 */
	const handleButtonClick = (guideQuestion: string): void => {
		const params = {
			messageInfo: guideQuestion,
			files: chatInputPhoneRef.value?.files || [],
			selectedComponents: chatInputPhoneRef.value?.selectedComponents || [],
		}

		handleSendMessage(params);
	}

	// 预览图片
	const onPreview = (file: AttachmentFile, attachments: AttachmentFile[]) => {
		if (!file.mimeType.includes('image/')) {
      uni.showToast({
        title: '当前不支持预览该类型文件',
        icon: 'none',
        duration: 1500
      })
      return
    }
		const urls = attachments?.filter(f => f.mimeType.includes('image/'))?.map(f => f.fileUrl) || []
		if (urls.length > 0 && file?.fileUrl) {
    	uni.previewImage({
        urls,
        current: file.fileUrl,
      });
    }
  };

	/**
	 * 长按消息处理
	 */
	const onlongTapMsg = (item: any): void => {
		// 显示操作菜单
	}

	/**
	 * 长按用户消息处理 - 复制文本
	 */
	const onlongTapUserMsg = (item: MessageInfo): void => {
		if (!item.text) {
			return
		}
		uni.setClipboardData({
			data: item.text,
			success: () => {
				uni.showToast({
					title: '已复制',
					icon: 'none',
					duration: 2000
				})
			}
		})
	}

	/**
	 * 思考内容变化处理
	 */
	const changeThinkContent = (hideThinkContent: boolean): void => {
		setIsInScrollBottom()
	}

	/**
	 * 键盘高度变化处理
	 */
	const onKeyboardheightchange = (res: UniInputKeyboardHeightChangeEvent): void => {
		data.keyboardHeight.value = res.detail.height
	}

	// ==================== 设置监听器 ====================
	// 滚动相关监听器
	watch(data.scrollInBottom, () => {
		// 可以在这里添加渲染控制逻辑
	}, { immediate: true })
	
	watch(data.scrolling, () => {
		// 可以在这里添加渲染控制逻辑
	}, { immediate: true })
	
	watch(computed(() => data.conversationId.value?.toString() || ''), () => {
		scrollToLastMsg(false)
		nextTick(() => {
			if (data.messageList.value.length > 0) {
				const lastMessage = data.messageList.value[data.messageList.value.length - 1]
				// 这里可以添加渲染标记逻辑
			}
		})
	}, { deep: true, immediate: true })
	
	watch(data.messageList, async () => {
		setIsInScrollBottom()
		lockAutoToLastMsg()
		if (!data.scrollTouch.value && data.autoToLastMsg) {
			await nextTick()
			scrollToLastMsg(false)
		}
	}, { deep: true })

	// ==================== 计算属性 ====================
	const state = computed<string>(() => 'none')
	const chatInputContent = ref<string>('')
	const chatActiveId = computed<string>(() => data.conversationId.value?.toString() || '')
	const chatTitle = computed<string>(() => data.agentName.value || '新对话')

	// ==================== 页面加载处理 ====================
	/**
	 * 处理页面加载
	 */
	const handlePageLoad = async (params): Promise<void> => {
		// 智能体id
		data.agentId.value = params.id ? Number(params.id) : ''
		// 从缓存中获取payload数据
		const payload = uni.getStorageSync(CONVERSATION_PAYLOAD)
		const payloadData = payload ? JSON.parse(payload) : {}
		// 消息信息
		const messageInfo = payloadData.messageInfo || ''
		// 文件信息
		const files = payloadData.files || []
		// 组件列表
		const _selectedComponents = payloadData.selectedComponents || []
		data.selectedComponents.value = _selectedComponents

		initParseMarkdown()
    // 如果存在会话id，则初始化ParseMarkdown，查询历史会话信息
		if (params.conversationId) {
			const id = Number(params.conversationId)
			data.conversationId.value = id
			// 查询历史会话信息
			const res = await apiAgentConversation(id)
			if (res.code === SUCCESS_CODE) {
				// 处理消息列表
				handleQueryConversation(res)
			}
			// 查询智能体详情信息
			getPublishedAgentInfo()
		} else {
			// 查询智能体详情信息，并初始化会话id
			getPublishedAgentInfo(true, {
				messageInfo,
				files,
				selectedComponents: _selectedComponents
			})
		}
	}

	// ==================== 生命周期 ====================
	onLoad(async (params) => {
		await handlePageLoad(params)
	})

	// 设置事件监听器
	onMounted(() => {
		uni.$on('updateMessageComponent', (eventData: any) => {
			updateMessageComponent(eventData.messageId, eventData.data)
		})
	})
	
	// 清理事件监听器
	onUnmounted(() => {
		uni.$off('updateMessageComponent')
		uni.removeStorageSync(CONVERSATION_PAYLOAD)
	})
</script>

<style lang="scss" scoped>
	@import './styles/agent-detail.scss';
</style>