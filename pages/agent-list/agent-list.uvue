<template>
  <view class='container'>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <view class='header'>
      <view class='menu-box' @click="handleMenuClick">
        <uni-icons class="iconfont icon-Menu" size="48rpx"></uni-icons>
      </view>
      <text class='title'>æ™ºèƒ½ä½“</text>
      <view class='header-right'></view>
    </view>

    <!-- æœç´¢æ¡† -->
    <view class='search-container'>
      <view class='search-box'>
        <text class='search-icon'>ğŸ”</text>
        <input
          class='search-input'
          placeholder='æœç´¢æ™ºèƒ½ä½“'
          :value="searchKeyword"
          @input="handleSearch($event.detail.value)"
        />
        <template v-if="searchKeyword">
          <text 
            class='clear-icon'
            @click="handleSearch('')"
          >
            âœ•
        </text>
        </template>
      </view>
    </view>

    <!-- åˆ†ç±»å¯¼èˆª -->
    <view class='category-nav'>
      <scroll-view 
        class='category-scroll'
        direction="horizontal"
        :scroll-with-animation="true"
        :scroll-into-view="scrollIntoView"
        :show-scrollbar="false"
      >
        <view
          :id="category.key"
          v-for="(category, index) in categories" 
          :key="category.key"
          :class="`category-item ${activeCategory === category.key ? 'active' : ''}`"
          @click="handleCategoryClick(category.key, index)"
        >
          <text class='category-text'>{{ category.label }}</text>
        </view>
      </scroll-view>
    </view>

    <!-- æ¨å¹¿æ¨ªå¹… -->
    <view class='banner'>
      <view class='banner-content'>
        <text class='banner-title'>äººäººéƒ½æ˜¯æ™ºèƒ½è®¾è®¡å¸ˆ</text>
        <text class='banner-desc'>
          æ–°ä¸€ä»£AIåº”ç”¨è®¾è®¡ã€å¼€å‘ã€å®è·µå¹³å°,æ— éœ€ä»£ç ,è½»æ¾åˆ›å»º,é€‚åˆå„ç±»äººç¾¤,æ”¯æŒå¤šç§ç«¯å‘å¸ƒåŠAPI
        </text>
      </view>
    </view>

    <!-- æ»šåŠ¨éƒ¨åˆ† -->
    <view class='scroll-section'>
      <swiper 
        class='agent-swiper'
        :current="activeSwiperIndex"
        @change="handleSwiperChange"
        :indicator-dots="false"
      >
          <template v-for="category in categories" :key="category.key">
            <swiper-item class='swiper-item'>
              <scroll-view 
                class='agent-scroll'
                @scrolltolower="handleLoadMore"
                :refresher-enabled="true"
                :refresher-triggered="refreshingMap[category.key] || false"
                @refresherrefresh="handleRefresh"
                :show-scrollbar="false"
              >
                <view class='agent-list-container'>
                  <template v-if="(agentListMap[category.key] || []).length">
                    <template v-for="info in agentListMap[category.key]" :key="info.id">
                      <!-- #ifdef H5 -->
                       <component :is="AgentComponent" :agentInfo="info" @click="handleAgentClick(info)" />
                      <!-- #endif -->
                      <!-- #ifdef MP-WEIXIN -->
                       <agent-component :agentInfo="info" @click="handleAgentClick(info)" />
                      <!-- #endif -->
                    </template>
                  </template>

                  <template v-else-if="!loadingMap[category.key]">
                    <view class='empty-state'>
                      <text class='empty-text'>æš‚æ— æ•°æ®</text>
                    </view>
                  </template>

                  <template v-else>
                    <view class='loading-state'>
                      <text class='loading-text'>åŠ è½½ä¸­...</text>
                    </view>
                  </template>
                 
                 <template v-if="!loadingMap[category.key] && !hasMoreMap[category.key] && (agentListMap[category.key] || []).length">
                   <view class='no-more-state'>
                     <text class='no-more-text'>æ²¡æœ‰æ›´å¤šæ•°æ®äº†</text>
                   </view>
                 </template>
              </view>
            </scroll-view>
          </swiper-item>
        </template>
      </swiper>
    </view>
  </view>
</template>

<script setup lang="uts">
  import { CONST_ALL } from '@/constants/common.constants'
  import { SquarePublishedItemInfo } from '@/types/interfaces/square'
  import { apiPublishedCategoryList } from '@/servers/square'
  import { SUCCESS_CODE } from '@/constants/codes.constants'
  import { SquareCategoryInfo } from '@/types/interfaces/square'
  import { SquareAgentTypeEnum } from '@/types/enums/square'
  import { AgentComponentTypeEnum } from '@/types/enums/agent'
  import { apiPublishedAgentList } from '@/servers/square'
  import { SquarePublishedListParams } from '@/types/interfaces/square'
  import { Page } from '@/types/interfaces/request'
  import { RequestResponse } from '@/types/interfaces/request'
  import AgentComponent from '@/components/agent-component/agent-component.uvue'

  // å½“å‰åˆ†ç±»
  const activeCategory = ref<string>(CONST_ALL)
  // å½“å‰swiperç´¢å¼•
  const activeSwiperIndex = ref<number>(0)
  // åˆ†ç±»åˆ—è¡¨
  const categories = ref<{ key: string, label: string, active: boolean }[]>([])
  // æ™ºèƒ½ä½“åˆ—è¡¨
  const agentListMap = ref<{ [key: string]: SquarePublishedItemInfo[] }>({})
  // åŠ è½½çŠ¶æ€
  const loadingMap = ref<{ [key: string]: boolean }>({})
  // åˆ·æ–°çŠ¶æ€
  const refreshingMap = ref<{ [key: string]: boolean }>({})
  // é¡µç 
  const pageMap = ref<{ [key: string]: number }>({})
  // æ˜¯å¦è¿˜æœ‰æ›´å¤š
  const hasMoreMap = ref<{ [key: string]: boolean }>({})
  // æœç´¢å…³é”®è¯
  const searchKeyword = ref<string>('');
  // æ»šåŠ¨åˆ°å¯¹åº”çš„åˆ†ç±»æ ‡ç­¾
  const scrollIntoView = ref<string>('')
  // æœç´¢å®šæ—¶å™¨
  const searchTimeoutRef = ref<number | null>(null)

  // è·å–åˆ†ç±»åˆ—è¡¨
  const fetchCategories = async () => {
    const response = await apiPublishedCategoryList()
    const { code, data } = response as unknown as RequestResponse<SquareCategoryInfo[]>
    if (code === SUCCESS_CODE) {
      // è·å–æ™ºèƒ½ä½“åˆ†ç±»åˆ—è¡¨
      const agentCategoryList = data.find((item: SquareCategoryInfo) => item.type === SquareAgentTypeEnum.Agent)?.children || [];
      // è½¬æ¢ä¸ºåˆ†ç±»åˆ—è¡¨
      const categoryData = agentCategoryList.map((item: SquareCategoryInfo) => ({
        key: item.key,
        label: item.label,
        active: false,
      }))
      categories.value = [{ key: CONST_ALL, label: 'å…¨éƒ¨', active: true }, ...categoryData]
    } else {
      uni.showToast({
        title: 'è·å–åˆ†ç±»ä¿¡æ¯å¤±è´¥',
        icon: 'error'
      })
    }
  }

  // è·å–æ™ºèƒ½ä½“åˆ—è¡¨
  const fetchAgentList = async (category: string = CONST_ALL, pageNum: number = 1, keyword: string = searchKeyword.value) => {
    if (loadingMap[category]) return
    // è®¾ç½®åŠ è½½çŠ¶æ€
    loadingMap.value = { ...loadingMap.value, [category]: true }
    const params: SquarePublishedListParams = {
      targetType: AgentComponentTypeEnum.Agent,
      page: pageNum,
      pageSize: 10,
      category: category === CONST_ALL ? '' : category,
      kw: keyword,
    }
    // è·å–æ™ºèƒ½ä½“åˆ—è¡¨
    const response  = await apiPublishedAgentList(params)
    const {code, data, message}  = response as unknown as RequestResponse<Page<SquarePublishedItemInfo>>
    // æˆåŠŸ
    if (code === SUCCESS_CODE) {
      const newList = data.records || []
      if (pageNum > 1) {
        agentListMap.value = { ...agentListMap.value, [category]: [...(agentListMap.value[category] || []), ...newList] }
      } else {
        agentListMap.value = { ...agentListMap.value, [category]: newList }
      }
      hasMoreMap.value = { ...hasMoreMap.value, [category]: newList.length === 10 }
      pageMap.value = { ...pageMap.value, [category]: pageNum }
    } else {
      uni.showToast({
        title: message || 'è·å–æ™ºèƒ½ä½“åˆ—è¡¨å¤±è´¥',
        icon: 'error'
      })
    }
    loadingMap.value = { ...loadingMap.value, [category]: false }
  }

  onLoad(() => {
    // è·å–åˆ†ç±»åˆ—è¡¨
    fetchCategories()
    // é¢„åŠ è½½ç¬¬ä¸€ä¸ªåˆ†ç±»çš„æ•°æ®
    fetchAgentList()
  })

  onUnload(() => {
    if (searchTimeoutRef.value) {
      clearTimeout(searchTimeoutRef.value)
    }
  })

  // ç‚¹å‡»èœå•æŒ‰é’® todo
  const handleMenuClick = () => {
    uni.navigateTo({
      url: '/pages/home/home'
    })
  }

  // ç‚¹å‡»æ™ºèƒ½ä½“åˆ†ç±»æ ‡ç­¾
  const handleCategoryClick = (key: string, index: number) => {
    // å½“å‰åˆ†ç±»
    activeCategory.value = key
    // å½“å‰swiperç´¢å¼•
    activeSwiperIndex.value = index
    // æ»šåŠ¨åˆ°å¯¹åº”çš„åˆ†ç±»æ ‡ç­¾
    scrollIntoView.value = key;
    
    // å¦‚æœè¯¥åˆ†ç±»è¿˜æ²¡æœ‰æ•°æ®ï¼Œåˆ™åŠ è½½æ•°æ®
    if (!agentListMap[key] || agentListMap[key].length === 0) {
      pageMap.value = { ...pageMap.value, [key]: 1 }
      hasMoreMap.value = { ...hasMoreMap.value, [key]: true }
      fetchAgentList(key)
    }
  }

    // å¤„ç†Swiperåˆ‡æ¢
    const handleSwiperChange = (e: UniSwiperChangeEvent) => {
    const index = e.detail.current
    const category = categories.value[index]
    if (category && category.key !== activeCategory.value) {
      // å½“å‰åˆ†ç±»
      activeCategory.value = category.key
      // å½“å‰swiperç´¢å¼•
      activeSwiperIndex.value = index

      // æ»šåŠ¨åˆ°å¯¹åº”çš„åˆ†ç±»æ ‡ç­¾
      const id = categories.value[index].key
      scrollIntoView.value = id;

      // å¦‚æœè¯¥åˆ†ç±»è¿˜æ²¡æœ‰æ•°æ®ï¼Œåˆ™åŠ è½½æ•°æ®
      if (!agentListMap[category.key] || agentListMap[category.key].length === 0) {
        pageMap.value = { ...pageMap.value, [category.key]: 1 }
        hasMoreMap.value = { ...hasMoreMap.value, [category.key]: true }
        fetchAgentList(category.key)
      }
    }
  }

   // å¤„ç†æœç´¢
   const handleSearch = (keyword: string) => {
    searchKeyword.value = keyword
    
    // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
    if (searchTimeoutRef.value) {
      clearTimeout(searchTimeoutRef.value)
    }
    
    // è®¾ç½®æ–°çš„å®šæ—¶å™¨ï¼Œé˜²æŠ–500ms
    searchTimeoutRef.value = setTimeout(() => {
      pageMap.value = { ...pageMap.value, [activeCategory.value]: 1 }
      hasMoreMap.value = { ...hasMoreMap.value, [activeCategory.value]: true }
      fetchAgentList(activeCategory.value, 1, keyword)
    }, 500)
  }

  // è·³è½¬åˆ°æ™ºèƒ½ä½“è¯¦æƒ…é¡µ
  const handleAgentClick = (agent: SquarePublishedItemInfo) => {
    uni.navigateTo({
      url: `/pages/agent-detail/agent-detail?id=${agent.id}`
    })
  }

  // ä¸‹æ‹‰åˆ·æ–°
  const handleRefresh = () => {
    if (refreshingMap.value[activeCategory.value]) {
      return
    }
    refreshingMap.value = { ...refreshingMap.value, [activeCategory.value]: true }
    pageMap.value = { ...pageMap.value, [activeCategory.value]: 1 }
    hasMoreMap.value = { ...hasMoreMap.value, [activeCategory.value]: true }
    fetchAgentList(activeCategory.value).finally(() => {
      refreshingMap.value = { ...refreshingMap.value, [activeCategory.value]: false }
    })
  }

  // åŠ è½½æ›´å¤š
  const handleLoadMore = () => {
    const currentPage = pageMap.value[activeCategory.value] || 1
    const currentHasMore = hasMoreMap.value[activeCategory.value] !== false
    const currentLoading = loadingMap.value[activeCategory.value]
    
    if (currentHasMore && !currentLoading) {
      fetchAgentList(activeCategory.value, currentPage + 1)
    }
  }
</script>

<style lang="scss" scoped>
	.container {
		height: 100vh;
		display: flex;
		flex-direction: column;
		overflow: hidden;
		background-color: #fff;
		/* #ifdef MP-WEIXIN */
		padding-top: env(safe-area-inset-top);
		padding-bottom: env(safe-area-inset-bottom);
		/* #endif */

    /* é¡¶éƒ¨å¯¼èˆªæ  */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-direction: row;
      padding: 8rpx 16rpx;
      /* #ifdef MP-WEIXIN */
      padding-top: calc(var(--status-bar-height) + 22px);
      /* #endif */
    
      .menu-box {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 80rpx;
        height: 80rpx;
      }
    
      .title {
        font-size: 32rpx;
        font-weight: 600;
        color: #15171F;
        flex: 1;
        text-align: center;
      }
    
      .header-right {
        width: 80rpx;
        height: 80rpx;
      }
    }
    
    /* æœç´¢æ¡† */
    .search-container {
      padding: 24rpx 32rpx;
      flex-shrink: 0;
    
      .search-box {
        display: flex;
        align-items: center;
        flex-direction: row;
        background-color: #f5f5f5;
        border-radius: 20rpx;
        padding: 16rpx 24rpx;
        position: relative;
    
        .search-icon {
          font-size: 32rpx;
          color: #999;
          margin-right: 16rpx;
        }
        
        .search-input {
          flex: 1;
          border: none;
          background: transparent;
          font-size: 28rpx;
          color: #333;
          outline: none;
    
          &::placeholder {
            color: #999;
          }
        }
    
        .clear-icon {
          font-size: 28rpx;
          color: #999;
          cursor: pointer;
          padding: 4rpx;
          border-radius: 50%;
          transition: all 0.3s ease;
    
          &:hover {
            background-color: #e8e8e8;
            color: #666;
          }
        }
      }
    }
    
    .category-nav {
      padding: 0 32rpx;
    
      /* åˆ†ç±»å¯¼èˆª */
      .category-scroll {
        white-space: nowrap;
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;

        height: 112rpx;
        gap: 16rpx; 
        display: flex;
        align-items: center;
        flex-direction: row;
      }

      .category-item {
        display: flex;
        justify-content: center;
        height: 80rpx;
        padding: 0 32rpx;
        border-radius: 16rpx;
        cursor: pointer;
        transition: all 0.3s ease;
        user-select: none;
        color: #5E6470;
        font-size: 32rpx;
        font-weight: 400;
      
        &.active {
          background-color: #F2F2FF;
      
          .category-text {
            color: #5147FF;
          }
        }
      
        .category-text {
          font-size: 32rpx;
          font-weight: 400;
          color: #5E6470;
          transition: color 0.3s ease;
        }
      }
    }
    
    /* æ¨å¹¿æ¨ªå¹… */
    .banner {
      margin: 32rpx;
      border-radius: 24rpx;
      overflow: hidden;
      background: linear-gradient(135deg, #8b5cf6 0%, #f97316 100%);
      box-shadow: 0 4rpx 12rpx rgba(139, 92, 246, 0.3);
      flex-shrink: 0;
    
      .banner-content {
        padding: 40rpx;
        color: #fff;
      }
    
      .banner-title {
        display: block;
        font-size: 36rpx;
        font-weight: 600;
        margin-bottom: 16rpx;
        line-height: 1.4;
      }
    
      .banner-desc {
        display: block;
        font-size: 26rpx;
        line-height: 1.5;
        opacity: 0.9;
      }
    }
    
    /* æ»šåŠ¨éƒ¨åˆ† */
    .scroll-section {
      flex: 1;
      overflow: hidden;
    
      /* æ™ºèƒ½ä½“åˆ—è¡¨ */
      .agent-swiper {
        height: 100%;
      }
    
      .swiper-item {
        height: 100%;
        overflow: hidden;
      }
    
      .agent-scroll {
        height: 100%;
      }
    
      .agent-list-container {
        padding: 0 16rpx 40rpx 16rpx;
      }
    }
    
    /* ç©ºçŠ¶æ€ */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 160rpx 40rpx;
      text-align: center;
    }
    
    .empty-text {
      font-size: 28rpx;
      color: #999;
      margin-top: 32rpx;
    }
    
    /* åŠ è½½çŠ¶æ€ */
    .loading-state {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40rpx;
    }
    
    .loading-text {
      font-size: 28rpx;
      color: #666;
      display: flex;
      align-items: center;
    }
    
    .loading-text::before {
      content: '';
      width: 32rpx;
      height: 32rpx;
      border: 4rpx solid #e8e8e8;
      border-top: 4rpx solid #8b5cf6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 16rpx;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* æ²¡æœ‰æ›´å¤šæ•°æ®çŠ¶æ€ */
    .no-more-state {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40rpx;
    }
    
    .no-more-text {
      font-size: 24rpx;
      color: #999;
    }
	}
</style>
