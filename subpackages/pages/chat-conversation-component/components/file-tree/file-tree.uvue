<template>
  <menu-popup ref="popupFileTreeRef" direction="bottom" height="85vh">
    <view class="file-tree">
      <file-tree-node
        v-for="node in fileList"
        :key="node.id"
        :node="node"
        :level="0"
        :expanded-folders="expandedFolders"
        :selected-file-id="selectedFileId"
        @toggle-folder="handleToggleFolder"
        @select-file="handleSelectFile"
      />
    </view>
  </menu-popup>
</template>

<script setup lang="uts">
  import MenuPopup from '@/components/menu-popup/menu-popup.uvue'
  import { ref } from 'vue'
  import type { FileNode } from '@/types/interfaces/agent'
  import { apiGetFileTreeList } from '@/servers/agentDev'
  import { SUCCESS_CODE } from '@/constants/codes.constants'
  import { transformFlatListToTree } from '@/subpackages/utils/fileTree'
  import FileTreeNode from './file-tree-node.uvue'

  // 文件树弹窗引用
  const popupFileTreeRef = ref<any>(null)
  
  // 文件列表
  const fileList = ref<FileNode[]>([])
  // 已展开的文件夹ID集合
  const expandedFolders = ref<Set<string>>(new Set())
  // 选中的文件ID
  const selectedFileId = ref<string>('')

  /**
   * 切换文件夹展开/收起
   */
  const handleToggleFolder = (folderId: string) => {
    const newExpanded = new Set(expandedFolders.value)
    if (newExpanded.has(folderId)) {
      newExpanded.delete(folderId)
    } else {
      newExpanded.add(folderId)
    }
    expandedFolders.value = newExpanded
  }

  /**
   * 选择文件
   */
  const handleSelectFile = (fileId: string) => {
    selectedFileId.value = fileId
  }

  // 获取文件树列表
  const getFileList = async (projectId: string) => {
    const result = await apiGetFileTreeList(projectId)
    if (result.code === SUCCESS_CODE) {
      const { files } = result.data || {};

      let treeData: FileNode[] = [];

      // 检查是否是新的扁平格式
      if (Array.isArray(files) && files.length > 0 && files[0].name) {
        treeData = transformFlatListToTree(files);
      } else if (Array.isArray(files)) {
        // 如果是原有的树形格式，直接使用
        treeData = files as FileNode[];
      }

      fileList.value = treeData
      
      // 默认展开第一个文件夹
      if (treeData.length > 0 && treeData[0].type === 'folder') {
        expandedFolders.value = new Set([treeData[0].id])
      }
    }
  }

  onLoad(async () => {
    await getFileList('5022159017283584')
  })

  // 打开文件树弹窗
  const open = () => {
    popupFileTreeRef.value?.open()
  }

  // 关闭文件树弹窗
  const close = () => {
    popupFileTreeRef.value?.close()
  }

  // 暴露文件树弹窗引用
  defineExpose({
    open,
    close,
  })
</script>

<style scoped lang="scss">
  // .file-tree-header {
  //   padding: 24rpx 32rpx;
  //   border-bottom: 1rpx solid #e5e5e5;
    
  //   .file-tree-header-title {
  //     font-size: 32rpx;
  //     font-weight: 600;
  //     color: #333;
  //   }
  // }

  .file-tree {
    // padding: 16rpx 0;
    max-height: calc(85vh - 100rpx);
    overflow-y: auto;
  }
</style>