<template>
	<view class="container relative flex flex-col">
		<!-- 顶部导航栏 -->
		<custom-nav-bar title="智联录"></custom-nav-bar>
		<!-- 团队列表 -->
		<scroll-view
			class="flex-1 overflow-hide" 
			direction="vertical"
			:scroll-with-animation="true"
			:show-scrollbar="false" 
			:scroll-into-view="anchor">
			<template v-if="loading">
				<view class="flex content-center items-center h-full">
					<l-loading text="加载中..." />
				</view>
			</template>
			<template v-else>
				<!-- 顶部导航栏 -->
				<view
					v-for="category in homeCategoryInfo.categories"
					:key="category.type"
					class="flex flex-row items-center content-between category-box"
					hover-class="category-box-active"
					@click="handleCategoryClick(category.type)">
						<view class="flex-1 category-name text-ellipsis">{{ category.name }}</view>
						<view class="flex flex-row items-center gap-4 count-box">
							<text class="text-sm">{{ homeCategoryInfo?.categoryItems?.[category.type]?.length || 0 }}</text>
							<text class="iconfont icon-a-Chevronright"></text>
						</view>
				</view>
				<!-- 智能体列表 -->
				<view v-for="group in categoryList" :key="group.key" class="group" :id="'id-'+group.key">
					<view class="group__title">{{ group.label }}</view>
					<view v-for="item in group.children" :key="item.targetId" class="flex flex-row items-center item-card" hover-class="item-card-active" @click="handleAgentClick(item)">
						<image class="item-card__icon" :src="getImageSrc(item.targetId, item.icon)" mode="aspectFill" @error="handleImageError(item.targetId)" />
						<view class="item-card__content">
							<text class="item-card__name text-ellipsis">{{ item.name }}</text>
							<text class="item-card__desc text-ellipsis">{{ item.description}}</text>
						</view>
					</view>
				</view>
			</template>
		</scroll-view>
		<!-- 右侧字母导航栏 -->
		<view class="right-bar">
			<view class="right-bar__item" v-for="L in letters" :key="L" @click="scrollToSection(L)">
				<text>{{ L }}</text>
			</view>
		</view>
	</view>
</template>

<script setup lang="uts">
	import { SUCCESS_CODE } from '@/constants/codes.constants.uts'
	import { HOME_CATEGORY_INFO } from '@/constants/common.constants.uts'
	import { apiHomeCategoryList } from '@/servers/agentDev'
	import { HomeAgentCategoryInfo, CategoryItemInfo } from '@/types/interfaces/agentConfig'
	import { pinyin } from "@/utils/pinyin.uts";
	import agentImage from '@/static/assets/agent_image.png'
	import { jumpToAgentDetailPage } from '@/utils/commonBusiness'

	const letters = ref<string[]>([])
	const anchor = ref<string>('')
	const loading = ref<boolean>(false)
	// 所有分类下的智能体列表，并且去重
	const categoryList = ref<{ label: string; key: string; children: CategoryItemInfo[] }[]>([])
	// 分类信息，包括每一项分类下的智能体列表
	const homeCategoryInfo = ref<HomeAgentCategoryInfo>({
		// 首页分类
		categories: [],
		// 首页分类数据列表
		categoryItems: {}
	})

	// 记录加载失败的图片ID
	const failedImageIds = reactive<Set<string>>(new Set())

	/**
	 * 获取图片源地址
	 * @param id 智能体ID
	 * @param originalIcon 原始图片地址
	 * @returns 图片地址（加载失败则返回默认图片）
	 */
	const getImageSrc = (id: string, originalIcon: string): string => {
		return failedImageIds.has(id) ? agentImage : originalIcon
	}

	/**
	 * 图片加载错误时触发，切换为默认图片
	 * @param id 智能体ID
	 */
	const handleImageError = (id: string) => {
		failedImageIds.add(id)
	}

	// 根据智能体列表的name字段首字母进行分组，并排序呢
	const groupByFirstLetterList = (list: CategoryItemInfo[]) => {
		const grouped: Record<string, CategoryItemInfo[]> = list.reduce((acc, item) => {
			const firstChar = item.name?.charAt(0) || ''
			// 获取首字母的拼音（大写）
			const firstLetter = pinyin(firstChar, { pattern: 'first', tone: 'none' }).toUpperCase()
			
			if (!acc[firstLetter]) {
				acc[firstLetter] = []
			}
			acc[firstLetter].push(item)
			return acc
		}, {})
		
		// 获取按字母排序的键
		const sortedKeys = Object.keys(grouped).sort((a, b) => a.localeCompare(b))
		// 将首字母添加到字母列表中
		letters.value = sortedKeys
		
		// 转换为指定数组格式，并对每个 children 按完整拼音排序
		const formattedList = sortedKeys.map(key => {
			// 对 children 按 name 的完整拼音排序
			const sortedChildren = grouped[key].sort((a, b) => {
				const pinyinA = pinyin(a.name, { pattern: 'pinyin', tone: 'none' }).replace(/\s/g, '').toLowerCase()
				const pinyinB = pinyin(b.name, { pattern: 'pinyin', tone: 'none' }).replace(/\s/g, '').toLowerCase()
				return pinyinA.localeCompare(pinyinB)
			})
			
			return {
				label: key,
				key: key,
				children: sortedChildren
			}
		})
		
		return formattedList  // 返回结果
	}

	// 点击分类标签的逻辑
	const handleCategoryClick = (categoryKey: string) => {
		uni.navigateTo({
			url: `/subpackages/category-agent-list/category-agent-list?categoryKey=${categoryKey}`
		})
	}

	// 点击智能体
	const handleAgentClick = (info: AgentInfo) => {
		jumpToAgentDetailPage(info.targetId)
	}

	// 滚动到对应字母分组的逻辑
	const scrollToSection = (letter: string) => {
		// 实现滚动到对应字母分组的逻辑
		anchor.value = 'id-' + letter
	}

	// 主页智能体列表接口
	const fetchHomeCategoryList = async () => {
		const response = await apiHomeCategoryList()
		const { code, data, message } = response || {}
		if (code === SUCCESS_CODE) {
			homeCategoryInfo.value = data
			uni.setStorageSync(HOME_CATEGORY_INFO, JSON.stringify(data))
			const { categoryItems } = data || {}
			// 判断数据是否为对象，并且有值
			if (categoryItems && typeof categoryItems === 'object' && Object.keys(categoryItems).length > 0) {
				// 获取所有分类下的智能体列表，并且扁平化为一维数组
				const allCategoryItems = Object.values(categoryItems).flat()

				// map + values 去重
				const uniqueCategoryItems = Array.from(new Map(allCategoryItems.map(item => [item.targetId, item])).values())

				// 根据智能体列表的name字段首字母进行分组，并排序呢
				categoryList.value = groupByFirstLetterList(uniqueCategoryItems)
			}
		} else {
			uni.showToast({
				title: message || '获取主页智能体列表失败',
				icon: 'none'
			})
		}
		loading.value = false
	}

	onPageShow(() => {
		loading.value = true
		fetchHomeCategoryList()
	})
</script>

<style lang="scss" scoped>
.container {
	height: 100vh;  // 假设全屏

	.category-box {
		gap: 50rpx;
		padding: 24rpx 32rpx;
		border-bottom: 1rpx solid rgba(12, 20, 102, 0.04);
		transition: background-color 0.3s ease;

		&-active {
			background-color: rgba(12, 20, 102, 0.04);
		}

		.category-name {
			font-size: 32rpx;
			font-weight: 400;
			color: rgb(51, 51, 51);
		}
	}

	.count-box {
		font-size: 32rpx;
		color: #666;

		.iconfont {
			font-size: 28rpx;
			color: #999;
		}
	}

	.group {
		&__title {
			padding: 20rpx 32rpx;
			font-size: 32rpx;
			font-weight: bold;
			background-color: #f5f5f5;
			color: #333;
		}
	}

	.item-card {
		display: flex;
		align-items: center;
		padding: 24rpx 32rpx;
		border-bottom: 1px solid rgba(12, 20, 102, 0.04);

		&-active {
			background-color: rgba(12, 20, 102, 0.04);
		}
		
		&__icon {
			width: 80rpx;
			height: 80rpx;
			border-radius: 50%;
			margin-right: 24rpx;
		}
		
		&__content {
			flex: 1;
		}
		
		&__name {
			font-size: 32rpx;
			color: #333;
		}
		
		&__desc {
			font-size: 24rpx;
			color: #999;
			margin-top: 8rpx;
		}
		
		&__count {
			font-size: 28rpx;
			color: #666;
		}
	}

	.right-bar {
		position: absolute;
		right: 32rpx;
		bottom: 160rpx;
		width: 50rpx;
		max-height: 50%;
		padding: 20rpx 0;
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		gap: 8rpx;
		border-radius: 20rpx;
		overflow: hidden;
		z-index: 100;
		background-color: #f5f5f5;

		&__item {
			width: 40rpx;
			height: 40rpx;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 28rpx;
			color: #666;
			border-radius: 50%;
		}
	}
}
</style>