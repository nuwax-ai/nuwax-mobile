<template>
	<view class='container'>
		<!-- 分类导航 -->
		<view class='category-nav'>
			<scroll-view class='category-scroll' direction="horizontal" :scroll-with-animation="true"
				:scroll-into-view="scrollIntoView" :show-scrollbar="false">
				<view :id="category.type" v-for="(category, index) in categories" :key="category.type"
					:class="`category-item ${activeCategory === category.type ? 'active' : ''}`"
					@click="handleCategoryClick(category.type, index)">
					<text class='category-text'>{{ category.name }}</text>
				</view>
			</scroll-view>
		</view>

		<!-- 滚动部分 -->
		<view class='scroll-section'>
			<swiper class='agent-swiper' :current="activeSwiperIndex" @change="handleSwiperChange"
				:indicator-dots="false">
				<swiper-item class='swiper-item' v-for="category in categories" :key="category.type">
					<scroll-view class='agent-scroll' :refresher-enabled="false"
						:refresher-triggered="refreshingMap[category.type] || false" :show-scrollbar="false">
						<view class='agent-list-container'>
							<template v-if="(agentListMap[category.type] || []).length">
								<agent-component
									v-for="info in agentListMap[category.type]" 
									:key="info.targetId"
									:icon="info.icon"
									:name="info.name"
									:userName="info.publishUser?.userName"
									:description="info.description"
									:userCount="info.statistics?.userCount"
									:convCount="info.statistics?.convCount"
									:collectCount="info.statistics?.collectCount"
									@click="handleAgentClick(info.targetId)"
								/>
							</template>
							<empty-state v-if="!agentListMap[category.type]" />
						</view>
					</scroll-view>
				</swiper-item>
			</swiper>
		</view>
	</view>
</template>


<script setup lang="uts">
	import { ref, watch } from 'vue'
	import { HomeAgentCategoryInfo, CategoryInfo, CategoryItemInfo } from '@/types/interfaces/agentConfig'
	import AgentComponent from '@/components/agent-component/agent-component.uvue'


	// 定义Props接口
	interface Props {
		type?: string
		data?: HomeAgentCategoryInfo
	}

	// 使用TypeScript方式定义props
	const props = withDefaults(defineProps<Props>(), {
		type: '',
		data: {
			categories: [],
			// 首页分类数据列表
			categoryItems: {}
		}
	})

	// 当前分类
	const activeCategory = ref<string>('')
	// 当前swiper索引
	const activeSwiperIndex = ref<number>(0)
	// 分类列表
	const categories = ref<CategoryInfo[]>([])
	// 智能体列表
	const agentListMap = ref<{ [key : string] : CategoryItemInfo[] }>({})
	// 刷新状态
	const refreshingMap = ref<{ [key : string] : boolean }>({})
	// 滚动到对应的分类标签
	const scrollIntoView = ref<string>('')

	// 跳转到智能体详情页
	const handleAgentClick = (id: number) => {
			uni.navigateTo({
				url: `/pages/agent-detail/agent-detail?id=${id}`
		})
	}

	// 点击智能体分类标签
	const handleCategoryClick = (key : string, index : number) => {
		// 当前分类
		activeCategory.value = key
		// 当前swiper索引
		activeSwiperIndex.value = index
		// 滚动到对应的分类标签
		scrollIntoView.value = key;
	}

	// 处理Swiper切换
	const handleSwiperChange = (e : UniSwiperChangeEvent) => {
		const index = e.detail.current
		const category = categories.value[index]
		if (category && category.type !== activeCategory.value) {
			// 当前分类
			activeCategory.value = category.type
			// 当前swiper索引
			activeSwiperIndex.value = index
			// 滚动到对应的分类标签
			scrollIntoView.value = categories.value[index].type;
		}
	}


	const initDefaultSetting = () => {
		console.log('initDefaultSetting --- props.data', props.data)
		if (props.data) {
			categories.value = props.data?.categories || []
			agentListMap.value = props.data?.categoryItems || {}

			activeCategory.value = props.type || '' // 头部分类
			activeSwiperIndex.value = categories.value.findIndex(item => item.type === props.type) || 0 // 首页默认分类
	
            // #ifdef H5
            nextTick(() => {
                scrollIntoView.value = props.type || '' // 滚动到对应的分类标签
            })
            // #endif
			
            // #ifdef MP-WEIXIN
            setTimeout(() => {
                scrollIntoView.value = props.type || '' // 滚动到对应的分类标签
            }, 0);
            // #endif
		}
	}

	// #ifdef MP-WEIXIN
	watch(() => props.type, ()=>{initDefaultSetting()})
	// #endif

	watch(() => props.data, ()=>{initDefaultSetting()})

	onLoad(() => {
	// #ifdef H5
     initDefaultSetting()
	// #endif
	})
</script>

<style scoped lang="scss">
	.container {
		height: 100%;
		display: flex;
		flex-direction: column;
		overflow: hidden;
		background-color: #fff;
		// border: 5rpx solid red;
		border-radius: 20rpx;
		/* #ifdef MP-WEIXIN */
		padding-top: env(safe-area-inset-top);
		padding-bottom: env(safe-area-inset-bottom);
		/* #endif */

		.category-nav {
			padding: 0 32rpx;

			/* 分类导航 */
			.category-scroll {
				white-space: nowrap;
				scroll-behavior: smooth;
				-webkit-overflow-scrolling: touch;

				height: 112rpx;
				gap: 16rpx;
				display: flex;
				align-items: center;
				flex-direction: row;
			}

			.category-item {
				display: flex;
				justify-content: center;
				height: 80rpx;
				padding: 0 32rpx;
				border-radius: 16rpx;
				cursor: pointer;
				transition: all 0.3s ease;
				user-select: none;
				color: #5E6470;
				font-size: 32rpx;
				font-weight: 400;

				&.active {
					background-color: #F2F2FF;

					.category-text {
						color: #5147FF;
					}
				}

				.category-text {
					font-size: 32rpx;
					font-weight: 400;
					color: #5E6470;
					transition: color 0.3s ease;
				}
			}
		}



		/* 滚动部分 */
		.scroll-section {
			flex: 1;
			// overflow: hidden;
			overflow-y: auto;

			/* 智能体列表 */
			.agent-swiper {
				height: 100%;
			}

			.swiper-item {
				height: 100%;
				overflow: hidden;
			}

			.agent-scroll {
				height: 100%;
			}

			.agent-list-container {
				padding: 0 16rpx;
			}
		}

		/* 空状态 */
		.empty-state {
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			padding: 160rpx 40rpx;
			text-align: center;
		}

		.empty-text {
			font-size: 28rpx;
			color: #999;
			margin-top: 32rpx;
		}

		/* 加载状态 */
		.loading-state {
			display: flex;
			align-items: center;
			justify-content: center;
			padding: 40rpx;
		}




	}
</style>