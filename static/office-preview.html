<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Office Document Preview</title>
    <!-- js-preview CSS -->
    <link rel="stylesheet" href="https://unpkg.com/@js-preview/docx/lib/index.css">
    <link rel="stylesheet" href="https://unpkg.com/@js-preview/excel/lib/index.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #fff;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            font-size: 16px;
            color: #666;
        }

        .error {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #ff4d4f;
            text-align: center;
            padding: 20px;
        }

        .error button {
            margin-top: 16px;
            padding: 8px 16px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            background: #fff;
            cursor: pointer;
        }

        #preview-container {
            width: 100%;
            height: 100%;
            overflow: auto;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>
    <div id="loading" class="loading">加载中...</div>
    <div id="error" class="error hidden">
        <div id="error-msg"></div>
        <button onclick="retry()">重试</button>
    </div>
    <div id="preview-container" class="hidden"></div>

    <!-- js-preview libraries via CDN -->
    <script src="https://unpkg.com/@js-preview/docx/lib/index.js"></script>
    <script src="https://unpkg.com/@js-preview/excel/lib/index.js"></script>
    <script src="https://unpkg.com/@js-preview/pdf/lib/index.js"></script>

    <script>
        // Parse URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const src = urlParams.get('src');
        const fileType = urlParams.get('type');

        const loadingEl = document.getElementById('loading');
        const errorEl = document.getElementById('error');
        const errorMsgEl = document.getElementById('error-msg');
        const containerEl = document.getElementById('preview-container');

        let currentPreviewer = null;

        function showLoading() {
            loadingEl.classList.remove('hidden');
            errorEl.classList.add('hidden');
            containerEl.classList.add('hidden');
        }

        function showError(msg) {
            loadingEl.classList.add('hidden');
            errorEl.classList.remove('hidden');
            containerEl.classList.add('hidden');
            errorMsgEl.textContent = msg;
        }

        function showPreview() {
            loadingEl.classList.add('hidden');
            errorEl.classList.add('hidden');
            containerEl.classList.remove('hidden');
        }

        async function renderDocument() {
            if (!src || !fileType) {
                showError('缺少必要参数 (src 或 type)');
                return;
            }

            showLoading();

            // Destroy previous previewer if exists
            if (currentPreviewer) {
                try {
                    currentPreviewer.destroy && currentPreviewer.destroy();
                } catch (e) { /* ignore */ }
                currentPreviewer = null;
            }

            // Clear container
            containerEl.innerHTML = '';

            try {
                switch (fileType) {
                    case 'docx':
                        if (typeof jsPreviewDocx !== 'undefined') {
                            currentPreviewer = jsPreviewDocx.init(containerEl);
                            await currentPreviewer.preview(src);
                            showPreview();
                        } else {
                            throw new Error('jsPreviewDocx 未加载');
                        }
                        break;

                    case 'xlsx':
                        if (typeof jsPreviewExcel !== 'undefined') {
                            currentPreviewer = jsPreviewExcel.init(containerEl);
                            await currentPreviewer.preview(src);
                            showPreview();
                        } else {
                            throw new Error('jsPreviewExcel 未加载');
                        }
                        break;

                    case 'pdf':
                        if (typeof jsPreviewPdf !== 'undefined') {
                            currentPreviewer = jsPreviewPdf.init(containerEl, {
                                onError: (e) => {
                                    console.error('PDF error:', e);
                                    showError(e?.message || 'PDF 加载失败');
                                },
                                onRendered: () => {
                                    console.log('PDF rendered');
                                    showPreview();
                                }
                            });
                            await currentPreviewer.preview(src);
                        } else {
                            throw new Error('jsPreviewPdf 未加载');
                        }
                        break;

                    default:
                        showError(`不支持的文件类型: ${fileType}`);
                        return;
                }

                console.log('[OfficePreview] Document rendered successfully');

            } catch (e) {
                console.error('[OfficePreview] Render error:', e);
                showError(e.message || '文档加载失败');
            }
        }

        function retry() {
            renderDocument();
        }

        // Start rendering on page load
        document.addEventListener('DOMContentLoaded', renderDocument);
    </script>
</body>

</html>