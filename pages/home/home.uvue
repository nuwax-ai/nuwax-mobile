<template>
	<view class="home-container">
		<!-- å¯¼èˆªæ  -->
		<custom-nav-bar :title="tenantConfigInfo?.siteName" show-menu :icon="tenantConfigInfo?.siteLogo" />
		<view class="home-content">
			<!-- æ ‡é¢˜/æŒ‰é’®ç»„ -->
			<button-group 
				:welcome-msg="welcomeMsg"
				:buttons="tenantConfigInfo?.homeRecommendQuestions?.slice(0,5)||[]" 
				@buttonClick="handleClickGuideQuestion" />
					<!-- è½®æ’­ç»„ä»¶ -->
		<swiper-carousel @view-more="handleViewMore" />
		
		<!-- æ¼”ç¤ºé¡µé¢é“¾æ¥ -->
		<view class="demo-links">
			<view class="demo-link-item" @click="navigateToMathDemo">
				<text class="demo-link-text">ğŸ§® Math Renderer æ¼”ç¤º</text>
				<text class="demo-link-desc">æµ‹è¯•æ•°å­¦å…¬å¼æ¸²æŸ“åŠŸèƒ½</text>
			</view>
			<view class="demo-link-item" @click="navigateToKuxMarkedDemo">
				<text class="demo-link-text">ğŸ§© kux-marked æ‰©å±•æ¼”ç¤º</text>
				<text class="demo-link-desc">å±•ç¤ºå„ç§æ‰©å±•åŠŸèƒ½</text>
			</view>
			<view class="demo-link-item" @click="navigateToKuxMarkedTest">
				<text class="demo-link-text">ğŸ” kux-marked è§£ææµ‹è¯•</text>
				<text class="demo-link-desc">å®æ—¶æµ‹è¯•è§£æåŠŸèƒ½</text>
			</view>
			<view class="demo-link-item" @click="navigateToSimpleMathTest">
				<text class="demo-link-text">ğŸ§® æ•°å­¦å…¬å¼æ‰©å±•æµ‹è¯•</text>
				<text class="demo-link-desc">ç®€å•æµ‹è¯•æ•°å­¦å…¬å¼è§£æ</text>
			</view>
		</view>
	</view>
	<!-- è¾“å…¥æ¡† -->
		<chat-input-phone
			ref="chatInputPhoneRef"
			:manual-components="agentInfo?.manualComponents || []"
			@onSendMessage="handleSendMessage"
		/>
		<menu-popup ref="popupAgentReferral" title="æ™ºèƒ½ä½“æ¨è" direction="bottom" height="85vh">
			<agent-referral :type="referralType" :data="categories" />
		</menu-popup>
	</view>
</template>

<script setup lang="uts">
	import { apiPublishedAgentList, apiPublishedCategoryList } from '@/servers/square'
	import { apiTenantConfig } from '@/servers/account'
	import { apiHomeCategoryList,apiPublishedAgentInfo } from '@/servers/agentDev'
	import { CONST_ALL, CONVERSATION_PAYLOAD } from '@/constants/common.constants'
	import { SUCCESS_CODE } from '@/constants/codes.constants';
	import { SquareAgentTypeEnum } from '@/types/enums/square'
	import { SquareCategoryInfo, SquarePublishedItemInfo } from '@/types/interfaces/square'
	import { HomeAgentCategoryInfo } from '@/types/interfaces/agentConfig';
	import type { TenantConfigInfo } from '@/types/interfaces/login';
	import type { UploadFileInfo } from '@/types/interfaces/common.uts';
	import type { AgentSelectedComponentInfo } from '@/types/interfaces/agent.uts';
	import type { AgentDetailDto } from '@/types/interfaces/agent';
	import type { ChatInputPhoneRef } from '@/types/interfaces/chat.uts';

	// ç»„ä»¶
	import ButtonGroup from './components/button-group/button-group.uvue'
	import SwiperCarousel from './components/swiper-carousel/swiper-carousel.uvue'
	import AgentReferral from './components/agent-referral/agent-referral.uvue'
	import ChatInputPhone from '@/components/chat-input-phone/chat-input-phone.uvue'

	const tenantConfigInfo = ref<TenantConfigInfo>(null)
	const popupAgentReferral = ref<any>(null) // æ™ºèƒ½ä½“æ¨è
	const referralType = ref<string>('')// æ¨èç±»å‹
	const welcomeMsg = ref<string>('')// æ¬¢è¿æ¶ˆæ¯
	const categories = ref<HomeAgentCategoryInfo>({
		// é¦–é¡µåˆ†ç±»
		categories: [],
		// é¦–é¡µåˆ†ç±»æ•°æ®åˆ—è¡¨
		categoryItems: {}
	})
	// æ™ºèƒ½ä½“ä¿¡æ¯
	const agentInfo = ref<AgentDetailDto | null>(null)
	// å®šä¹‰ chat-input-phone ç»„ä»¶çš„å¼•ç”¨
	const chatInputPhoneRef = ref<ChatInputPhoneRef | null>(null)

	// å¤„ç†è¾“å…¥æ¡†å‘é€æ¶ˆæ¯äº‹ä»¶ï¼Œè·³è½¬åˆ°æ™ºèƒ½ä½“ä¸»é¡µ
	const handleSendMessage = (infos: {
		messageInfo: string,
		files: UploadFileInfo[],
		selectedComponents: AgentSelectedComponentInfo[]
	}) => {
		const { messageInfo, files, selectedComponents } = infos
		// éªŒè¯è¾“å…¥å†…å®¹
		if (!messageInfo?.trim() && (!files || files.length === 0)) {
			uni.showToast({
				title: 'è¯·è¾“å…¥æ¶ˆæ¯æˆ–é€‰æ‹©æ–‡ä»¶',
				icon: 'none',
				duration: 2000
			});
			return;
		}
		// æ™ºèƒ½ä½“idå’Œåç§°
		const id = tenantConfigInfo.value?.defaultAgentId
		const name = tenantConfigInfo.value?.siteName

		const data = JSON.stringify({
			messageInfo,
			files,
			selectedComponents
		})

		uni.setStorageSync(CONVERSATION_PAYLOAD, data)

		// è·³è½¬åˆ°æ™ºèƒ½ä½“è¯¦æƒ…é¡µé¢ï¼Œå¹¶ä¼ é€’æ¶ˆæ¯æ•°æ®
		uni.navigateTo({
		  url: `/pages/agent-detail/agent-detail?id=${id}`
		});
	};

	// ç‚¹å‡»æ™ºèƒ½ä½“å¼•å¯¼é—®é¢˜
	const handleClickGuideQuestion = (guideQuestion: string) => {
		handleSendMessage({
			messageInfo: guideQuestion,
			files: chatInputPhoneRef.value?.files,
			selectedComponents: chatInputPhoneRef.value?.selectedComponents
		})
	}

	// ä¸»é¡µæ™ºèƒ½ä½“åˆ—è¡¨æ¥å£
	const fetchHomeCategoryList = async () => {
		const { code, data } = await apiHomeCategoryList()
		if (code === SUCCESS_CODE) {
			categories.value = data
		}
	}

	const handleViewMore = (type: string) => {
		referralType.value = type
		popupAgentReferral.value?.open()
	}

	// è·å–ç”¨æˆ·é…ç½®
	const fetchTenantConfig = async () => {
		const { code, data } = await apiTenantConfig()
		if (code === SUCCESS_CODE) {
			tenantConfigInfo.value = data
			data.defaultAgentId && fetchDefaultAgent(data.defaultAgentId)
		}
	}
	// è·å–æ™ºèƒ½ä½“è¯¦æƒ…
	const fetchDefaultAgent = async (agentId: number) => {
		const { code, data } = await apiPublishedAgentInfo(agentId)
		if (code === SUCCESS_CODE) {
			welcomeMsg.value = data.openingChatMsg
			agentInfo.value = data
		}
	}

	// å¯¼èˆªåˆ° Math Renderer æ¼”ç¤ºé¡µé¢
	const navigateToMathDemo = () => {
		uni.navigateTo({
			url: '/examples/math-renderer-demo'
		})
	}

	// å¯¼èˆªåˆ° kux-marked æ‰©å±•æ¼”ç¤ºé¡µé¢
	const navigateToKuxMarkedDemo = () => {
		uni.navigateTo({
			url: '/examples/kux-marked-extensions-demo'
		})
	}

	// å¯¼èˆªåˆ° kux-marked è§£ææµ‹è¯•é¡µé¢
	const navigateToKuxMarkedTest = () => {
		uni.navigateTo({
			url: '/examples/kux-marked-parser-test'
		})
	}

	// å¯¼èˆªåˆ°æ•°å­¦å…¬å¼æ‰©å±•æµ‹è¯•é¡µé¢
	const navigateToSimpleMathTest = () => {
		uni.navigateTo({
			url: '/examples/simple-math-test'
		})
	}

	onLoad(() => {
		fetchHomeCategoryList()
		fetchTenantConfig() // è·å–ç”¨æˆ·é…ç½®
	})
</script>

<style lang="scss" scoped>
.home-container{
	height: 100%;
	display: flex;
	flex-direction: column;

	.home-content{
		flex: 1;
		// height: 100%;
		overflow: auto;
	}

	.demo-links {
		padding: 32rpx;
		background-color: #f8f9fa;
		border-top: 2rpx solid #e9ecef;
	}

	.demo-link-item {
		display: flex;
		flex-direction: column;
		padding: 24rpx;
		background-color: white;
		border-radius: 16rpx;
		margin-bottom: 16rpx;
		border: 2rpx solid #e9ecef;
		transition: all 0.3s ease;
		box-shadow: 0 2rpx 8rpx rgba(0, 0, 0, 0.05);
	}

	.demo-link-item:active {
		transform: scale(0.98);
		background-color: #f8f9fa;
	}

	.demo-link-text {
		font-size: 30rpx;
		font-weight: 600;
		color: #2c3e50;
		margin-bottom: 8rpx;
	}

	.demo-link-desc {
		font-size: 24rpx;
		color: #7f8c8d;
		line-height: 1.4;
	}
}

</style>