<template>
  <view
    v-if="node.type === 'folder'"
    class="folder-item"
    :style="`margin-left: ${level * 16}rpx`"
  >
    <view
      class="folder-header"
      @tap="handleToggleFolder"
    >
      <text class="folder-caret" :class="{ expanded: isExpanded }">▶</text>
      <text class="iconfont icon-Folder folder-icon"></text>
      <view class="folder-name">{{ node.name }}</view>
    </view>
    <view v-if="isExpanded && node.children && node.children.length > 0" class="file-list">
      <file-tree-node
        v-for="child in node.children"
        :key="child.id"
        :node="child"
        :level="level + 1"
        :expanded-folders="expandedFolders"
        :selected-file-id="selectedFileId"
        @toggle-folder="handleChildToggleFolder"
        @select-file="handleChildSelectFile"
      />
    </view>
  </view>
  <view
    v-else
    class="file-item"
    :class="{ 'active-file': isSelected, 'hidden-file': node.name.startsWith('.') }"
    :style="`margin-left: ${level * 16}rpx`"
    @tap="handleSelectFile"
  >
    <view class="file-icon-wrapper">
      <text v-if="fileIcon.type === 'icon'" :class="[fileIcon.className, fileIcon.value]"></text>
      <text v-else class="file-icon-text">{{ fileIcon.value }}</text>
    </view>
    <view class="file-name">{{ node.name }}</view>
  </view>
</template>

<script setup lang="uts">
  import { computed } from 'vue'
  import type { FileNode } from '@/types/interfaces/agent'
  import FileTreeNode from './file-tree-node.uvue'
  import { getFileIcon, type FileIconInfo } from './fileIconHelper.uts'

  interface Props {
    node: FileNode
    level: number
    expandedFolders: Set<string>
    selectedFileId: string
  }

  const props = defineProps<Props>()

  const emit = defineEmits<{
    toggleFolder: [folderId: string]
    selectFile: [fileId: string]
  }>()

  /**
   * 是否展开
   */
  const isExpanded = computed(() => {
    return props.expandedFolders.has(props.node.id)
  })

  /**
   * 是否选中
   */
  const isSelected = computed(() => {
    return props.selectedFileId === props.node.id
  })

  /**
   * 文件图标信息
   */
  const fileIcon = computed<FileIconInfo>(() => {
    if (props.node.type === 'file') {
      return getFileIcon(props.node.name)
    }
    return { type: 'text', value: '' }
  })

  /**
   * 切换文件夹展开/收起
   */
  const handleToggleFolder = () => {
    if (props.node.type === 'folder') {
      emit('toggleFolder', props.node.id)
    }
  }

  /**
   * 选择文件
   */
  const handleSelectFile = () => {
    if (props.node.type === 'file' && !props.node.name.startsWith('.')) {
      emit('selectFile', props.node.id)
    }
  }

  /**
   * 处理子组件的切换文件夹事件
   */
  const handleChildToggleFolder = (folderId: string) => {
    emit('toggleFolder', folderId)
  }

  /**
   * 处理子组件的选择文件事件
   */
  const handleChildSelectFile = (fileId: string) => {
    emit('selectFile', fileId)
  }
</script>

<style scoped lang="scss">
  @import '@/static/iconfont/iconfont.css';

  .folder-item {
    .folder-header {
      display: flex;
      align-items: center;
      padding: 4rpx 0;
      cursor: pointer;
      user-select: none;
      min-height: 40rpx;

      .folder-caret {
        font-size: 18rpx;
        color: #999;
        margin-right: 4rpx;
        transition: transform 0.2s;
        display: inline-block;
        width: 18rpx;
        text-align: center;
        line-height: 1;

        &.expanded {
          transform: rotate(90deg);
        }
      }

      .folder-icon {
        font-size: 28rpx;
        color: #8b9dc3;
        margin-right: 6rpx;
        display: inline-block;
        line-height: 1;
      }

      .folder-name {
        flex: 1;
        font-size: 26rpx;
        color: #333;
        line-height: 1.4;
      }
    }

    .file-list {
      margin-left: 0;
    }
  }

  .file-item {
    display: flex;
    align-items: center;
    padding: 4rpx 0;
    cursor: pointer;
    user-select: none;
    min-height: 40rpx;

    &.active-file {
      background-color: #f0f0f0;
      border-radius: 4rpx;
    }

    &.hidden-file {
      opacity: 0.6;
    }

    .file-icon-wrapper {
      width: 28rpx;
      height: 28rpx;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 6rpx;
      flex-shrink: 0;

      .iconfont {
        font-size: 24rpx;
        color: #8b9dc3;
        line-height: 1;
      }

      .file-icon-text {
        font-size: 18rpx;
        color: #666;
        font-weight: 500;
        line-height: 1;
        text-align: center;
      }
    }

    .file-name {
      flex: 1;
      font-size: 26rpx;
      color: #333;
      line-height: 1.4;
      word-break: break-all;
    }
  }
</style>

