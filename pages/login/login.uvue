<template>
  <view class="container">
    <safety-zone />
    <view class="content">
      <view class="header-content">
        <image class="icon" :src="tenantConfigInfo?.siteLogo" mode="aspectFill" />
        <view class="title">
          Ê¨¢Ëøé‰ΩøÁî®{{tenantConfigInfo?.siteName}}
        </view>
      </view>
      
      <view class="form-content">
        <view class="phone-input-wrapper" v-if="!isEmailAuth">
          <view class="country-code">+86</view>
          <input class="phone-input" type="number" placeholder="ËØ∑ËæìÂÖ•ÊâãÊú∫Âè∑" v-model="phoneNumber" />
          <view class="clear-btn" v-if="phoneNumber" @click="clearPhoneNumber">
            <uni-icon class="iconfont icon-a-Xcircle-fill clear-icon" />
          </view>
        </view>
        
        <view v-else class="phone-input-wrapper">
          <input class="phone-input" type="email" placeholder="ËØ∑ËæìÂÖ•ÈÇÆÁÆ±" v-model="emailNumber" />
          <view class="clear-btn" v-if="emailNumber" @click="clearEmailNumber">
            <uni-icon class="iconfont icon-a-Xcircle-fill clear-icon" />
          </view>
        </view>

        <view class="password-input-wrapper" v-if="!isCaptchaVerify">
          <input class="password-input" :password="!showPassword" placeholder="ËØ∑ËæìÂÖ•ÂØÜÁ†Å" v-model="password" />
          <!-- <view class="eye-btn" @click="togglePasswordVisibility">
            <text class="eye-icon">{{ showPassword ? 'üëÅ' : 'üôà' }}</text>
          </view> -->
          <view class="clear-btn" v-if="password" @click="clearPassword">
            <uni-icon class="iconfont icon-a-Xcircle-fill clear-icon" />
          </view>
        </view>

        <button class="login-btn" v-if="!isCaptchaVerify" @click="handleLogin">ÁôªÂΩï</button>
        <button class="login-btn" v-else @click="handleNext">Ëé∑ÂèñÁü≠‰ø°È™åËØÅÁ†Å</button>

        <view class="agreement">
          <checkbox-group @change="handleAgreeChange" class="checkbox-group">
            <label class="checkbox-label">
              <checkbox 
                class="checkbox" 
                color="#5147ff" 
                style="transform:scale(0.7)" 
                iconColor="#fff"
                activeBackgroundColor="#5147ff" 
                value="agree" 
                :checked="agreeTerms" 
              />
              <text class="agreement-text">Â∑≤ÈòÖËØªÂπ∂ÂêåÊÑèÂçèËÆÆÔºö</text>
              <text class="link" @click.stop="handleServiceAgreement">ÊúçÂä°‰ΩøÁî®ÂçèËÆÆ</text>
              <text class="agreement-text" @click.stop>„ÄÅ</text>
              <text class="link" @click.stop="handlePrivacyAgreement">ÈöêÁßÅÂçèËÆÆ</text>
            </label>
          </checkbox-group>
        </view>
      </view>

      <view class="other-content" v-if="!isEmailAuth">
        <view class="divider">
          <text class="divider-text">Êàñ</text>
        </view>
        <button class="alt-login-btn" v-if="!isCaptchaVerify" @click="isCaptchaVerify = true">È™åËØÅÁ†ÅÁôªÂΩï/Ê≥®ÂÜå</button>
        <button class="alt-login-btn" v-else @click="isCaptchaVerify = false">ÂØÜÁ†ÅÁôªÂΩï</button>
      </view>
    </view>
    <!-- È™åËØÅÁ†ÅÁôªÂΩï -->
    <captcha-verify ref="popupRef" :phoneNumber="phoneNumber" @verify-login="handleLoginByCode" />
  </view>
</template>

<script setup lang="uts">
  import { ref } from 'vue';
  import { apiLogin } from '@/servers/account';
  import type { ILoginResult, LoginFieldType } from '@/types/interfaces/login';
  import { SUCCESS_CODE, AGENT_NOT_EXIST } from '@/constants/codes.constants';
  import { ACCESS_TOKEN, EXPIRE_DATE } from '@/constants/home.constants';
  import { apiTenantConfig,apiSendCode, apiLoginCode } from '@/servers/account'
  import type { TenantConfigInfo } from '@/types/interfaces/login';
  import CaptchaVerify  from '@/pages/login/components/captcha-verify/captcha-verify.uvue'

  interface UniPopupInstance {
    open(type ?: string) : void
    close() : void
  }

  const phoneNumber = ref('')
  const emailNumber = ref('')
  const password = ref('')
  const agreeTerms = ref(false)
  const showPassword = ref(false)
  const tenantConfigInfo = ref<TenantConfigInfo>(null) // ÈÖçÁΩÆ‰ø°ÊÅØ
  const captchaVerifyParam = ref('')// È™åËØÅÁ†Å
  const isCaptchaVerify = ref(false)// ÊòØÂê¶È™åËØÅÁ†Å
  const popupRef = ref<UniPopupInstance | null>(null)
  

  
  // Âà§Êñ≠ÈÖçÁΩÆ‰ø°ÊÅØÊòØÂê¶ÈÇÆÁÆ±ÁôªÂΩï
  const isEmailAuth = computed(() => {
    return tenantConfigInfo.value?.authType === 3
  })


  // Ëé∑ÂèñÁî®Êà∑ÈÖçÁΩÆ
  const fetchTenantConfig = async () => {
    const { code, data } = await apiTenantConfig()
    if (code === SUCCESS_CODE) {
    //   data.authType = 3; // ‰∏¥Êó∂ÊîπÂèò
      tenantConfigInfo.value = data
    }
  }

  const handleLogin = async () => {
    if (isEmailAuth.value) {
      handleLoginByEmail()
    } else {
      handleLoginByPhone()
    }
  }

  // ‰∏ã‰∏ÄÊ≠•
  const handleNext = async () => {
    // TODO:
    // popupRef.value?.open()
    // return

    // Ê†°È™åÊâãÊú∫Âè∑ÊòØÂê¶‰∏∫Á©∫
    if (!phoneNumber.value) {
        uni.showToast({
            title: 'ËØ∑ËæìÂÖ•ÊâãÊú∫Âè∑',
            icon: 'none'
        })
        return
    }
     // Ê†°È™åÊâãÊú∫Âè∑Ê†ºÂºè
    const phoneRegex = /^1[3-9]\d{9}$/
    if (!phoneRegex.test(phoneNumber.value)) {
        uni.showToast({
            title: 'ËØ∑ËæìÂÖ•Ê≠£Á°ÆÁöÑÊâãÊú∫Âè∑Ê†ºÂºè',
            icon: 'none'
        })
        return
    }
    if (!agreeTerms.value) {
      uni.showToast({
        title: 'ËØ∑ÂÖàÂêåÊÑèÁî®Êà∑ÂçèËÆÆ',
        icon: 'none'
      })
      return
    }
    const params={
        "type": "LOGIN_OR_REGISTER",
        "phone": phoneNumber.value
    }
    // ÂèëÈÄÅÈ™åËØÅÁ†Å
    const { code, data, message } = await apiSendCode(params)
    if (code === SUCCESS_CODE) {
        popupRef.value?.open()
    }
  }

  // ÊâãÊú∫Âè∑ÁôªÂΩï
  const handleLoginByPhone = async () => {
    // Ê†°È™åÊâãÊú∫Âè∑ÊòØÂê¶‰∏∫Á©∫
    if (!phoneNumber.value) {
        uni.showToast({
            title: 'ËØ∑ËæìÂÖ•ÊâãÊú∫Âè∑',
            icon: 'none'
        })
        return
    }
    // Ê†°È™åÊâãÊú∫Âè∑Ê†ºÂºè
    const phoneRegex = /^1[3-9]\d{9}$/
    if (!phoneRegex.test(phoneNumber.value)) {
        uni.showToast({
            title: 'ËØ∑ËæìÂÖ•Ê≠£Á°ÆÁöÑÊâãÊú∫Âè∑Ê†ºÂºè',
            icon: 'none'
        })
        return
    }

    if (!password.value) {
      uni.showToast({
        title: 'ËØ∑ËæìÂÖ•ÂØÜÁ†Å',
        icon: 'none'
      })
      return
    }
    
    if (!agreeTerms.value) {
      uni.showToast({
        title: 'ËØ∑ÂÖàÂêåÊÑèÁî®Êà∑ÂçèËÆÆ',
        icon: 'none'
      })
      return
    }
    
    // ÊâßË°åÁôªÂΩïÈÄªËæë
    const params: LoginFieldType = {
      "phoneOrEmail": phoneNumber.value,
      "areaCode": "86",
      "password": password.value,
      "captchaVerifyParam": ""
    }
    
    const result = await apiLogin(params)
    handleLoginSuccess(result)
  }


  // È™åËØÅÁ†ÅÁôªÂΩï
  const handleLoginByCode = async (code:string) => {
    const params={
        phoneOrEmail: phoneNumber.value,
        code
    }
    const result = await apiLoginCode(params)
    handleLoginSuccess(result)
  }
  // ÈÇÆÁÆ±ÁôªÂΩï
  const handleLoginByEmail = async () => {
    // Ê†°È™åÈÇÆÁÆ±ÊòØÂê¶‰∏∫Á©∫
    if (!emailNumber.value) {
        uni.showToast({
            title: 'ËØ∑ËæìÂÖ•ÈÇÆÁÆ±',
            icon: 'none'
        })
        return
    }
    // Ê†°È™åÈÇÆÁÆ±Ê†ºÂºè
    const emailRegex = /^[a-zA-Z0-9_.-]+@[a-zA-Z0-9-]+(\.[a-zA-Z0-9-]+)*\.[a-zA-Z0-9]{2,6}$/
    if (!emailRegex.test(emailNumber.value)) {
        uni.showToast({
            title: 'ËØ∑ËæìÂÖ•Ê≠£Á°ÆÁöÑÈÇÆÁÆ±Ê†ºÂºè',
            icon: 'none'
        })
        return
    }

    if (!password.value) {
      uni.showToast({
        title: 'ËØ∑ËæìÂÖ•ÂØÜÁ†Å',
        icon: 'none'
      })
      return
    }
    
    if (!agreeTerms.value) {
      uni.showToast({
        title: 'ËØ∑ÂÖàÂêåÊÑèÁî®Êà∑ÂçèËÆÆ',
        icon: 'none'
      })
      return
    }
    
    // ÊâßË°åÁôªÂΩïÈÄªËæë
    const params: LoginFieldType = {
      "phoneOrEmail": emailNumber.value,
      "areaCode": "",
      "password": password.value,
      "captchaVerifyParam": ""
    }
    
    const { code, data, message } = await apiLogin(params)
    if (code === SUCCESS_CODE) {
      uni.showToast({
        title: 'ÁôªÂΩïÊàêÂäü',
        icon: 'success'
      })
      setTimeout(() => {
        uni.setStorageSync(ACCESS_TOKEN, data.token)
        uni.reLaunch({
          url: '/pages/home/home'
        })
      }, 1000);
    } else if (code === AGENT_NOT_EXIST) {
      uni.showToast({
        title: message,
        icon: 'none'
      })
    }
  }
  
  // ÁôªÂΩïÊàêÂäüÂêé
  const handleLoginSuccess = (result:ILoginResult) => {
    const { code, data, message } = result
    if (code === SUCCESS_CODE) {
      uni.showToast({
        title: 'ÁôªÂΩïÊàêÂäü',
        icon: 'success'
      })
      setTimeout(() => {
        uni.setStorageSync(ACCESS_TOKEN, data.token)
        uni.reLaunch({
          url: '/pages/home/home'
        })
      }, 1000);
    } else if (code === AGENT_NOT_EXIST) {
      uni.showToast({
        title: message,
        icon: 'none'
      })
    }
  }

  const handleAgreeChange = (e: any) => {
    agreeTerms.value = e.detail.value.includes('agree')
  }

  const handleServiceAgreement = () => {
    uni.navigateTo({
      url: '/pages/privacy-security/privacy-security?url=https://nuwax.com/user-agreement.html&title=ÊúçÂä°‰ΩøÁî®ÂçèËÆÆ'
    })
  }

  const handlePrivacyAgreement = () => {
    uni.navigateTo({
      url: '/pages/privacy-security/privacy-security?url=https://nuwax.com/privacy.html&title=ÈöêÁßÅÂçèËÆÆ'
    })
  }

  const clearPhoneNumber = () => {
    phoneNumber.value = ''
  }
  
  const clearEmailNumber = () => {
    emailNumber.value = ''
  }

  const clearPassword = () => {
    password.value = ''
  }

  const togglePasswordVisibility = () => {
    showPassword.value = !showPassword.value
  }

  onLoad(() => {
    fetchTenantConfig()
  })
</script>

<style lang="scss" scoped>
  .container {
    height: 100%;
    overflow: auto;
    display: flex;
    flex-direction: column;

    .content {
      flex: 1;
      margin-top: 68rpx;
      padding: 48rpx;

      .header-content {
        .icon {
          width: 128rpx;
          height: 128rpx;
          border-radius: 32rpx;
        }

        .title {
          margin-top: 24rpx;
          font-weight: 600;
          font-style: Semibold;
          font-size: 48rpx;
          leading-trim: NONE;
          line-height: 64rpx;
          letter-spacing: 0rpx;
          vertical-align: middle;
          color: rgba(21, 23, 31, 1);
        }
      }

      .form-content {
        margin-top: 80rpx;

        .clear-btn {
          position: absolute;
          right: 32rpx;
          top: 50%;
          transform: translateY(-50%);
          cursor: pointer;

          .clear-icon {
            color: #b2b4b8;
          }
        }

        .phone-input-wrapper {
          display: flex;
          flex-direction: row;
          align-items: center;
          background: #F8F9FA;
          border-radius: 16rpx;
          padding: 24rpx 32rpx;
          margin-bottom: 32rpx;
          position: relative;

          .country-code {
            font-size: 32rpx;
            color: rgba(21, 23, 31, 1);
            margin-right: 24rpx;
            border-right: 2rpx solid rgba(12, 20, 102, 0.12);
            padding-right: 24rpx;
            font-weight: 400;
            line-height: 48rpx;
          }

          .phone-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            font-size: 32rpx;
            color: #15171f;
            font-weight: 400;
            line-height: 48rpx;
            padding-right: 60rpx;
          }
        }

        .password-input-wrapper {
          background: #F8F9FA;
          border-radius: 16rpx;
          padding: 24rpx 32rpx;
          margin-bottom: 48rpx;
          position: relative;

          .password-input {
            width: 100%;
            background: transparent;
            border: none;
            outline: none;
            font-size: 32rpx;
            color: #15171f;
            font-weight: 400;
            line-height: 48rpx;
            padding-right: 120rpx;
          }

          .eye-btn {
            position: absolute;
            right: 80rpx;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;

            .eye-icon {
              font-size: 32rpx;
              color: #b2b4b8;
            }
          }
        }

        .login-btn {
          width: 100%;
          border-radius: 16rpx;
          padding: 23rpx;
          font-size: 32rpx;
          font-weight: 400;
          margin-bottom: 32rpx;
          line-height: 48rpx;
          text-align: center;
          background: #5147ff;
          color: #ffffff;
        }

        .agreement {
          display: flex;
          flex-direction: row;
          align-items: center;
          flex-wrap: wrap;

          .checkbox-group {}

          .checkbox-label {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
          }

          .checkbox {}

          .agreement-text {
            font-size: 28rpx;
            line-height: 44rpx;
            font-weight: 400;
            color: rgba(21, 23, 31, 0.5);
          }

          .link {
            font-size: 28rpx;
            font-weight: 600;
            color: rgba(21, 23, 31, 0.5);
          }
        }
      }

      .other-content {
        margin-top: 80rpx;

        .divider {
          margin-bottom: 48rpx;
          display: flex;
          flex-direction: row;
          align-items: center;

          &::before,
          &::after {
            content: '';
            flex: 1;
            height: 2rpx;
            background-color: #E5E5E5;
          }

          .divider-text {
            padding: 0 32rpx;
            font-size: 24rpx;
            color: #999;
            white-space: nowrap;
          }
        }

        .alt-login-btn {
          width: 100%;
          background: rgba(242, 242, 255, 1);
          color: rgba(21, 23, 31, 1);
          padding: 6rpx;
          font-size: 32rpx;
          margin-bottom: 24rpx;
          border-radius: 16rpx;

          &:after {
            border: none;
          }
        }
      }
    }
  }
</style>