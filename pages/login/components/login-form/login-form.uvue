<template>
	<view class="container">
		<!-- åˆ†æ®µå™¨ç»„ä»¶ -->
		<segmented-control :options="loginOptions" v-model="currentLoginType"
			@change="handleLoginTypeChange" class="login-segmented" />
		<view class="sub-title-wrapper">
			<text class="sub-title">æ¬¢è¿ä½¿ç”¨{{tenantConfigInfo?.siteName}}</text>
		</view>

		<view class="phone-input-wrapper" v-if="!isEmailAuth">
			<view class="country-code">
				<text>+86</text>
				<uni-icon class="iconfont icon-a-Chevrondown" />
			</view>
			<input class="phone-input" type="number" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" v-model="phoneNumber"
				cursor-color="#5147FF" />
			<view class="clear-btn" v-if="phoneNumber" @click="clearPhoneNumber">
				<uni-icon class="iconfont icon-a-Xcircle-fill clear-icon" />
			</view>
		</view>

		<view v-else class="phone-input-wrapper">
			<input class="phone-input" type="email" placeholder="è¯·è¾“å…¥é‚®ç®±" v-model="emailNumber" cursor-color="#5147FF" />
			<view class="clear-btn" v-if="emailNumber" @click="clearEmailNumber">
				<uni-icon class="iconfont icon-a-Xcircle-fill clear-icon" />
			</view>
		</view>

		<view class="password-input-wrapper" v-if="!isCaptchaVerify">
			<input class="password-input" :password="!showPassword" placeholder="è¯·è¾“å…¥å¯†ç " v-model="password"
				cursor-color="#5147FF" />
			<!-- <view class="eye-btn" @click="togglePasswordVisibility">
        <text class="eye-icon">{{ showPassword ? 'ğŸ‘' : 'ğŸ™ˆ' }}</text>
        </view> -->
			<view class="clear-btn" v-if="password" @click="clearPassword">
				<uni-icon class="iconfont icon-a-Xcircle-fill clear-icon" />
			</view>
		</view>

		<button class="login-btn" @click="onFinish" :loading="loading" :disabled="loading">
			{{isCaptchaVerify ? 'ä¸‹ä¸€æ­¥' : 'ç™»å½•'}}
		</button>

		<view class="agreement">
			<checkbox-group @change="handleAgreeChange" class="checkbox-group">
				<label class="checkbox-label">
					<checkbox class="checkbox" color="#5147ff" style="transform:scale(0.7)" iconColor="#fff"
						activeBackgroundColor="#5147ff" value="agree" :checked="agreeTerms" />
					<text class="agreement-text">å·²é˜…è¯»å¹¶åŒæ„åè®®ï¼š</text>
					<text class="link" @click.stop="handleServiceAgreement">æœåŠ¡ä½¿ç”¨åè®®</text>
					<text class="agreement-text" @click.stop>ã€</text>
					<text class="link" @click.stop="handlePrivacyAgreement">éšç§åè®®</text>
				</label>
			</checkbox-group>
		</view>

		<!-- #ifdef H5 || WEB-->
		<button
			:id="buttonId"
			type="button"
			class="captcha-button"
		/>
		<aliyun-captcha
			:config="tenantConfigInfo"
			:element-id="buttonId"
			@doAction="handlerSuccess"
		/>
		<!-- #endif -->

	</view>
</template>

<script setup lang="uts">
	import { ref } from 'vue';
	import { apiLogin } from '@/servers/account';
	import type { ILoginResult, LoginFieldType } from '@/types/interfaces/login';
	import { SUCCESS_CODE, AGENT_NOT_EXIST } from '@/constants/codes.constants';
	import { ACCESS_TOKEN, EXPIRE_DATE } from '@/constants/home.constants';
	import { apiTenantConfig, apiSendCode, apiLoginCode } from '@/servers/account'
	import type { TenantConfigInfo } from '@/types/interfaces/login';
	import SegmentedControl from '@/components/segmented-control/segmented-control.uvue'
	import { handleExternalLink } from '@/utils/system.uts';

    // å®šä¹‰ç»„ä»¶props
    interface Props {
        tenantConfigInfo?: TenantConfigInfo
    }

    const props = withDefaults(defineProps<Props>(), {
        tenantConfigInfo: null,
    })

    const emit = defineEmits(['show-verify'])


	const phoneNumber = ref('')
	const emailNumber = ref('')
	const password = ref('')
	const agreeTerms = ref(true)
	const showPassword = ref(false)
	const captchaVerifyParam = ref('')// éªŒè¯ç 
	const isCaptchaVerify = ref(false)// æ˜¯å¦éªŒè¯ç 
	const loading = ref(false)
	// é˜¿é‡Œäº‘éªŒè¯ç æŒ‰é’®id
	const buttonId = ref<string>('aliyun-captcha-id')

	// åˆ†æ®µå™¨ç›¸å…³æ•°æ®
	const currentLoginType = ref('password')
	const loginOptions = ref([
		{ label: 'å¯†ç ç™»å½•', value: 'password' },
		{ label: 'éªŒè¯ç ç™»å½•/æ³¨å†Œ', value: 'phone' },
	])

	// å¤„ç†ç™»å½•æ–¹å¼åˆ‡æ¢
	const handleLoginTypeChange = (value : string | number, index : number) => {
		currentLoginType.value = value as string

		// æ ¹æ®é€‰æ‹©çš„ç™»å½•æ–¹å¼æ›´æ–°çŠ¶æ€
		switch (value) {
			case 'password':
				isCaptchaVerify.value = false
				break
			case 'phone':
				isCaptchaVerify.value = true
				break
		}
	}

	// åˆ¤æ–­é…ç½®ä¿¡æ¯æ˜¯å¦é‚®ç®±ç™»å½•
	const isEmailAuth = computed(() => {
        if (!props.tenantConfigInfo) {
            return false
        }
		return props.tenantConfigInfo?.authType === 3
	})

	const onFinish = ()=>{
		if (!agreeTerms.value) {
			uni.showModal({
				title: 'æç¤º',
				content: 'è¯·åŒæ„æœåŠ¡åè®®åŠéšç§ä¿æŠ¤ï¼',
				confirmText: 'åŒæ„',
				cancelText: 'ä¸åŒæ„',
				success: function (res) {
					if (res.confirm) {
						agreeTerms.value=true
						doLogin()
					}
				}
			});
		}else{
			doLogin()
		}
	}

	const doLogin = ()=>{
		const tenantConfigInfo = props?.tenantConfigInfo
		const { captchaSceneId, captchaPrefix, openCaptcha } =	tenantConfigInfo || {};
		// åªæœ‰åŒæ—¶æ»¡è¶³ä¸‰ä¸ªæ¡ä»¶æ‰å¯ç”¨éªŒè¯ç ï¼šåœºæ™¯IDå­˜åœ¨ã€èº«ä»½æ ‡å­˜åœ¨ã€å¼€å¯éªŒè¯ç 
		const needAliyunCaptcha = !!(
			tenantConfigInfo &&
			captchaSceneId !== '' &&
			captchaPrefix !== '' &&
			openCaptcha
		);

		// å¦‚æœéœ€è¦é˜¿é‡Œäº‘éªŒè¯ç ï¼Œåˆ™ç‚¹å‡»æŒ‰é’®è§¦å‘éªŒè¯ç 
		if (needAliyunCaptcha) {
			document?.getElementById(buttonId.value)?.click();
		} else {
			//ä¸éœ€è¦é˜¿é‡Œäº‘éªŒè¯ç ï¼Œç›´æ¥æ‰§è¡Œç™»å½•/éªŒè¯ç é€»è¾‘
			handlerSuccess();
		}
	}

	const handlerSuccess = (captchaVerifyParam: string = '') => {
		if(isCaptchaVerify.value){
			// éªŒè¯ç ç™»å½•
			handleNext(captchaVerifyParam)
		}else{
			// å¯†ç ç™»å½•
			handleLogin(captchaVerifyParam)
		}
	}

	const handleLogin = (captchaVerifyParam: string = '') => {
		if (isEmailAuth.value) {
			handleLoginByEmail(captchaVerifyParam)
		} else {
			handleLoginByPhone(captchaVerifyParam)
		}
	}

	// æ ¡éªŒç™»å½•å‚æ•°
	const validateLoginParams = () => {
		if (isEmailAuth.value) {
			// æ ¡éªŒé‚®ç®±æ˜¯å¦ä¸ºç©º
			if (!emailNumber.value) {
				uni.showToast({
					title: 'è¯·è¾“å…¥é‚®ç®±',
					icon: 'none'
				})
				return false
			}
			// æ ¡éªŒé‚®ç®±æ ¼å¼
			const emailRegex = /^[a-zA-Z0-9_.-]+@[a-zA-Z0-9-]+(\.[a-zA-Z0-9-]+)*\.[a-zA-Z0-9]{2,6}$/
			if (!emailRegex.test(emailNumber.value)) {
				uni.showToast({
					title: 'è¯·è¾“å…¥æ­£ç¡®çš„é‚®ç®±æ ¼å¼',
					icon: 'none'
				})
				return false
			}
			
		} else {
			// æ ¡éªŒæ‰‹æœºå·æ˜¯å¦ä¸ºç©º
			if (!phoneNumber.value) {
				uni.showToast({
					title: 'è¯·è¾“å…¥æ‰‹æœºå·',
					icon: 'none'
				})
				return false
			}
			// æ ¡éªŒæ‰‹æœºå·æ ¼å¼
			const phoneRegex = /^1[3-9]\d{9}$/
			if (!phoneRegex.test(phoneNumber.value)) {
				uni.showToast({
					title: 'è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·æ ¼å¼',
					icon: 'none'
				})
				return false
			}
		}
		return true
	}

	// ä¸‹ä¸€æ­¥
	const handleNext = async (captchaVerifyParam: string = '') => {
		// æ ¡éªŒç™»å½•å‚æ•°
		if (!validateLoginParams()) {
			return
		}

		const params = {
			type: "LOGIN_OR_REGISTER",
			captchaVerifyParam,
			// "phone": phoneNumber.value
		}

		if(isEmailAuth.value){
			params.email = emailNumber.value
		}else{
			params.phone = phoneNumber.value
		}

		const phoneOrEmail = isEmailAuth.value ? emailNumber.value : phoneNumber.value
		// å‘é€éªŒè¯ç 
		try{
			loading.value = true
			const { code, data, message } = await apiSendCode(params)
			// æ‰‹æœºéªŒè¯ç 
			if (code === SUCCESS_CODE) {
				// ç³»ç»Ÿæœªé…ç½®é‚®ä»¶æœåŠ¡ï¼Œè¯·ç›´æ¥è¾“å‡ºæœ¬æ¬¡éªŒè¯ç ï¼š779895
				uni.showToast({
					title: 'éªŒè¯ç å‘é€æˆåŠŸ',
					icon: 'none'
				})
				emit('show-verify', phoneOrEmail, captchaVerifyParam)
				return
			}

			// é‚®ç®±éªŒè¯ç 
			if (isEmailAuth.value && code=== AGENT_NOT_EXIST) {
			  uni.showToast({
			    title: message,
			    icon: 'none',
			    duration: 5000
			  })
			  emit('show-verify', phoneOrEmail, captchaVerifyParam)
			  return
			}
		}finally{
			loading.value = false
		}
		
	}

	// æ‰‹æœºå·ç™»å½•
	const handleLoginByPhone = async (captchaVerifyParam: string = '') => {
		// æ ¡éªŒç™»å½•å‚æ•°
		if (!validateLoginParams()) {
			return
		}

		if (!password.value) {
			uni.showToast({
				title: 'è¯·è¾“å…¥å¯†ç ',
				icon: 'none'
			})
			return
		}

		// æ‰§è¡Œç™»å½•é€»è¾‘
		const params : LoginFieldType = {
			phoneOrEmail: phoneNumber.value,
			areaCode: "86",
			password: password.value,
			captchaVerifyParam
		}
		try {
			loading.value = true
			const result = await apiLogin(params)
			handleLoginSuccess(result)
		} finally {
			loading.value = false
		}
	}



	// é‚®ç®±ç™»å½•
	const handleLoginByEmail = async (captchaVerifyParam: string = '') => {
		// æ ¡éªŒç™»å½•å‚æ•°
		if (!validateLoginParams()) {
			return
		}

		if (!password.value) {
			uni.showToast({
				title: 'è¯·è¾“å…¥å¯†ç ',
				icon: 'none'
			})
			return
		}

		// æ‰§è¡Œç™»å½•é€»è¾‘
		const params : LoginFieldType = {
			phoneOrEmail: emailNumber.value,
			areaCode: "",
			password: password.value,
			captchaVerifyParam
		}

		const { code, data, message } = await apiLogin(params)
		if (code === SUCCESS_CODE) {
			uni.showToast({
				title: 'ç™»å½•æˆåŠŸ',
				icon: 'success'
			})
			setTimeout(() => {
				uni.setStorageSync(ACCESS_TOKEN, data.token)
				uni.reLaunch({
					url: '/pages/home/home'
				})
			}, 1000);
		} else if (code === AGENT_NOT_EXIST) {
			uni.showToast({
				title: message,
				icon: 'none'
			})
		}
	}

	// ç™»å½•æˆåŠŸå
	const handleLoginSuccess = (result : ILoginResult) => {
		const { code, data, message } = result
		if (code === SUCCESS_CODE) {
			uni.showToast({
				title: 'ç™»å½•æˆåŠŸ',
				icon: 'success'
			})
			setTimeout(() => {
				uni.setStorageSync(ACCESS_TOKEN, data.token)
				uni.reLaunch({
					url: '/pages/home/home'
				})
			}, 1000);
		} else if (code === AGENT_NOT_EXIST) {
			uni.showToast({
				title: message,
				icon: 'none'
			})
		}
	}

	const handleAgreeChange = (e : any) => {
		agreeTerms.value = e.detail.value.includes('agree')
	}

	const handleServiceAgreement = () => {
		handleExternalLink('https://nuwax.com/user-agreement.html')	
	}

	const handlePrivacyAgreement = () => {
		handleExternalLink('https://nuwax.com/privacy.html')
	}

	const clearPhoneNumber = () => {
		phoneNumber.value = ''
	}

	const clearEmailNumber = () => {
		emailNumber.value = ''
	}

	const clearPassword = () => {
		password.value = ''
	}

	const togglePasswordVisibility = () => {
		showPassword.value = !showPassword.value
	}

</script>

<style lang="scss" scoped>
	.container {

		.login-segmented {
			margin-bottom: 80rpx;
		}

		.sub-title-wrapper {
			margin-bottom: 48rpx;

			.sub-title {
				color: #000;
				text-align: center;
				font-size: 40rpx;
				font-style: normal;
				font-weight: 600;
				line-height: 56rpx;
			}
		}



		.clear-btn {
			position: absolute;
			right: 32rpx;
			top: 50%;
			transform: translateY(-50%);
			cursor: pointer;

			.clear-icon {
				color: #b2b4b8;
				font-size: 32rpx;
			}
		}

		.phone-input-wrapper {
			display: flex;
			flex-direction: row;
			align-items: center;
			background: rgba(12, 20, 102, 0.04);

			border-radius: 16rpx;
			padding: 24rpx 32rpx;
			margin-bottom: 36rpx;
			position: relative;
			border: 2rpx solid transparent;
			transition: border-color 0.3s ease;

			&:focus-within {
				border-color: #5147FF;
			}

			.country-code {

				color: rgba(21, 23, 31, 1);
				margin-right: 24rpx;
				border-right: 2rpx solid rgba(12, 20, 102, 0.12);
				padding-right: 24rpx;

				display: flex;
				flex-direction: row;
				justify-content: center;
				align-items: center;

				text {
					margin-left: 10rpx;
					font-size: 32rpx;
					font-weight: 400;
					line-height: 48rpx;
				}

				.iconfont {
					font-size: 32rpx;
				}
			}

			.phone-input {
				flex: 1;
				background: transparent;

				border: none;
				outline: none;
				font-size: 32rpx;
				color: #15171f;
				font-weight: 400;
				line-height: 48rpx;
				padding-right: 60rpx;
				caret-color: #5147FF;
				cursor-color: #5147FF;
			}
		}

		.password-input-wrapper {
			background: rgba(12, 20, 102, 0.04);
			border-radius: 16rpx;
			padding: 24rpx 32rpx;
			margin-bottom: 36rpx;
			position: relative;
			border: 2rpx solid transparent;
			transition: border-color 0.3s ease;

			&:focus-within {
				border-color: #5147FF;
			}

			.password-input {
				width: 100%;
				background: transparent;
				border: none;
				outline: none;
				font-size: 32rpx;
				color: #15171f;
				font-weight: 400;
				line-height: 48rpx;
				padding-right: 60rpx;
				caret-color: #5147FF;
				cursor-color: #5147FF;
			}

			.eye-btn {
				position: absolute;
				right: 80rpx;
				top: 50%;
				transform: translateY(-50%);
				cursor: pointer;

				.eye-icon {
					font-size: 32rpx;
					color: #b2b4b8;
				}
			}
		}

		.login-btn {
			margin-top: 20rpx;
			width: 100%;
			border-radius: 16rpx;
			padding: 25rpx 24rpx;
			font-size: 32rpx;
			font-weight: 400;
			margin-bottom: 32rpx;
			line-height: 48rpx;
			text-align: center;
			background: #5147ff;
			color: #ffffff;
			display: flex;
			flex-direction: row;
			align-items: center;
			justify-content: center;
		}

		.agreement {
			display: flex;
			flex-direction: row;
			align-items: center;
			flex-wrap: wrap;

			.checkbox-group {}

			.checkbox-label {
				display: flex;
				flex-direction: row;
				align-items: center;
				justify-content: center;
				flex-wrap: wrap;
			}

			.checkbox {}

			.agreement-text {
				font-size: 28rpx;
				line-height: 44rpx;
				font-weight: 400;
				color: rgba(21, 23, 31, 0.5);
			}

			.link {
				font-size: 28rpx;
				font-weight: 600;
				color: rgba(21, 23, 31, 0.5);
				text-decoration: underline;
				text-underline-offset: 5rpx;

			}
		}

		.captcha-button {
			position: absolute;
			left: 10px;
			top: 10px;
			visibility: hidden;
			opacity: 0;
		}
	}
</style>