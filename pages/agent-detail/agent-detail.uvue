<template>
	<view class="agent-detail-container">
		<!-- 导航栏 -->
		<custom-nav-bar :title="agentInfo?.name" show-back :icon="agentInfo?.icon">
			<template v-slot:right>
				<view class="right-buttons">
					<uni-icons class="iconfont icon-More" size="50rpx" @tap="handleMorePopup"></uni-icons>
					<uni-icons class="iconfont icon-message-add" size="50rpx" @tap="createNewConversation"></uni-icons>
				</view> 
			</template>
		</custom-nav-bar>
		
		<view class="chat-container">
			<!-- 聊天内容 -->
			<view class="scroll-view-box">
				<scroll-view 
					direction="vertical"
					class="msg-list" 
					:scroll-into-view="scrollIntoView"
					id="msg-list"
					:scroll-with-animation="scrollWithAnimation"
					@scroll="onScroll"
					@touchstart="scrollTouch = true"
					@touchend="scrollTouch = false"
				>
					<template v-for="item in messageList" :key="item.id">
						<uni-ai-x-msg 
							v-if="item.messageType === MessageTypeEnum.ASSISTANT" 
							:msg="convertMessageInfoToMsgItem(item)" 
							@longpress="onlongTapMsg(convertMessageInfoToMsgItem(item))" 
							@changeThinkContent="changeThinkContent" 
							:id="'msg-item-' + item.id"
							:ref="(el) => setMessageRef(el, item.id)"
						></uni-ai-x-msg>
						<text v-else class="user-msg" @longpress="onlongTapMsg(convertMessageInfoToMsgItem(item))">{{item.text}}</text>
					</template>
					
					<!-- 空状态内容 -->
					<view class="content" v-if="messageList?.length == 0">
						<view class="title-section">
							<text class="subtitle">{{agentInfo?.description}}</text>
						</view>
						<button-wrapper :buttons="agentInfo?.openingGuidQuestions || []" @button-click="handleButtonClick" />
					</view>
					
					<!-- 滚动到底部的锚点 -->
					<view style="height: 35px;" id="last-msg"></view>
				</scroll-view>
				
				<!-- 滚动到底部按钮 -->
				<view :style="{visibility: scrollInBottom || scrolling ? 'hidden' : 'visible'}" class="scroll-to-bottom" @click="scrollToLastMsg(true)">
					<uni-icons type="down" size="20" color="#555"></uni-icons>
				</view>
			</view>
			
			<!-- 输入框 -->
			<chat-input-phone
				:manual-components="agentInfo?.manualComponents || []"
				:default-selected-components="selectedComponents"
				@onSendMessage="handleSendMessage"
			/>
		</view>
		
		<more-popup ref="refMorePopup" :agent-info="agentInfo" @collect="handleCollect"/>
	</view>
</template>

<script setup lang="uts">
	// ==================== 导入模块 ====================
	// 分层架构
	import AgentDetailData from '@/pages/agent-detail/layers/AgentDetailData.uts'
	import AgentDetailService from '@/pages/agent-detail/layers/AgentDetailService.uts'
	import ComponentManager from '@/pages/agent-detail/layers/ComponentManager.uts'
	import ScrollManager from '@/pages/agent-detail/layers/ScrollManager.uts'
	
	// 类型定义
	import { MessageTypeEnum } from '@/types/enums/agent'
	import { apiAgentConversation } from '@/servers/conversation'
	import { SUCCESS_CODE } from '@/constants/codes.constants'
	
	// 组件
	import MorePopup from '@/pages/agent-detail/components/more-popup/more-popup.uvue'
	import ChatInputPhone from '@/components/chat-input-phone/chat-input-phone.uvue'

	// 常量
	import { CONVERSATION_PAYLOAD } from '@/constants/common.constants'
	
	// ==================== 初始化分层架构 ====================
	// 创建各层实例
	const data = new AgentDetailData()
	const service = new AgentDetailService(data)
	const componentManager = new ComponentManager(data)
	const scrollManager = new ScrollManager(data)

	// ==================== 暴露方法给模板 ====================
	
	// 数据层
	const {
		agentId, agentName, agentInfo, conversationId,
		messageList, chatSuggestList, requestId, messageIdRef,
		conversationInfo, isSuggest, manualComponents, selectedComponents, variables,
		userFillVariables, requiredNameList, processingList,
		scrollIntoView, scrollInBottom, scrollWithAnimation,
		scrollTouch, scrolling, keyboardHeight, refMorePopup
	} = data

	// 服务层 - 使用箭头函数保持this上下文
	const handleQueryConversation = (...args: any[]) => service.handleQueryConversation(...args)
	const handleChangeMessageList = (...args: any[]) => service.handleChangeMessageList(...args)
	const handleConversation = (...args: any[]) => service.handleConversation(...args)
	const handleSendMessage = (...args: any[]) => service.handleSendMessage(...args)
	const createNewConversation = (...args: any[]) => service.createNewConversation(...args)
	const getPublishedAgentInfo = (...args: any[]) => service.getPublishedAgentInfo(...args)
	const handleCollect = (...args: any[]) => service.handleCollect(...args)
	
	// 其他服务方法包装
	const initParseMarkdown = () => service.initParseMarkdown()

	// 组件管理层 - 使用箭头函数保持this上下文
	const setMessageRef = (...args: any[]) => componentManager.setMessageRef(...args)
	const removeMessageRef = (...args: any[]) => componentManager.removeMessageRef(...args)
	const updateMessageComponent = (...args: any[]) => componentManager.updateMessageComponent(...args)
	const convertMessageInfoToMsgItem = (...args: any[]) => componentManager.convertMessageInfoToMsgItem(...args)

	// 滚动管理层 - 使用箭头函数保持this上下文
	const scrollToLastMsg = (...args: any[]) => scrollManager.scrollToLastMsg(...args)
	const setIsInScrollBottom = (...args: any[]) => scrollManager.setIsInScrollBottom(...args)
	const lockAutoToLastMsg = (...args: any[]) => scrollManager.lockAutoToLastMsg(...args)
	const onScroll = (...args: any[]) => scrollManager.onScroll(...args)

	// ==================== 视图层方法 (原ViewManager逻辑) ====================
	/**
	 * 处理更多弹窗
	 */
	const handleMorePopup = (): void => {
		if (data.refMorePopup.value) {
			nextTick(() => {
				data.refMorePopup.value?.open()
			})
		}
	}

	/**
	 * 处理功能按钮点击
	 */
	const handleButtonClick = (buttonText: string): void => {
		uni.showToast({
			title: `点击了${buttonText}`,
			icon: 'none'
		})
	}

	/**
	 * 长按消息处理
	 */
	const onlongTapMsg = (item: any): void => {
		// 显示操作菜单
	}

	/**
	 * 选择消息处理
	 */
	const onSelectMsg = (item: any): void => {
		// 选择消息逻辑
	}

	/**
	 * 修改消息处理
	 */
	const onEditMsg = (item: any): void => {
		// 修改消息逻辑
	}

	/**
	 * 思考内容变化处理
	 */
	const changeThinkContent = (hideThinkContent: boolean): void => {
		setIsInScrollBottom()
	}

	/**
	 * 键盘高度变化处理
	 */
	const onKeyboardheightchange = (res: UniInputKeyboardHeightChangeEvent): void => {
		data.keyboardHeight.value = res.detail.height
	}

	// ==================== 设置监听器 ====================
	// 滚动相关监听器
	watch(data.scrollInBottom, () => {
		// 可以在这里添加渲染控制逻辑
	}, { immediate: true })
	
	watch(data.scrolling, () => {
		// 可以在这里添加渲染控制逻辑
	}, { immediate: true })
	
	watch(computed(() => data.conversationId.value?.toString() || ''), () => {
		scrollToLastMsg(false)
		nextTick(() => {
			if (data.messageList.value.length > 0) {
				const lastMessage = data.messageList.value[data.messageList.value.length - 1]
				// 这里可以添加渲染标记逻辑
			}
		})
	}, { deep: true, immediate: true })
	
	watch(data.messageList, async () => {
		setIsInScrollBottom()
		lockAutoToLastMsg()
		if (!data.scrollTouch.value && data.autoToLastMsg) {
			await nextTick()
			scrollToLastMsg(false)
		}
	}, { deep: true })

	// ==================== 计算属性 ====================
	const state = computed<string>(() => 'none')
	const chatInputContent = ref<string>('')
	const chatActiveId = computed<string>(() => data.conversationId.value?.toString() || '')
	const chatTitle = computed<string>(() => data.agentName.value || '新对话')

	// ==================== 页面加载处理 ====================
	/**
	 * 处理页面加载
	 */
	const handlePageLoad = async (params): Promise<void> => {
		// 智能体id
		data.agentId.value = params.id ? Number(params.id) : ''
		// 从缓存中获取payload数据
		const payload = uni.getStorageSync(CONVERSATION_PAYLOAD)
		const payloadData = payload ? JSON.parse(payload) : {}
		// 消息信息
		const messageInfo = payloadData.messageInfo || ''
		// 文件信息
		const files = payloadData.files || []
		// 组件列表
		const _selectedComponents = payloadData.selectedComponents || []
		data.selectedComponents.value = _selectedComponents

		initParseMarkdown()
    // 如果存在会话id，则初始化ParseMarkdown，查询历史会话信息
		if (params.conversationId) {
			const id = Number(params.conversationId)
			data.conversationId.value = id
			// 查询历史会话信息
			const res = await apiAgentConversation(id)
			if (res.code === SUCCESS_CODE) {
				// 处理消息列表
				handleQueryConversation(res)
			}
			// 查询智能体详情信息
			getPublishedAgentInfo()
		} else {
			// 查询智能体详情信息，并初始化会话id
			getPublishedAgentInfo(true, {
				messageInfo,
				files,
				selectedComponents: _selectedComponents
			})
		}
	}

	// ==================== 生命周期 ====================
	onLoad(async (params) => {
		await handlePageLoad(params)
	})

	// 设置事件监听器
	onMounted(() => {
		uni.$on('updateMessageComponent', (eventData: any) => {
			updateMessageComponent(eventData.messageId, eventData.data)
		})
	})
	
	// 清理事件监听器
	onUnmounted(() => {
		uni.$off('updateMessageComponent')
		uni.removeStorageSync(CONVERSATION_PAYLOAD)
	})
</script>

<style lang="scss" scoped>
	@import './styles/agent-detail.scss';
</style>