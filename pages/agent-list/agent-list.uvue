<template>
  <view class='container'>
    <!-- 导航栏 -->
		<custom-nav-bar title="智能体" show-menu>
      	<template v-slot:right>
          <uni-icons class="iconfont icon-Search" size="48rpx" @click="handleSearch"></uni-icons>
        </template>
    </custom-nav-bar>


    <!-- 分类导航 -->
    <view class='category-nav'>
      <scroll-view 
        class='category-scroll'
        direction="horizontal"
        :scroll-with-animation="true"
        :scroll-into-view="scrollIntoView"
        :show-scrollbar="false"
      >
        <view
          :id="category.key"
          v-for="(category, index) in categories" 
          :key="category.key"
          :class="`category-item ${activeCategory === category.key ? 'active' : ''}`"
          @click="handleCategoryClick(category.key, index)"
        >
          <text class='category-text'>{{ category.label }}</text>
        </view>
      </scroll-view>
    </view>

    <!-- 推广横幅 -->
    <view class='banner'>
      <view class='banner-content'>
        <text class='banner-title'>人人都是智能设计师</text>
        <text class='banner-desc'>
          新一代AI应用设计、开发、实践平台,无需代码,轻松创建,适合各类人群,支持多种端发布及API
        </text>
      </view>
    </view>

    <!-- 滚动部分 -->
    <view class='scroll-section'>
      <swiper 
        class='agent-swiper'
        :current="activeSwiperIndex"
        @change="handleSwiperChange"
        :indicator-dots="false"
      >
          <template v-for="category in categories" :key="category.key">
            <swiper-item class='swiper-item'>
              <scroll-view 
                class='agent-scroll'
                @scrolltolower="handleLoadMore"
                :refresher-enabled="true"
                :refresher-triggered="refreshingMap[category.key] || false"
                @refresherrefresh="handleRefresh"
                :show-scrollbar="false"
              >
                <view class='agent-list-container'>
                  <template v-if="(agentListMap[category.key] || []).length">
                    <template v-for="info in agentListMap[category.key]" :key="info.id">
                       <agent-component
                          :icon="info.icon"
                          :name="info.name"
                          :userName="info.publishUser?.userName"
                          :description="info.description"
                          :userCount="info.statistics?.userCount"
                          :convCount="info.statistics?.convCount"
                          :collectCount="info.statistics?.collectCount"
                          @click="handleAgentClick(info)"
                        />
                    </template>
                  </template>

                  <template v-else-if="!loadingMap[category.key]">
                    <view class='empty-state'>
                      <text class='empty-text'>暂无数据</text>
                    </view>
                  </template>

                  <template v-else>
                    <view class='loading-state'>
                      <text class='loading-text'>加载中...</text>
                    </view>
                  </template>
                 
                 <template v-if="!loadingMap[category.key] && !hasMoreMap[category.key] && (agentListMap[category.key] || []).length">
                   <view class='no-more-state'>
                     <text class='no-more-text'>没有更多数据了</text>
                   </view>
                 </template>
              </view>
            </scroll-view>
          </swiper-item>
        </template>
      </swiper>
    </view>
  </view>
</template>

<script setup lang="uts">
  import { CONST_ALL } from '@/constants/common.constants'
  import { SquarePublishedItemInfo } from '@/types/interfaces/square'
  import { apiPublishedCategoryList } from '@/servers/square'
  import { SUCCESS_CODE } from '@/constants/codes.constants'
  import { SquareCategoryInfo } from '@/types/interfaces/square'
  import { SquareAgentTypeEnum } from '@/types/enums/square'
  import { AgentComponentTypeEnum } from '@/types/enums/agent'
  import { apiPublishedAgentList } from '@/servers/square'
  import { SquarePublishedListParams } from '@/types/interfaces/square'
  import { Page } from '@/types/interfaces/request'
  import { RequestResponse } from '@/types/interfaces/request'
  import AgentComponent from '@/components/agent-component/agent-component.uvue'

  // 当前分类
  const activeCategory = ref<string>(CONST_ALL)
  // 当前swiper索引
  const activeSwiperIndex = ref<number>(0)
  // 分类列表
  const categories = ref<{ key: string, label: string, active: boolean }[]>([])
  // 智能体列表
  const agentListMap = ref<{ [key: string]: SquarePublishedItemInfo[] }>({})
  // 加载状态
  const loadingMap = ref<{ [key: string]: boolean }>({})
  // 刷新状态
  const refreshingMap = ref<{ [key: string]: boolean }>({})
  // 页码
  const pageMap = ref<{ [key: string]: number }>({})
  // 是否还有更多
  const hasMoreMap = ref<{ [key: string]: boolean }>({})
  // 搜索关键词
  const searchKeyword = ref<string>('');
  // 滚动到对应的分类标签
  const scrollIntoView = ref<string>('')
  // 搜索定时器
  const searchTimeoutRef = ref<number | null>(null)

  // 获取分类列表
  const fetchCategories = async () => {
    const response = await apiPublishedCategoryList()
    const { code, data } = response as unknown as RequestResponse<SquareCategoryInfo[]>
    if (code === SUCCESS_CODE) {
      // 获取智能体分类列表
      const agentCategoryList = data.find((item: SquareCategoryInfo) => item.type === SquareAgentTypeEnum.Agent)?.children || [];
      // 转换为分类列表
      const categoryData = agentCategoryList.map((item: SquareCategoryInfo) => ({
        key: item.key,
        label: item.label,
        active: false,
      }))
      categories.value = [{ key: CONST_ALL, label: '全部', active: true }, ...categoryData]
    } else {
      uni.showToast({
        title: '获取分类信息失败',
        icon: 'error'
      })
    }
  }

  // 获取智能体列表
  const fetchAgentList = async (category: string = CONST_ALL, pageNum: number = 1, keyword: string = searchKeyword.value) => {
    if (loadingMap[category]) return
    // 设置加载状态
    loadingMap.value = { ...loadingMap.value, [category]: true }
    const params: SquarePublishedListParams = {
      targetType: AgentComponentTypeEnum.Agent,
      page: pageNum,
      pageSize: 10,
      category: category === CONST_ALL ? '' : category,
      kw: keyword,
    }
    // 获取智能体列表
    const response  = await apiPublishedAgentList(params)
    const {code, data, message}  = response as unknown as RequestResponse<Page<SquarePublishedItemInfo>>
    // 成功
    if (code === SUCCESS_CODE) {
      const newList = data.records || []
      if (pageNum > 1) {
        agentListMap.value = { ...agentListMap.value, [category]: [...(agentListMap.value[category] || []), ...newList] }
      } else {
        agentListMap.value = { ...agentListMap.value, [category]: newList }
      }
      hasMoreMap.value = { ...hasMoreMap.value, [category]: data.pages > pageNum }
      pageMap.value = { ...pageMap.value, [category]: pageNum }
    } else {
      uni.showToast({
        title: message || '获取智能体列表失败',
        icon: 'error'
      })
    }
    loadingMap.value = { ...loadingMap.value, [category]: false }
  }

  onLoad(() => {
    // 获取分类列表
    fetchCategories()
    // 预加载第一个分类的数据
    fetchAgentList()
  })

  onUnload(() => {
    if (searchTimeoutRef.value) {
      clearTimeout(searchTimeoutRef.value)
    }
  })

  // 点击菜单按钮 todo
  const handleMenuClick = () => {
    uni.navigateTo({
      url: '/pages/home/home'
    })
  }

  // 点击智能体分类标签
  const handleCategoryClick = (key: string, index: number) => {
    // 当前分类
    activeCategory.value = key
    // 当前swiper索引
    activeSwiperIndex.value = index
    // 滚动到对应的分类标签
    scrollIntoView.value = key;
    
    // 如果该分类还没有数据，则加载数据
    if (!agentListMap[key] || agentListMap[key].length === 0) {
      pageMap.value = { ...pageMap.value, [key]: 1 }
      hasMoreMap.value = { ...hasMoreMap.value, [key]: true }
      fetchAgentList(key)
    }
  }

    // 处理Swiper切换
    const handleSwiperChange = (e: UniSwiperChangeEvent) => {
    const index = e.detail.current
    const category = categories.value[index]
    if (category && category.key !== activeCategory.value) {
      // 当前分类
      activeCategory.value = category.key
      // 当前swiper索引
      activeSwiperIndex.value = index

      // 滚动到对应的分类标签
      const id = categories.value[index].key
      scrollIntoView.value = id;

      // 如果该分类还没有数据，则加载数据
      if (!agentListMap[category.key] || agentListMap[category.key].length === 0) {
        pageMap.value = { ...pageMap.value, [category.key]: 1 }
        hasMoreMap.value = { ...hasMoreMap.value, [category.key]: true }
        fetchAgentList(category.key)
      }
    }
  }

   // 处理搜索
   const handleSearch = () => {
    uni.navigateTo({
      url: `/pages/agent-search/agent-search`
    })
  }

  // 跳转到智能体详情页
  const handleAgentClick = (agent: SquarePublishedItemInfo) => {
    uni.navigateTo({
      url: `/pages/agent-detail/agent-detail?id=${agent.id}&name=${agent.name}`
    })
  }

  // 下拉刷新
  const handleRefresh = () => {
    if (refreshingMap.value[activeCategory.value]) {
      return
    }
    refreshingMap.value = { ...refreshingMap.value, [activeCategory.value]: true }
    pageMap.value = { ...pageMap.value, [activeCategory.value]: 1 }
    hasMoreMap.value = { ...hasMoreMap.value, [activeCategory.value]: true }
    fetchAgentList(activeCategory.value).finally(() => {
      refreshingMap.value = { ...refreshingMap.value, [activeCategory.value]: false }
    })
  }

  // 加载更多
  const handleLoadMore = () => {
    const currentPage = pageMap.value[activeCategory.value] || 1
    const currentHasMore = hasMoreMap.value[activeCategory.value] !== false
    const currentLoading = loadingMap.value[activeCategory.value]
    
    if (currentHasMore && !currentLoading) {
      fetchAgentList(activeCategory.value, currentPage + 1)
    }
  }
</script>

<style lang="scss" scoped>
	.container {
		height: 100vh;
		display: flex;
		flex-direction: column;
		overflow: hidden;
		background-color: #fff;
		/* #ifdef MP-WEIXIN */
		padding-top: env(safe-area-inset-top);
		padding-bottom: env(safe-area-inset-bottom);
		/* #endif */

    
    .category-nav {
      padding: 0 32rpx;
    
      /* 分类导航 */
      .category-scroll {
        white-space: nowrap;
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
        height: 112rpx;
        display: flex;
        align-items: center;
        flex-direction: row;
      }

      .category-item {
        display: flex;
        justify-content: center;
        height: 80rpx;
        padding: 0 32rpx;
        border-radius: 16rpx;
        cursor: pointer;
        transition: all 0.3s ease;
        user-select: none;
        color: #5E6470;
        font-size: 32rpx;
        font-weight: 400;
      
        &.active {
          background-color: #F2F2FF;
      
          .category-text {
            color: #5147FF;
          }
        }
      
        .category-text {
          font-size: 32rpx;
          font-weight: 400;
          color: #5E6470;
          transition: color 0.3s ease;
        }
      }
    }
    
    /* 推广横幅 */
    .banner {
      margin: 32rpx;
      border-radius: 24rpx;
      overflow: hidden;
      background: linear-gradient(135deg, #8b5cf6 0%, #f97316 100%);
      box-shadow: 0 4rpx 12rpx rgba(139, 92, 246, 0.3);
      flex-shrink: 0;
    
      .banner-content {
        padding: 40rpx;
        color: #fff;
      }
    
      .banner-title {
        display: block;
        font-size: 36rpx;
        font-weight: 600;
        margin-bottom: 16rpx;
        line-height: 1.4;
      }
    
      .banner-desc {
        display: block;
        font-size: 26rpx;
        line-height: 1.5;
        opacity: 0.9;
      }
    }
    
    /* 滚动部分 */
    .scroll-section {
      flex: 1;
      overflow: hidden;
    
      /* 智能体列表 */
      .agent-swiper {
        height: 100%;
      }
    
      .swiper-item {
        height: 100%;
        overflow: hidden;
      }
    
      .agent-scroll {
        height: 100%;
      }
    
      .agent-list-container {
        padding: 0 16rpx;
      }
    }
    
    /* 空状态 */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 160rpx 40rpx;
      text-align: center;
    }
    
    .empty-text {
      font-size: 28rpx;
      color: #999;
      margin-top: 32rpx;
    }
    
    /* 加载状态 */
    .loading-state {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40rpx;
    }
    
    .loading-text {
      font-size: 28rpx;
      color: #666;
      display: flex;
      align-items: center;
    }
    
    .loading-text::before {
      content: '';
      width: 32rpx;
      height: 32rpx;
      border: 4rpx solid #e8e8e8;
      border-top: 4rpx solid #8b5cf6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 16rpx;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* 没有更多数据状态 */
    .no-more-state {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40rpx;
    }
    
    .no-more-text {
      font-size: 24rpx;
      color: #999;
    }
	}
</style>
